<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√∂rbuch Studio Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Enable class-based dark mode in Tailwind
      tailwind.config = {
        darkMode: 'class',
      }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&family=Merriweather:wght@400;700&family=Fira+Code&family=Lato:wght@400;700&display=swap" rel="stylesheet">

        <!-- Worker base URL (konfigurierbar) -->
        <script>
            // Trage hier nach Deployment deine Worker-URL ein, z.B. "https://mein-hhb-worker.workers.dev"
            // Wenn die Variable leer oder der Default-Platzhalter verwendet wird, greifen API-Aufrufe
            // weiterhin auf relative Pfade wie `/api/‚Ä¶` zur√ºck (lokale Node-Server-Fallback).
            window.HHB_WORKER_BASE_URL = window.HHB_WORKER_BASE_URL || "https://your-worker.workers.dev";

            // Helper: konstruiert den vollst√§ndigen API-Pfad. Gibt bei leerer Base-URL nur den Pfad zur√ºck.
            window.hhbApiUrl = function(path) {
                try {
                    const base = (window.HHB_WORKER_BASE_URL && window.HHB_WORKER_BASE_URL.length && !window.HHB_WORKER_BASE_URL.includes('your-worker')) ? window.HHB_WORKER_BASE_URL.replace(/\/+$/, '') : '';
                    return (base ? base : '') + path;
                } catch (e) {
                    return path;
                }
            };
        </script>

        <!-- SortableJS for Drag & Drop -->
        <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        /* --- Embedded generator-styles.css --- */
        body {
            font-family: 'Inter', sans-serif;
        }

     /* helper: global exposure of project load/delete functions is applied after
         the functions are defined later in the script. Removed earlier misplaced
         assignments from this stylesheet block. */
        .spinner, .spinner-small {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            animation: spin 1s ease infinite;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border-left-color: #881337;
        }
        .spinner-small {
            width: 20px;
            height: 20px;
            border-width: 2px;
            border-left-color: #881337;
        }
        .dark .spinner, .dark .spinner-small {
            border-left-color: #fecaca;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .glowing-container-active {
            animation: glowing 8s infinite ease-in-out;
        }
        @keyframes glowing {
            0%, 100% { 
                box-shadow: 
                    0 0 30px 8px rgba(136, 19, 55, 0.6),
                    0 0 60px 15px rgba(136, 19, 55, 0.4), 
                    0 20px 25px -5px rgb(0 0 0 / 0.1), 
                    0 8px 10px -6px rgb(0 0 0 / 0.1); 
            }
            50% { 
                box-shadow: 
                    0 0 45px 12px rgba(136, 19, 55, 0.9),
                    0 0 80px 20px rgba(136, 19, 55, 0.7),
                    0 0 120px 30px rgba(136, 19, 55, 0.5), 
                    0 20px 35px -5px rgb(0 0 0 / 0.3), 
                    0 8px 20px -6px rgb(0 0 0 / 0.2);
            }
        }
        .transition-custom {
            transition: all 0.2s ease-in-out;
        }
        @keyframes input-glow {
            0%, 100% { 
                box-shadow: 
                    0 0 8px 2px rgba(225, 29, 72, 0.35),
                    0 0 15px 3px rgba(225, 29, 72, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 18px 4px rgba(225, 29, 72, 0.7),
                    0 0 30px 6px rgba(225, 29, 72, 0.5),
                    0 0 45px 8px rgba(225, 29, 72, 0.3);
            } 
        }
        .input-glowing-active {
            animation: input-glow 6s infinite ease-in-out !important;
            border-width: 2px !important;
            border-style: solid !important;
            border-color: transparent !important;
        }
        /* Verhindere dass Focus das Gl√ºhen stoppt */
        select:focus, textarea:focus, input:focus {
            outline: none;
        }
        select:focus.input-glowing-active, 
        textarea:focus.input-glowing-active, 
        input:focus.input-glowing-active,
        div.input-glowing-active {
            animation: input-glow 6s infinite ease-in-out !important;
            border-color: rgba(225, 29, 72, 0.6) !important;
        }
        .feedback-message {
            transition: opacity 0.5s ease-in-out;
        }

        /* --- Styles f√ºr den Skript-Editor --- */
        .script-editor-container {
            position: relative;
            font-family: 'Roboto Mono', monospace;
            line-height: 1.5;
            min-height: 24rem;
            resize: vertical;
            overflow: auto;
        }
        .script-editor-container textarea,
        .script-editor-container .highlight-layer {
            font: inherit;
            letter-spacing: inherit;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            border: none;
            background: transparent;
        }
        /* Improve text rendering and avoid duplicate / ghosted text in dark mode
           The highlight-layer contains markup for syntax highlighting; by
           default its plain text should be transparent so only highlighted
           spans are visible. The textarea sits above and provides caret & input.
        */
        .script-editor-container .highlight-layer {
            color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .script-editor-container textarea {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            color: #0f172a; /* default dark text for light mode */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark .script-editor-container textarea {
            color: #ffffff; /* ensure white text in dark mode */
        }
        .script-editor-container textarea {
            position: absolute;
            top: 0;
            left: 0;
        }
        .dark .script-editor-container textarea {
            caret-color: white;
        }
        .script-editor-container .highlight-layer {
            position: relative;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .speaker-ok {
            background-color: rgba(74, 222, 128, 0.2);
            border-radius: 3px;
        }
        .speaker-unknown {
            background-color: rgba(248, 113, 113, 0.3);
            border-radius: 3px;
        }

        /* --- Styles for Drag & Drop --- */
        .drag-handle {
            cursor: grab;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #e0f2fe;
        }
        .dark .sortable-ghost {
            background: #0c4a6e;
        }
        .sortable-chosen {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* --- Styles for Collapsible Sections --- */
        .section-header {
            cursor: pointer;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chevron-icon {
            transition: transform 0.3s ease-in-out;
            display: inline-block;
            transform-origin: center;
            /* Default: point right when section is collapsed. We'll use the
               header's aria-expanded attribute to rotate the icon to point down
               when expanded. */
            transform: rotate(-90deg);
        }
        /* When the header is expanded, show chevron pointing down */
        .section-header[aria-expanded="true"] .chevron-icon {
            transform: rotate(0deg);
        }
        .section-content {
            display: grid;
            grid-template-rows: 1fr;
            transition: grid-template-rows 0.3s ease-in-out;
            overflow: hidden;
        }
        /* Avoid visual overlap with native select dropdowns and other floating UI
           elements: keep section content clipped by default to prevent the
           API dropdown appearing visually inside the language section when
           sections collapse/expand. To preserve visual glow effects and
           ensure the active section sits above neighbors we use positioning
           and z-index on expanded sections instead of overflow:visible. */
        /* Allow visible overflow for language & API sections so animated glows and
           custom select shadows aren't clipped. We keep positioning and stacking
           so expanded sections render above neighbors. Collapsed sections still
           force overflow hidden below. */
        #section-lang .section-content,
        #section-api .section-content {
            overflow: visible; /* allow box-shadow/glow to render outside element */
            position: relative; /* create stacking context */
            z-index: 10; /* bring expanded content above neighbors */
        }

        /* Ensure collapsed sections don't overlap expanded ones and hide their content */
        .section-collapsed .section-content {
            z-index: 0;
            display: none !important; /* hide content when collapsed so custom-selects are not visible */
            overflow: hidden !important;
        }
        
        /* When the global glowing container is active, give these sections
           a little extra inner spacing so the animated box-shadows (glow)
           are visible inside the clipped container. This keeps the glow
           effect top+bottom while still preventing cross-section overflow. */
        /* Remove layout-changing padding when glow is active to avoid scroll jumps.
           The glow is rendered by .glow-layer so we don't need extra padding here. */

        /* Custom accessible select styling (display + list) */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            display: block;
        }
        .custom-select-display {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid var(--tw-border-opacity, rgba(226,232,240,1));
            background: var(--select-bg, white);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .dark .custom-select-display { background: #0f172a; color: #fff; border-color: rgba(63,63,70,0.6); }
        .custom-select-list {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 6px);
            background: var(--select-bg, white);
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.2);
            max-height: 220px;
            overflow: auto;
            /* raise above almost everything to avoid native fallbacks caused by stacking contexts */
            z-index: 99999;
            list-style: none;
            margin: 0;
            padding: 6px 6px;
            display: none;
            transform-origin: top center;
            transition: opacity 180ms ease, transform 180ms ease;
        }
        .custom-select-list.show { display: block; opacity: 1; transform: translateY(0); }
        .custom-select-list { opacity: 0; transform: translateY(-6px); }
        .custom-select-display .chev {
            width: 16px; height: 16px; transition: transform 180ms ease; display: inline-block; flex-shrink:0;
        }
        .custom-select-wrapper.open .custom-select-display .chev { transform: rotate(180deg); }

        /* Glow layer styling */
        .glow-layer {
            position: absolute;
            inset: 0; /* cover the container */
            pointer-events: none;
            z-index: 5; /* under UI (main container content is z-index default 10 in section content) */
            border-radius: inherit;
            transition: opacity 300ms ease;
            opacity: 0; /* toggled via .glowing-container-active on #main-container */
        }
        .glowing-container-active > .glow-layer {
            opacity: 1;
            box-shadow: 0 0 60px 18px rgba(136,19,55,0.14), 0 20px 40px -10px rgba(136,19,55,0.12) inset;
            background: radial-gradient(ellipse at center, rgba(136,19,55,0.06), transparent 40%);
        }

        /* Custom select list (dark theme style for higher contrast) */
        .custom-select-list {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 6px);
            background: #000000; /* pure black */
            color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 12px 40px -8px rgba(0,0,0,0.6), 0 6px 18px rgba(0,0,0,0.45) inset;
            max-height: 220px;
            overflow: auto;
            z-index: 99999;
            list-style: none;
            margin: 0;
            padding: 6px 6px;
            display: none;
            transform-origin: top center;
            transition: opacity 180ms ease, transform 180ms ease;
        }

        .custom-select-list li {
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 120ms ease, transform 120ms ease, color 120ms ease;
            color: #ffffff;
        }
        .custom-select-list li:hover,
        .custom-select-list li[aria-selected="true"] {
            background: rgba(255,255,255,0.06);
            color: #ffffff;
            transform: translateY(-1px);
        }
        .custom-select-list li:focus {
            outline: 2px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.08);
            color: #ffffff;
        }

        /* Tile glow for visual feedback when loading a project */
        .project-tile.tile-glow {
            animation: tile-glow 900ms ease forwards;
            border-color: #7c3aed !important; /* purple accent */
            box-shadow: 0 12px 30px -8px rgba(124,58,237,0.35), 0 8px 18px rgba(124,58,237,0.18) inset;
        }
        @keyframes tile-glow {
            0% { transform: translateY(0); box-shadow: 0 18px 40px -12px rgba(124,58,237,0.6), 0 6px 16px rgba(124,58,237,0.25) inset; }
            60% { transform: translateY(-4px); }
            100% { transform: translateY(0); box-shadow: none; }
        }

        /* In-flow open: when a wrapper requests inflow, show the list as part of layout
           so it pushes subsequent content downward. We animate max-height for smoothness. */
        .custom-select-wrapper.open-inflow .custom-select-list {
            position: relative !important;
            left: auto !important;
            right: auto !important;
            top: auto !important;
            width: 100% !important;
            display: block !important;
            opacity: 1 !important;
            transform: none !important;
            max-height: 480px; /* allow tall lists to show */
            transition: max-height 220ms ease, opacity 180ms ease;
            margin-top: 8px;
        }

        /* --- Button Hover Effects (NEUE EFFEKTE) --- */
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0px);
        }
        
        /* Spezielle Hover-Effekte f√ºr verschiedene Button-Typen */
        .bg-gradient-to-r:hover:not(:disabled) {
            filter: brightness(1.1);
            box-shadow: 0 0 20px rgba(136, 19, 55, 0.5), 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        
        .bg-\[\#881337\]:hover:not(:disabled) {
            box-shadow: 0 0 25px rgba(136, 19, 55, 0.6), 0 10px 30px -5px rgba(0, 0, 0, 0.3);
        }
        
        /* Template Buttons Hover */
        .template-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 20px rgba(136, 19, 55, 0.3);
        }
        
        /* Credit Shop Buttons Hover */
        .buy-package-btn:hover:not(:disabled) {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 30px -5px rgba(0, 0, 0, 0.3);
        }

        /* ===== User-requested minimal UI: hide SSML toolbar and remove editor borders/lines ===== */
        /* Hides the SSML toolbar and its child controls (visual only, non-destructive) */
        #ssml-toolbar, #ssml-toolbar * { display: none !important; }

        /* Remove visible borders, rounded corners and separators from the script editor area */
        .script-editor-container {
            border: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
            background: transparent !important;
        }
        .script-editor-container .highlight-layer,
        .script-editor-container textarea {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        /* Remove the thin separator lines used elsewhere that might look like "lines" */
        .section-content, .script-editor-container, .collapsible-section { border: none !important; }


    </style>
</head>
<body class="bg-slate-100 dark:bg-black">
    <div class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        <div id="main-container" class="relative bg-white dark:bg-slate-950 rounded-2xl shadow-2xl max-w-4xl w-full p-6 sm:p-8">
            <!-- Glow rendering layer: separate from content so shadows can be controlled without overflow conflicts -->
            <div class="glow-layer pointer-events-none" aria-hidden="true"></div>
            
            <div class="absolute top-4 right-4">
                <button id="theme-toggle" type="button" data-tooltip-key="tooltip_theme" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414zM13.536 6.464a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414z"></path></svg>
                </button>
            </div>

            <div class="text-center mb-8">
                <img src="https://cdn.shopify.com/s/files/1/0929/2231/5125/files/Pangea-global_international_ROT_Kopie.png?v=1760109320" 
                     onerror="this.onerror=null; this.src='https://placehold.co/250x60/991b1b/ffffff?text=PANGEA+GLOBAL'; this.style.borderRadius='4px';" 
                     alt="Pangea Global Logo" 
                     class="h-20 sm:h-20 mx-auto mb-4 object-contain">
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 dark:text-white" data-i18n="main_title">H√∂rbuch Studio Pro</h1>
                <p class="mt-1 text-slate-600 dark:text-gray-400" data-i18n="main_subtitle">Erstelle professionelle H√∂rb√ºcher mit mehreren Stimmen.</p>
                
                <!-- Credit-Anzeige -->
                <div class="mt-4 flex items-center justify-center gap-3 flex-wrap">
                    <div class="bg-gradient-to-r from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/30 border-2 border-amber-300 dark:border-amber-700 rounded-full px-6 py-2 flex items-center gap-3">
                        <span class="text-2xl">üíé</span>
                        <div class="text-left">
                            <div class="text-xs text-amber-700 dark:text-amber-300 font-semibold" data-i18n="credit_balance_label">Dein Guthaben</div>
                            <div class="text-lg font-bold text-amber-900 dark:text-amber-100">
                                <span id="credit-balance">0</span> <span class="text-sm font-normal" data-i18n="credit_balance_unit">Zeichen</span>
                            </div>
                        </div>
                    </div>

                            <!-- Snapshot Manager Modal -->
                            <div id="snapshot-manager-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-60 p-4">
                                <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-y-auto p-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Snapshots verwalten</h3>
                                        <button id="snapshot-manager-close" class="text-slate-500 hover:text-slate-700">‚úï</button>
                                    </div>
                                    <div id="snapshot-list" class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                                        <!-- dynamically filled -->
                                    </div>
                                    <div class="mt-4 flex justify-end gap-2">
                                        <button id="snapshot-clear-all" class="px-3 py-1 rounded bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-200">Alle l√∂schen</button>
                                        <button id="snapshot-manager-close-2" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-800">Schlie√üen</button>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Project Import Preview Modal -->
                            <div id="project-import-preview-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-60 p-4">
                                <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-y-auto p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h3 class="text-xl font-bold text-slate-900 dark:text-white">Projekt-Import Vorschau</h3>
                                            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">√úberpr√ºfe die Datei bevor du sie l√§dst. Du kannst den Import abbrechen.</p>
                                        </div>
                                        <button id="project-import-preview-close" class="text-slate-500 hover:text-slate-700 dark:text-gray-300">
                                            ‚úï
                                        </button>
                                    </div>

                                    <div id="project-import-preview-body" class="text-sm text-gray-700 dark:text-gray-300 space-y-3">
                                        <!-- Dynamisch gef√ºllt: Titel, Timestamp, Version, Speaker-Liste, Script-Auszug -->
                                        <div><strong>Titel:</strong> <span id="preview-meta-title">-</span></div>
                                        <div><strong>Version:</strong> <span id="preview-version">-</span></div>
                                        <div><strong>Letzte √Ñnderung:</strong> <span id="preview-timestamp">-</span></div>
                                        <div><strong>Sprecher:</strong> <span id="preview-speakers">-</span></div>
                                        <div><strong>Skript (Vorschau):</strong>
                                            <pre id="preview-script" class="whitespace-pre-wrap bg-slate-50 dark:bg-slate-800 p-3 rounded text-xs max-h-48 overflow-auto"></pre>
                                        </div>
                                    </div>

                                    <div class="mt-4 flex justify-end gap-3">
                                        <button id="project-import-preview-cancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700">Abbrechen</button>
                                        <button id="project-import-preview-confirm" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">Projekt laden</button>
                                    </div>
                                </div>
                            </div>
                    <button id="open-library-btn" class="bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
                        <span class="text-xl">üìÅ</span>
                        <span data-i18n="btn_my_projects">Meine Projekte</span>
                        <span id="project-count-badge" class="bg-white/20 px-2 py-0.5 rounded-full text-xs font-bold">0</span>
                    </button>
                    <button onclick="(typeof openCostCalculatorModal === 'function') && openCostCalculatorModal()" class="bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
                        <span class="text-xl">üìä</span>
                        <span data-i18n="btn_cost_calculator">Kosten planen</span>
                    </button>
                    <button id="buy-credits-btn" class="bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
                        <span class="text-xl">üõí</span>
                        <span data-i18n="btn_buy_credits">Credits kaufen</span>
                    </button>
                    <button id="open-settings-btn" class="bg-gradient-to-r from-slate-500 to-slate-600 hover:from-slate-600 hover:to-slate-700 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
                        <span class="text-xl">‚öôÔ∏è</span>
                        <span data-i18n="btn_settings">Einstellungen</span>
                    </button>
                </div>
            </div>

            <div class="space-y-6">
                <div class="collapsible-section" id="section-lang">
                    <button type="button" class="section-header">
                        <h2 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="lang_title">0.1 Sprache ausw√§hlen</h2>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4">
                            <div>
                                <!-- Custom accessible select: visual component syncs with hidden native select (keeps existing JS compatibility) -->
                                <div class="custom-select-wrapper" data-target="lang-select" data-inflow="true">
                                    <select id="lang-select" class="hidden" aria-label="Sprache ausw√§hlen">
                                        <option value="de">Deutsch</option>
                                        <option value="en">English</option>
                                        <option value="es">Espa√±ol</option>
                                        <option value="zh">‰∏≠Êñá (Chinesisch)</option>
                                        <option value="ja">Êó•Êú¨Ë™û (Japanisch)</option>
                                    </select>
                                    <div class="custom-select-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false"></div>
                                    <ul class="custom-select-list" role="listbox" tabindex="-1" aria-labelledby="lang-select"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section" id="section-api">
                    <button type="button" class="section-header">
                        <h2 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="api_select_title">0. API-Auswahl</h2>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                         <div class="pt-4 space-y-4">
                            <div>
                                <label for="api-select" class="block text-sm font-medium text-slate-700 dark:text-gray-300 mb-2" data-i18n="api_select_label">W√§hle die zu verwendende KI-Plattform:</label>
                                <!-- Custom accessible select for API choice -->
                                <div class="custom-select-wrapper" data-target="api-select" data-inflow="true">
                                    <select id="api-select" class="hidden">
                                        <option value="openai" data-i18n="openai_option" selected>OpenAI ChatGPT</option>
                                        <option value="gemini" data-i18n="gemini_option">Google Gemini</option>
                                        <option value="elevenlabs" data-i18n="elevenlabs_option">ElevenLabs</option>
                                        <option value="polly" data-i18n="polly_option">Amazon Polly</option>
                                    </select>
                                    <div class="custom-select-display" tabindex="0" role="button" aria-haspopup="listbox" aria-expanded="false"></div>
                                    <ul class="custom-select-list" role="listbox" tabindex="-1" aria-labelledby="api-select"></ul>
                                </div>
                                <p id="api-hint" class="mt-2 text-xs text-slate-500 dark:text-gray-400" data-i18n="api_select_hint">Du kannst wechseln, wenn eine Anfrage fehlschl√§gt.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Schnell-Vorlagen Section (NEU!) -->
                <div class="collapsible-section" id="section-templates">
                    <button type="button" class="section-header">
                        <h2 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="templates_title">‚ö° Schnell-Vorlagen</h2>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4">
                            <p class="text-sm text-slate-600 dark:text-gray-400 mb-3" data-i18n="templates_subtitle">Starte schnell mit vorgefertigten Szenarien:</p>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                <button class="template-btn bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900 dark:to-purple-800 border-2 border-purple-200 dark:border-purple-700 text-purple-700 dark:text-purple-200 font-semibold py-3 px-4 rounded-lg hover:shadow-lg transition-all" data-template="fairytale" data-i18n="template_fairytale">
                                    üìö M√§rchen
                                </button>
                                <button class="template-btn bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900 dark:to-blue-800 border-2 border-blue-200 dark:border-blue-700 text-blue-700 dark:text-blue-200 font-semibold py-3 px-4 rounded-lg hover:shadow-lg transition-all" data-template="podcast" data-i18n="template_podcast">
                                    üéôÔ∏è Podcast
                                </button>
                                <button class="template-btn bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900 dark:to-amber-800 border-2 border-amber-200 dark:border-amber-700 text-amber-700 dark:text-amber-200 font-semibold py-3 px-4 rounded-lg hover:shadow-lg transition-all" data-template="novel" data-i18n="template_novel">
                                    üìñ Roman
                                </button>
                                <button class="template-btn bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 border-2 border-green-200 dark:border-green-700 text-green-700 dark:text-green-200 font-semibold py-3 px-4 rounded-lg hover:shadow-lg transition-all" data-template="dialog" data-i18n="template_dialog">
                                    üí¨ Dialog
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
             <div class="collapsible-section" id="section-chars">
                 <button type="button" class="section-header">
                        <div class="flex items-center gap-2">
                            <h2 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="char_title">1. Personen & Stimmen</h2>
                            <span id="speaker-count" class="text-sm bg-rose-100 dark:bg-rose-900 text-rose-700 dark:text-rose-200 px-3 py-1 rounded-full font-bold">0</span>
                        </div>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4 space-y-4">
                            <div id="speakers-container" class="space-y-3"></div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button id="add-speaker-button" data-tooltip-key="tooltip_add_char" class="text-sm bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                    <span data-i18n="add_char_button">Person hinzuf√ºgen</span>
                                </button>
                                <button onclick="(typeof openVoicePreviewModal === 'function') && openVoicePreviewModal()" class="text-sm bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center shadow-md">
                                    <svg class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M18 3a1 1 0 00-1.447-.894L4 6.434V12a1 1 0 001 1h1a1 1 0 001-1V7.566l10-3.434v1.868a1 1 0 002 0V3z"/><path d="M4 14a1 1 0 00-1 1v1a1 1 0 001 1h1a1 1 0 001-1v-1a1 1 0 00-1-1H4z"/></svg>
                                    <span data-i18n="btn_preview_voices">üé≠ Stimmen anh√∂ren</span>
                                </button>
                                <button id="import-speakers-button" data-tooltip-key="tooltip_import" class="text-sm bg-sky-200 dark:bg-sky-800 text-sky-800 dark:text-sky-200 font-semibold py-2 px-4 rounded-lg hover:bg-sky-300 dark:hover:bg-sky-700 transition-colors flex items-center">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                    <span data-i18n="import_from_script_button">Aus Skript importieren</span>
                                </button>
                                <button id="clear-all-speakers-button" data-tooltip-key="tooltip_clear_all" class="text-sm bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 dark:hover:bg-red-800 transition-colors flex items-center">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                    <span data-i18n="clear_all_button">Alle l√∂schen</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

             <div class="collapsible-section" id="section-script">
                 <button type="button" class="section-header">
                        <h2 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="script_title">2. Skript</h2>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4 space-y-2">
                            apiSelect.value = projectData.api;
                            setBookText(projectData.script, 'loadProject');
                
                            <!-- Font selector for script editor -->
                            <div class="mt-2 mb-2 flex items-center gap-3">
                                <label for="script-font-select" class="text-xs text-slate-600 dark:text-gray-400">Schriftart:</label>
                                <select id="script-font-select" class="text-sm border rounded px-2 py-1 bg-white dark:bg-slate-800 dark:text-white">
                                    <option value="'Roboto Mono', monospace">Roboto Mono</option>
                                    <option value="'Inter', system-ui, sans-serif">Inter</option>
                                    <option value="'Fira Code', monospace">Fira Code</option>
                                    <option value="'Merriweather', serif">Merriweather</option>
                                    <option value="'Lato', system-ui, sans-serif">Lato</option>
                                </select>
                                <span id="script-font-sample" class="text-xs text-slate-500 dark:text-slate-400">Vorschau</span>
                            </div>
                            <div class="script-editor-container w-full bg-white dark:bg-slate-950 border-2 border-gray-200 dark:border-rose-700/70 rounded-lg focus-within:border-red-500 dark:focus-within:border-rose-500 transition-custom">
                                <!-- SSML / Prosody Toolbar -->
                                <div id="ssml-toolbar" class="flex items-center gap-2 p-2 border-b border-gray-100 dark:border-rose-800 bg-gray-50 dark:bg-rose-900/30 rounded-t">
                                    <button type="button" id="ssml-insert-break" class="text-xs px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded">Pause (500ms)</button>
                                    <button type="button" id="ssml-wrap-emphasis" class="text-xs px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded">Emphase</button>
                                    <button type="button" id="ssml-wrap-strong" class="text-xs px-2 py-1 bg-slate-200 dark:bg-slate-700 rounded">Stark</button>
                                    <label class="text-xs flex items-center gap-2">
                                        <span class="opacity-80">Rate</span>
                                        <select id="ssml-rate-select" class="text-xs bg-white dark:bg-slate-800 rounded px-2 py-1">
                                            <option value="default">default</option>
                                            <option value="slow">slow</option>
                                            <option value="medium">medium</option>
                                            <option value="fast">fast</option>
                                        </select>
                                    </label>
                                    <button type="button" id="ssml-preview-button" class="ml-auto text-xs px-3 py-1 bg-emerald-200 dark:bg-emerald-700 rounded">Preview SSML</button>
                                    <button type="button" id="script-cleanup-button" class="text-xs px-2 py-1 bg-indigo-200 dark:bg-indigo-700 rounded" title="Doppelte Abs√§tze/Zeilen entfernen">Bereinigen</button>
                                    <button type="button" id="script-cleanup-aggressive-button" class="text-xs px-2 py-1 bg-rose-200 dark:bg-rose-700 rounded" title="Aggressiv bereinigen: entfernt vollst√§ndige Wiederholungen des Skripts">Aggressiv</button>
                                </div>
                                <div id="highlight-layer" class="highlight-layer text-slate-900 dark:text-white"></div>
                                <textarea id="book-text" class="w-full" data-i18n-placeholder="script_placeholder" placeholder="Erz√§hler: Es war einmal in einem weit entfernten Land..."></textarea>
                            </div>
                            <div id="script-stats" class="text-xs text-slate-500 dark:text-gray-400 flex justify-end gap-x-4 gap-y-1 flex-wrap">
                                <span><b data-i18n="stats_words">W√∂rter</b>: <span id="stats-word-count">0</span></span>
                                <span><b data-i18n="stats_chars">Zeichen</b>: <span id="stats-char-count">0</span></span>
                                <span><b data-i18n="stats_duration">Dauer</b>: <span id="stats-duration">~ 00:00</span></span>
                            </div>
                            <!-- Kostenrechner (NEU!) -->
                            <div id="cost-estimate" class="mt-3 p-3 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/30 dark:to-teal-900/30 border-2 border-emerald-200 dark:border-emerald-700 rounded-lg">
                                <div class="text-sm">
                                    <div class="font-semibold text-emerald-700 dark:text-emerald-300 mb-2" data-i18n="cost_title">üí∞ Gesch√§tzte Kosten:</div>
                                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
                                        <div class="text-emerald-600 dark:text-emerald-400">
                                            <b>OpenAI:</b> <span id="cost-openai">$0.00</span>
                                        </div>
                                        <div class="text-emerald-600 dark:text-emerald-400">
                                            <b>Gemini:</b> <span id="cost-gemini">$0.00</span>
                                        </div>
                                        <div class="text-emerald-600 dark:text-emerald-400">
                                            <b>ElevenLabs:</b> <span id="cost-elevenlabs">$0.00</span>
                                        </div>
                                        <div class="text-emerald-600 dark:text-emerald-400">
                                            <b>Polly:</b> <span id="cost-polly">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-2 pt-2 border-t border-emerald-200 dark:border-emerald-700 text-xs text-emerald-600 dark:text-emerald-400">
                                    <span data-i18n="time_estimate_label">‚è±Ô∏è Gesch√§tzte Zeit:</span> <span id="time-estimate">~0 Sek</span>
                                </div>
                                
                                <!-- Preistabelle f√ºr Credits -->
                                <div class="mt-3 pt-3 border-t border-emerald-200 dark:border-emerald-700">
                                    <div class="font-semibold text-emerald-700 dark:text-emerald-300 mb-2 text-xs" data-i18n="pricing_table_title">üìä Credit-Preise (Optimierte Gewinnmarge):</div>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-[11px] border-collapse">
                                            <thead>
                                                <tr class="border-b border-emerald-200 dark:border-emerald-700">
                                                    <th class="text-left py-1 px-2 text-emerald-700 dark:text-emerald-300" data-i18n="pricing_api">API</th>
                                                    <th class="text-right py-1 px-2 text-emerald-700 dark:text-emerald-300" data-i18n="pricing_10k">10.000 Zeichen</th>
                                                    <th class="text-right py-1 px-2 text-emerald-700 dark:text-emerald-300" data-i18n="pricing_100k">100.000 Zeichen</th>
                                                    <th class="text-right py-1 px-2 text-emerald-700 dark:text-emerald-300"><span data-i18n="pricing_300k">300.000 Zeichen</span><br><span class="text-[9px] opacity-75" data-i18n="pricing_novel">(Roman)</span></th>
                                                </tr>
                                            </thead>
                                            <tbody class="text-emerald-600 dark:text-emerald-400">
                                                <tr class="border-b border-emerald-100 dark:border-emerald-800">
                                                    <td class="py-1 px-2"><b>OpenAI</b></td>
                                                    <td class="text-right py-1 px-2">$3.50</td>
                                                    <td class="text-right py-1 px-2">$35.00</td>
                                                    <td class="text-right py-1 px-2">$105.00</td>
                                                </tr>
                                                <tr class="border-b border-emerald-100 dark:border-emerald-800">
                                                    <td class="py-1 px-2"><b>Gemini</b></td>
                                                    <td class="text-right py-1 px-2">$0.60</td>
                                                    <td class="text-right py-1 px-2">$6.00</td>
                                                    <td class="text-right py-1 px-2">$18.00</td>
                                                </tr>
                                                <tr class="border-b border-emerald-100 dark:border-emerald-800">
                                                    <td class="py-1 px-2"><b>ElevenLabs</b></td>
                                                    <td class="text-right py-1 px-2">$27.00</td>
                                                    <td class="text-right py-1 px-2">$270.00</td>
                                                    <td class="text-right py-1 px-2">$810.00</td>
                                                </tr>
                                                <tr>
                                                    <td class="py-1 px-2"><b>Polly</b></td>
                                                    <td class="text-right py-1 px-2">$3.50</td>
                                                    <td class="text-right py-1 px-2">$35.00</td>
                                                    <td class="text-right py-1 px-2">$105.00</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-2 text-[10px] text-emerald-600 dark:text-emerald-500 italic">
                                        üí° Tipp: 1 Credit = 10.000 Zeichen | Immer noch 90% g√ºnstiger als professionelle Studios ($1000-5000 f√ºr Roman)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="convert-button" class="w-full bg-[#881337] text-white px-6 py-2.5 rounded-full font-semibold shadow-xl hover:bg-[#7f1232] dark:hover:bg-rose-900 focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800 flex items-center justify-center transition-colors duration-200 ease-in-out">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M18 3a1 1 0 00-1.447-.894L4 6.434V12a1 1 0 001 1h1a1 1 0 001-1V7.566l10-3.434v1.868a1 1 0 002 0V3z" /><path d="M4 14a1 1 0 00-1 1v1a1 1 0 001 1h1a1 1 0 001-1v-1a1 1 0 00-1-1H4z" /></svg>
                        <span id="button-text">In Audio umwandeln</span>
                    </button>
                    
                    <!-- Save Project Button (NEU!) -->
                    <button id="save-project-btn" type="button" class="w-full mt-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white px-6 py-2.5 rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        <span data-i18n="btn_save_project">üíæ Projekt speichern</span>
                    </button>
                    
                    <!-- Fortschrittsanzeige (NEU!) -->
                    <div id="progress-container" class="hidden mt-4 p-4 bg-blue-50 dark:bg-blue-900/30 border-2 border-blue-200 dark:border-blue-700 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-blue-700 dark:text-blue-300">üéß Generiere Audio...</span>
                            <span id="progress-percent" class="text-sm font-bold text-blue-600 dark:text-blue-400">0%</span>
                        </div>
                        <div class="w-full bg-blue-200 dark:bg-blue-800 rounded-full h-3 overflow-hidden">
                            <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="progress-status" class="text-xs text-blue-600 dark:text-blue-400 mt-2">Vorbereitung...</p>
                    </div>
                    <div id="status-area" class="text-center pt-4">
                        <div id="loader" class="hidden spinner mx-auto"></div>
                        <p id="error-message" class="hidden text-red-600 dark:text-red-500 font-medium"></p>
                        <p id="warning-message" class="hidden text-yellow-600 dark:text-yellow-500 font-medium mt-2"></p>
                    </div>
                </div>

                <div class="collapsible-section" id="section-project">
                    <button type="button" class="section-header pt-4 border-t border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="project_title">Projektverwaltung</h3>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4 text-center space-y-3">
                            <div class="flex justify-center items-center gap-4">
                                 <button id="save-project-button" type="button" data-tooltip-key="tooltip_save" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 flex items-center gap-1.5">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 0a1 1 0 00-1 1v2a1 1 0 001 1h4a1 1 0 001-1V5a1 1 0 00-1-1H8z" /></svg>
                                     <span data-i18n="save_project_button">Projekt speichern</span>
                                 </button>
                                            <button id="load-project-button" data-tooltip-key="tooltip_load" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600 flex items-center gap-1.5">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1h-4.586l-2-2H4a1 1 0 01-1-1V3zm2 2v10h10V5H5z" clip-rule="evenodd" /></svg>
                                     <span data-i18n="load_project_button">Projekt laden</span>
                                 </button>
                                            <button id="export-project-button" data-tooltip-key="tooltip_export" class="text-xs bg-emerald-200 dark:bg-emerald-700 text-emerald-800 dark:text-emerald-100 font-semibold py-1.5 px-3 rounded-full hover:bg-emerald-300 dark:hover:bg-emerald-600 flex items-center gap-1.5">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5 2a1 1 0 00-1 1v12a1 1 0 001 1h10a1 1 0 001-1V6l-4-4H5z"/><path d="M9 7v5H7l3 3 3-3h-2V7H9z"/></svg>
                                                <span>Export (JSON)</span>
                                            </button>
                                            <button id="import-project-json-button" data-tooltip-key="tooltip_import" class="text-xs bg-yellow-200 dark:bg-yellow-700 text-yellow-800 dark:text-yellow-100 font-semibold py-1.5 px-3 rounded-full hover:bg-yellow-300 dark:hover:bg-yellow-600 flex items-center gap-1.5">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M3 3a1 1 0 011-1h12a1 1 0 011 1v12a1 1 0 01-1 1H9l-3 3V3z"/></svg>
                                                <span>Import (JSON)</span>
                                            </button>
                                            <input type="file" id="import-project-file-input" accept="application/json" class="hidden" />
                            </div>
                            <div class="mt-2 text-xs text-center">
                                <label class="inline-flex items-center gap-2">
                                    <input id="use-ssml-checkbox" type="checkbox" />
                                    <span>SSML beim Konvertieren verwenden</span>
                                </label>
                                <div class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Hinweis: SSML wird nur genutzt, wenn dein Proxy/Backend oder der ausgew√§hlte Anbieter SSML unterst√ºtzt. Sonst werden nur einfache Pausen/Formatierungen konservativ √ºbernommen.</div>
                                <div class="mt-1">
                                    <button id="proxy-integration-btn" class="text-[11px] underline text-slate-600 dark:text-slate-300">Proxy-Integration: Anleitung anzeigen</button>
                                </div>
                            </div>
                            <div class="mt-3 text-xs flex items-center justify-center gap-3">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="project-encrypt-checkbox" />
                                    <span>Passwort sch√ºtzen</span>
                                </label>
                                <!-- Use inline style for reliable show/hide and keep a small margin -->
                                <input id="project-password-input" type="password" placeholder="Passwort (optional)" style="display:none; margin-left:6px;" class="px-2 py-1 rounded text-sm" />
                                <button id="project-save-snapshot" class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-semibold py-1 px-3 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">Snapshot speichern</button>
                                <button id="project-manage-snapshots" class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-semibold py-1 px-3 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">Snapshots verwalten</button>
                            </div>
                            <p id="project-status-message" class="text-xs text-slate-500 dark:text-gray-400 h-4"></p>
                        </div>
                    </div>
                </div>

             <div class="collapsible-section" id="section-design">
                 <button type="button" class="section-header pt-4 border-t border-slate-200 dark:border-slate-700">
                        <h3 class="text-xl font-semibold text-slate-800 dark:text-gray-200" data-i18n="design_title">Design-Steuerung</h3>
                        <svg class="chevron-icon w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="section-content">
                        <div class="pt-4 text-center space-y-2">
                            <div class="flex justify-center items-center gap-4 flex-wrap">
                                 <button id="toggle-container-glow" data-tooltip-key="tooltip_glow_container" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600">
                                     <span data-i18n="glow_container_label">Rand-Gl√ºhen:</span> <span id="container-glow-status" data-i18n="status_on">An</span>
                                 </button>
                                 <button id="toggle-input-glow" data-tooltip-key="tooltip_glow_inputs" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600">
                                     <span data-i18n="glow_input_label">Feld-Gl√ºhen:</span> <span id="input-glow-status" data-i18n="status_on">An</span>
                                 </button>
                                  <button id="toggle-tooltips" data-tooltip-key="tooltip_toggle_tooltips" class="text-xs bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-300 dark:hover:bg-slate-600">
                                     <span data-i18n="tooltips_label">Infos:</span> <span id="tooltip-status" data-i18n="status_on">An</span>
                                 </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="result-area" class="hidden space-y-4 pt-4 border-t dark:border-slate-700">
                     <h2 class="text-lg font-semibold text-slate-800 dark:text-gray-200" data-i18n="result_title">Dein Ergebnis:</h2>
                     <audio id="audio-player" controls class="w-full" style="color-scheme: dark;"></audio>
                     <canvas id="equalizer" class="w-full h-24 mt-4"></canvas>
                     <a id="download-link" class="block text-center w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 px-6 py-2.5 rounded-full font-semibold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Audio herunterladen</a>
                </div>
            </div>
        </div>
    </div>

    <script>
    /* Custom accessible select initialization
       - Keeps the native <select> (hidden) for compatibility with existing JS
       - Renders a custom styled listbox that is keyboard accessible
       - Syncs selection back to the native select and dispatches change events
    */

    // Debug helper: show a temporary overlay around an element to visualize its bounds.
    // Useful for diagnosing stacking/overflow issues in different browsers (safe, non-destructive).
    function showDebugOverlay(el, options = {}) {
        // Overlay debug visuals are noisy for end users. Make them opt-in via
        // global flag `window.DEBUG_SELECT_OVERLAY`. Default: OFF.
        try {
            if (!window.DEBUG_SELECT_OVERLAY) return;
            if (!el || !el.getBoundingClientRect) return;
            const rect = el.getBoundingClientRect();
            const overlay = document.createElement('div');
            overlay.className = 'debug-select-overlay';
            const dur = options.duration || 1200;
            Object.assign(overlay.style, {
                position: 'fixed',
                left: (rect.left + window.scrollX) + 'px',
                top: (rect.top + window.scrollY) + 'px',
                width: rect.width + 'px',
                height: rect.height + 'px',
                border: '2px solid rgba(220,38,65,0.9)',
                borderRadius: '6px',
                boxShadow: '0 8px 30px rgba(220,38,65,0.08)',
                pointerEvents: 'none',
                zIndex: 2147483646,
                transition: 'opacity 300ms ease',
                opacity: '1'
            });
            document.body.appendChild(overlay);
            setTimeout(() => { try { overlay.style.opacity = '0'; } catch(e){} }, Math.max(600, dur - 300));
            setTimeout(() => { try { overlay.remove(); } catch(e){} }, dur + 150);
        } catch (err) { console.warn('showDebugOverlay failed', err); }
    }
    function initializeCustomSelects() {
        console.debug && console.debug('initializeCustomSelects: starting');
        const wrappers = document.querySelectorAll('.custom-select-wrapper');
        wrappers.forEach(wrapper => {
            try { console.debug && console.debug('initializeCustomSelects: found wrapper for', wrapper.dataset.target); } catch(e) {}
            // Allow repopulation when native select options change (MutationObserver)
            const targetId = wrapper.dataset.target;
            const native = document.getElementById(targetId);
            if (native) {
                const mo = new MutationObserver(() => {
                    // repopulate this wrapper when children/options change or text content changes
                    try { populateCustomSelect(wrapper); } catch (e) { console.warn('populateCustomSelect failed', e); }
                });
                // Observe changes to children, subtree, character data and attributes so
                // translations or programmatic updates to <option> text/value are picked up.
                mo.observe(native, { childList: true, subtree: true, characterData: true, attributes: true });
            }
            // reuse `native` from above (if the MutationObserver block found it)
            if (!native) return;

            const display = wrapper.querySelector('.custom-select-display');
            const list = wrapper.querySelector('.custom-select-list');

            // populate list from native options
            list.innerHTML = '';
            Array.from(native.options).forEach((opt, idx) => {
                const li = document.createElement('li');
                li.textContent = opt.text;
                li.dataset.value = opt.value;
                li.setAttribute('role', 'option');
                li.setAttribute('aria-selected', opt.selected ? 'true' : 'false');
                li.tabIndex = -1;
                li.addEventListener('click', (ev) => {
                    try { ev.stopPropagation(); } catch (err) {}
                    console.debug && console.debug('custom-select li-click', { id: native?.id, value: li.dataset.value });
                    // select and close
                    native.value = li.dataset.value;
                    // update selected marking
                    list.querySelectorAll('li').forEach(n => n.setAttribute('aria-selected', 'false'));
                    li.setAttribute('aria-selected', 'true');
                    updateDisplay(li.textContent);
                    closeList();
                    native.dispatchEvent(new Event('change', { bubbles: true }));
                    // announce for screenreaders
                    const a11y = document.getElementById('a11y-status');
                    if (a11y) a11y.textContent = `${native.id} ausgew√§hlt: ${li.textContent}`;
                });
                list.appendChild(li);
                if (opt.selected) updateDisplay(opt.text);
            });

            // Keep display in sync when native select changes programmatically
            native.addEventListener('change', () => {
                // update aria-selected states
                list.querySelectorAll('li').forEach(li => li.setAttribute('aria-selected', li.dataset.value === native.value ? 'true' : 'false'));
                const sel = list.querySelector('li[aria-selected="true"]');
                if (sel) updateDisplay(sel.textContent);
            });

            if (!display.innerHTML) updateDisplay(native.options[native.selectedIndex]?.text || '');

            function updateDisplay(text) {
                // label + chevron
                display.innerHTML = '';
                const span = document.createElement('span');
                span.className = 'custom-select-label';
                span.textContent = text;
                const chev = document.createElement('span');
                chev.className = 'chev';
                chev.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.06z"/></svg>';
                display.appendChild(span);
                display.appendChild(chev);
            }

            function openList() {
                // If wrapper requests in-flow behavior, render the list inline so it
                // pushes content down instead of floating over the page.
                const inflow = wrapper.dataset.inflow === 'true';
                list.classList.add('show');
                wrapper.classList.add('open');
                display.setAttribute('aria-expanded', 'true');

                if (inflow) {
                    // Ensure list remains in its original parent and is displayed
                    try {
                        // clear any previously applied floating styles
                        list.style.position = '';
                        list.style.left = '';
                        list.style.top = '';
                        list.style.width = '';
                        list.style.zIndex = '';
                        list.style.display = 'block';
                        wrapper.classList.add('open-inflow');
                    } catch (err) { console.warn('openList (inflow) failed', err); }
                } else {
                    // Floating behavior (keeps previous behavior when inflow not requested)
                    try {
                        const rect = display.getBoundingClientRect();
                        // store original parent so we can restore later
                        if (!list.dataset.originalParent) {
                            list.dataset.originalParent = '1';
                            list._origParent = list.parentElement;
                            list._origNext = list.nextSibling;
                        }

                        Object.assign(list.style, {
                            position: 'absolute',
                            left: (rect.left + window.scrollX) + 'px',
                            top: (rect.top + window.scrollY + rect.height + 6) + 'px',
                            width: rect.width + 'px',
                            zIndex: '2147483646',
                            display: 'block',
                        });

                        if (list.parentElement !== document.body) document.body.appendChild(list);
                    } catch (err) {
                        console.warn('openList: floating list to body failed', err);
                    }
                }

                // focus selected item for keyboard users
                const sel = list.querySelector('li[aria-selected="true"]') || list.querySelector('li');
                try { sel?.focus({ preventScroll: true }); } catch(e) { sel?.focus(); }

                // Visual debug overlay (opt-in)
                try { showDebugOverlay(list, { duration: 1200 }); } catch(e){}
            }

            function closeList() {
                try {
                    console.debug && console.debug('closeList invoked', { target: wrapper.dataset.target, inflow: wrapper.dataset.inflow === 'true', listChildCount: list.children.length });
                    // remove floating styles
                    const inflow = wrapper.dataset.inflow === 'true';
                    list.classList.remove('show');
                    wrapper.classList.remove('open');
                    display.setAttribute('aria-expanded', 'false');

                    if (inflow) {
                        // hide inline list
                        try {
                            list.style.display = '';
                            wrapper.classList.remove('open-inflow');
                        } catch (err) { console.warn('closeList (inflow) failed', err); }
                    } else {
                        // restore to original parent if we moved it
                        if (list._origParent) {
                            try {
                                // restore inline styles we added
                                list.style.position = '';
                                list.style.left = '';
                                list.style.top = '';
                                list.style.width = '';
                                list.style.zIndex = '';
                                list.style.display = '';

                                if (list.parentElement !== list._origParent && list._origParent) {
                                    if (list._origNext && list._origNext.parentElement === list._origParent) {
                                        list._origParent.insertBefore(list, list._origNext);
                                    } else {
                                        list._origParent.appendChild(list);
                                    }
                                }
                            } catch (err) { console.warn('closeList: restore failed', err); }
                        }
                    }
                } catch (e) {
                    console.warn('closeList failed', e);
                }

                try { display.focus({ preventScroll: true }); } catch(e) { display.focus(); }
                console.debug && console.debug('closeList completed', { target: wrapper.dataset.target });
            }

            display.addEventListener('click', (e) => {
                // prevent the click from bubbling to global document handlers
                // which may close the dropdown immediately in some browsers
                try { e.stopPropagation(); } catch (err) {}
                const isOpen = list.classList.contains('show');
                if (isOpen) {
                    closeList();
                    return;
                }

                // Try to open the custom list. If it appears empty or stays closed (race with CSS/DOM),
                // attempt a repopulation and re-open before falling back to the native select.
                openList();

                // Small check sequence: give the browser a moment to render, then validate
                // that the list is visible and has items. If not, attempt to repopulate once.
                setTimeout(() => {
                    try {
                        const childCount = list.children.length;
                        const rect = list.getBoundingClientRect();
                        const visible = (childCount > 0) && (rect.height > 2) && getComputedStyle(list).display !== 'none' && getComputedStyle(list).visibility !== 'hidden' && rect.width > 10;
                        console.debug && console.debug('custom-select check', { id: native?.id, childCount, rect, visible });

                        if (!visible) {
                            // Try to repopulate once (in case MutationObserver hasn't run yet)
                            try { populateCustomSelect(wrapper); } catch (e) { console.warn('populateCustomSelect retry failed', e); }
                            // re-open quickly
                            try { openList(); } catch(e){}
                        }

                        // final check after repopulation
                        setTimeout(() => {
                            const finalCount = list.children.length;
                            const finalRect = list.getBoundingClientRect();
                            const finalVisible = (finalCount > 0) && (finalRect.height > 2) && getComputedStyle(list).display !== 'none' && finalRect.width > 10;
                            console.debug && console.debug('custom-select final-check', { id: native?.id, finalCount, finalRect, finalVisible });
                            if (!finalVisible) {
                                console.debug && console.debug('Custom select fallback: showing native select for', native?.id);
                                // give the native control a chance
                                showNativeSelectFallback(native, display);
                            }
                        }, 80);
                    } catch (e) { console.warn('Custom select click fallback failed', e); }
                }, 30);
            });

            // keyboard support
            display.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowDown' || e.key === 'Down') {
                    e.preventDefault();
                    openList();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const isOpen = list.classList.contains('show');
                    if (isOpen) {
                        // pick focused item
                        const focused = document.activeElement;
                        if (focused && focused.parentElement === list) focused.click();
                    } else {
                        openList();
                    }
                }
            });

            // navigation inside list
            list.addEventListener('keydown', (e) => {
                const items = Array.from(list.querySelectorAll('li'));
                const idx = items.indexOf(document.activeElement);
                if (e.key === 'ArrowDown' || e.key === 'Down') {
                    e.preventDefault();
                    const next = items[(idx + 1) % items.length]; next?.focus();
                } else if (e.key === 'ArrowUp' || e.key === 'Up') {
                    e.preventDefault();
                    const prev = items[(idx - 1 + items.length) % items.length]; prev?.focus();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault(); document.activeElement.click();
                } else if (e.key === 'Escape' || e.key === 'Esc') {
                    e.preventDefault(); closeList();
                }
            });

            // make hovering the list focus the hovered item so hover state is visible
            list.addEventListener('mousemove', (e) => {
                try {
                    const li = e.target.closest('li');
                    if (li && li.parentElement === list) {
                        // avoid stealing focus from keyboard navigation if already focused
                        if (document.activeElement !== li) {
                            li.focus();
                        }
                    }
                } catch (err) { /* non-fatal */ }
            });

            // NOTE: auto-open on pointerenter removed to require an explicit click.
            // (Keeping hover/focus visual affordances via CSS; list only opens on click/keyboard.)

            // click outside closes list ‚Äî allow clicks inside the floating list
            document.addEventListener('click', (ev) => {
                try {
                    if (!wrapper.contains(ev.target) && !list.contains(ev.target)) closeList();
                } catch (e) {
                    // defensive: if list is moved or not present, fallback to wrapper-only check
                    if (!wrapper.contains(ev.target)) closeList();
                }
            });
        });
    }

    // Helper: temporarily reveal native select when custom UI fails (non-destructive)
    function showNativeSelectFallback(native, display) {
        // Suppress showing the browser-native select control.
        // Many Chromium-based browsers (Vivaldi, Brave, etc.) open a native overlay
        // when the control is focused or made visible programmatically. That overlay
        // can cover the whole UI and make interaction impossible. To avoid that
        // behavior we do NOT change inline styles or call focus() here anymore.
        // Instead, we surface a debug hint so developers can see where the
        // custom list would have been rendered and help diagnose the root cause.
        if (!native) return;
        try {
            console.warn('Native select fallback requested for', native.id, '- suppressed to avoid native popup.');
            // Show a debug overlay around the intended area (the custom display)
            try { showDebugOverlay(display || native, { duration: 2400 }); } catch (e) {}
            // Keep the native select hidden and non-focusable ‚Äì selection will still
            // be written to the native element programmatically when the user picks
            // an item from the custom list (so existing change handlers still work).
        } catch (e) {
            // Non-fatal: log and continue
            console.warn('showNativeSelectFallback suppressed error', e);
        }
    }

    // Small helper to populate a single wrapper (used by MutationObserver)
    function populateCustomSelect(wrapper) {
        const targetId = wrapper.dataset.target;
        const native = document.getElementById(targetId);
        if (!native) return;
        const display = wrapper.querySelector('.custom-select-display');
        const list = wrapper.querySelector('.custom-select-list');
        // clear
        list.innerHTML = '';
        Array.from(native.options).forEach((opt, idx) => {
            const li = document.createElement('li');
            li.textContent = opt.text;
            li.dataset.value = opt.value;
            li.setAttribute('role', 'option');
            li.setAttribute('aria-selected', opt.selected ? 'true' : 'false');
            li.tabIndex = -1;
            li.addEventListener('click', (ev) => {
                try { ev.stopPropagation(); } catch (err) {}
                console.debug && console.debug('populateCustomSelect li-click', { id: native.id, value: li.dataset.value });

                // Always set the native value (even if same) and notify change handlers
                native.value = li.dataset.value;
                list.querySelectorAll('li').forEach(n => n.setAttribute('aria-selected', 'false'));
                li.setAttribute('aria-selected', 'true');

                // Update visible label in display
                const span = wrapper.querySelector('.custom-select-label');
                if (span) {
                    span.textContent = li.textContent;
                } else {
                    // create label + chevron if missing
                    const newSpan = document.createElement('span'); newSpan.className = 'custom-select-label'; newSpan.textContent = li.textContent;
                    const chev = document.createElement('span'); chev.className = 'chev'; chev.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.06z"/></svg>';
                    display.innerHTML = '';
                    display.appendChild(newSpan);
                    display.appendChild(chev);
                }

                // Dispatch change so other logic reacts
                native.dispatchEvent(new Event('change', { bubbles: true }));

                // Close the list reliably for both inflow and floating modes
                try {
                    const inflow = wrapper.dataset.inflow === 'true';
                    list.classList.remove('show');
                    wrapper.classList.remove('open');
                    display.setAttribute('aria-expanded', 'false');

                    if (inflow) {
                        try { list.style.display = ''; wrapper.classList.remove('open-inflow'); } catch (err) { console.warn('populateCustomSelect close (inflow) failed', err); }
                    } else {
                        if (list._origParent) {
                            try {
                                list.style.position = '';
                                list.style.left = '';
                                list.style.top = '';
                                list.style.width = '';
                                list.style.zIndex = '';
                                list.style.display = '';
                                if (list.parentElement !== list._origParent && list._origParent) {
                                    if (list._origNext && list._origNext.parentElement === list._origParent) {
                                        list._origParent.insertBefore(list, list._origNext);
                                    } else {
                                        list._origParent.appendChild(list);
                                    }
                                }
                            } catch (err) { console.warn('populateCustomSelect close restore failed', err); }
                        }
                    }
                } catch (err) { console.warn('populateCustomSelect close failed', err); }

                try { display.focus({ preventScroll: true }); } catch (e) { display.focus(); }

                // Announce for screenreaders
                const a11y = document.getElementById('a11y-status');
                if (a11y) a11y.textContent = `${native.id} ausgew√§hlt: ${li.textContent}`;
            });
            list.appendChild(li);
            if (opt.selected) {
                const span = wrapper.querySelector('.custom-select-label');
                if (span) span.textContent = opt.text;
            }
        });
        if (!display.querySelector('.custom-select-label')) {
            const span = document.createElement('span'); span.className = 'custom-select-label'; span.textContent = native.options[native.selectedIndex]?.text || '';
            const chev = document.createElement('span'); chev.className = 'chev'; chev.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.06z"/></svg>';
            display.appendChild(span); display.appendChild(chev);
        }
    }

    // Generic open/close helpers that operate on a wrapper element.
    function openCustomSelectWrapper(wrapper) {
        if (!wrapper) return;
        const display = wrapper.querySelector('.custom-select-display');
        const list = wrapper.querySelector('.custom-select-list');
        if (!display || !list) return;
        const inflow = wrapper.dataset.inflow === 'true';
        list.classList.add('show');
        wrapper.classList.add('open');
        display.setAttribute('aria-expanded', 'true');

        if (inflow) {
            try { list.style.position = ''; list.style.left = ''; list.style.top = ''; list.style.width = ''; list.style.zIndex = ''; list.style.display = 'block'; wrapper.classList.add('open-inflow'); } catch (err) { console.warn('openCustomSelectWrapper (inflow) failed', err); }
        } else {
            try {
                const rect = display.getBoundingClientRect();
                if (!list._origParent) { list._origParent = list.parentElement; list._origNext = list.nextSibling; }
                Object.assign(list.style, { position: 'absolute', left: (rect.left + window.scrollX) + 'px', top: (rect.top + window.scrollY + rect.height + 6) + 'px', width: rect.width + 'px', zIndex: '2147483646', display: 'block' });
                if (list.parentElement !== document.body) document.body.appendChild(list);
            } catch (err) { console.warn('openCustomSelectWrapper (float) failed', err); }
        }

        // Focus selected item
        const sel = list.querySelector('li[aria-selected="true"]') || list.querySelector('li');
        try { sel?.focus({ preventScroll: true }); } catch(e) { sel?.focus(); }
        try { showDebugOverlay(list, { duration: 900 }); } catch(e){}
    }

    function closeCustomSelectWrapper(wrapper) {
        if (!wrapper) return;
        const display = wrapper.querySelector('.custom-select-display');
        const list = wrapper.querySelector('.custom-select-list');
        if (!display || !list) return;
        try {
            const inflow = wrapper.dataset.inflow === 'true';
            list.classList.remove('show');
            wrapper.classList.remove('open');
            display.setAttribute('aria-expanded', 'false');

            if (inflow) {
                try { list.style.display = ''; wrapper.classList.remove('open-inflow'); } catch (err) { console.warn('closeCustomSelectWrapper (inflow) failed', err); }
            } else {
                if (list._origParent) {
                    try {
                        list.style.position = '';
                        list.style.left = '';
                        list.style.top = '';
                        list.style.width = '';
                        list.style.zIndex = '';
                        list.style.display = '';
                        if (list.parentElement !== list._origParent && list._origParent) {
                            if (list._origNext && list._origNext.parentElement === list._origParent) {
                                list._origParent.insertBefore(list, list._origNext);
                            } else {
                                list._origParent.appendChild(list);
                            }
                        }
                    } catch (err) { console.warn('closeCustomSelectWrapper restore failed', err); }
                }
            }
        } catch (e) { console.warn('closeCustomSelectWrapper failed', e); }
        try { display.focus({ preventScroll: true }); } catch(e) { display.focus(); }
    }

    // Document-level delegated click handler to toggle display reliably
    document.body.addEventListener('click', (ev) => {
        const disp = ev.target.closest && ev.target.closest('.custom-select-display');
        if (!disp) return;
        try { ev.stopPropagation(); } catch(e) {}
        const wrapper = disp.closest('.custom-select-wrapper');
        if (!wrapper) return;
        const list = wrapper.querySelector('.custom-select-list');
        if (!list) return;
        const isOpen = list.classList.contains('show');
        if (isOpen) closeCustomSelectWrapper(wrapper); else openCustomSelectWrapper(wrapper);
    }, true);

    // Ensure display label reflects native select value for all wrappers
    function syncAllCustomSelectDisplays() {
        document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
            try {
                const targetId = wrapper.dataset.target;
                const native = document.getElementById(targetId);
                const display = wrapper.querySelector('.custom-select-display');
                if (!native || !display) return;
                const label = display.querySelector('.custom-select-label');
                const text = native.options[native.selectedIndex]?.text || '';
                if (label) label.textContent = text; else {
                    display.innerHTML = '';
                    const span = document.createElement('span'); span.className = 'custom-select-label'; span.textContent = text;
                    const chev = document.createElement('span'); chev.className = 'chev'; chev.innerHTML = '<svg viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.06z"/></svg>';
                    display.appendChild(span); display.appendChild(chev);
                }
            } catch (err) { /* non-fatal */ }
        });
    }

    // Run an initial sync after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        try { syncAllCustomSelectDisplays(); } catch(e){}
    });

    // Ensure initialization runs after DOM ready
    // a11y live region for custom component announcements
    (function addA11yStatus(){
        const main = document.getElementById('main-container');
        if (main && !document.getElementById('a11y-status')) {
            const sr = document.createElement('div');
            sr.id = 'a11y-status';
            sr.className = 'sr-only';
            sr.setAttribute('aria-live', 'polite');
            main.appendChild(sr);
        }
    })();

    document.addEventListener('DOMContentLoaded', () => {
        
        // initialize custom selects after DOM is ready
        initializeCustomSelects();

        const themeToggleBtn = document.getElementById('theme-toggle');
        const darkIcon = document.getElementById('theme-toggle-dark-icon');
        const lightIcon = document.getElementById('theme-toggle-light-icon');
        const htmlEl = document.documentElement;

        function updateThemeIcons(isDarkMode) {
            darkIcon.classList.toggle('hidden', !isDarkMode);
            lightIcon.classList.toggle('hidden', isDarkMode);
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlEl.classList.add('dark');
                updateThemeIcons(true);
            } else {
                htmlEl.classList.remove('dark');
                updateThemeIcons(false);
            }
        }

        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            applyTheme(systemPrefersDark ? 'dark' : 'light');
        }

        themeToggleBtn.addEventListener('click', () => {
            const isDarkMode = htmlEl.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcons(isDarkMode);
        });

        // --- Collapsible Sections Logic ---
        const sections = document.querySelectorAll('.collapsible-section');
        const collapsedStates = JSON.parse(localStorage.getItem('collapsedSections')) || {};

        sections.forEach(section => {
            const header = section.querySelector('.section-header');
            const sectionId = section.id;

            // Accessibility: expose role and initial aria-expanded state on headers
            header.setAttribute('role', 'button');
            const initiallyCollapsed = section.classList.contains('section-collapsed') || !!collapsedStates[sectionId];
            header.setAttribute('tabindex', '0');
            header.setAttribute('aria-expanded', initiallyCollapsed ? 'false' : 'true');

            // Restore state on load
            if (collapsedStates[sectionId] === undefined && (sectionId === 'section-project' || sectionId === 'section-design')) {
                 section.classList.add('section-collapsed'); // Collapse specific sections by default
            } else if (collapsedStates[sectionId]) {
                 section.classList.add('section-collapsed');
            }


            header.addEventListener('click', () => {
                const isCollapsed = section.classList.toggle('section-collapsed');
                header.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');

                // Save state to localStorage
                collapsedStates[sectionId] = isCollapsed;
                localStorage.setItem('collapsedSections', JSON.stringify(collapsedStates));
                // If the section was collapsed, close any open custom-selects inside it
                if (isCollapsed) {
                    try {
                        section.querySelectorAll('.custom-select-wrapper').forEach(w => {
                            try { closeCustomSelectWrapper(w); } catch(e) {}
                        });
                    } catch (e) { /* non-fatal */ }
                }
            });

            // Keyboard toggle (Enter / Space)
            header.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    header.click();
                }
            });
        });

        // ===== CREDIT SYSTEM =====
        let userCredits = parseInt(localStorage.getItem('userCredits')) || 0;

        function updateCreditBalance() {
            const balanceEl = document.getElementById('credit-balance');
            if (balanceEl) {
                balanceEl.textContent = userCredits.toLocaleString('de-DE');
            }
        }

        function addCredits(amount) {
            userCredits += amount;
            localStorage.setItem('userCredits', userCredits);
            updateCreditBalance();
        }

        function deductCredits(amount) {
            if (userCredits >= amount) {
                userCredits -= amount;
                localStorage.setItem('userCredits', userCredits);
                updateCreditBalance();
                return true;
            }
            return false;
        }

        function hasEnoughCredits(amount) {
            return userCredits >= amount;
        }

        // Credit Shop Modal
        const creditShopModal = document.getElementById('credit-shop-modal');
        const buyCreditsBtn = document.getElementById('buy-credits-btn');
        const closeShopBtn = document.getElementById('close-shop-btn');

        buyCreditsBtn.addEventListener('click', () => {
            creditShopModal.classList.remove('hidden');
        });

        closeShopBtn.addEventListener('click', () => {
            creditShopModal.classList.add('hidden');
        });

        creditShopModal.addEventListener('click', (e) => {
            if (e.target === creditShopModal) {
                creditShopModal.classList.add('hidden');
            }
        });

        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');

        // Feature Toggles
        const featureSettings = {
            voicePreview: true,
            costCalculator: true,
            livePreview: false,
            projectLibrary: true,
            autoSpeaker: true,
            // When true, loading a project will automatically start conversion (default: false)
            autoStartConversion: false
        };

        // If the settings modal doesn't include a toggle for auto-start, create it dynamically.
        function ensureAutoStartToggleExists() {
            try {
                const exists = document.getElementById('toggle-auto-start-load');
                if (exists) return;

                const container = document.querySelector('#settings-modal .settings-features') || document.getElementById('settings-modal');
                if (!container) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-between py-2 border-t border-gray-100 dark:border-slate-700 mt-3 px-2';
                // Access translations safely: translations is declared later with `const` and
                // therefore may be in the temporal dead zone when this function runs.
                // Avoid direct access that can throw ‚Äî use try/catch and fallbacks.
                let t = {};
                try {
                    if (typeof currentLang !== 'undefined' && translations && translations[currentLang]) {
                        t = translations[currentLang];
                    }
                } catch (err) {
                    // translations not available yet, fall back to empty object
                    t = {};
                }
                wrapper.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-3 text-lg">üîÅ</div>
                        <div>
                            <div class="font-medium">${t.settings_auto_start_label || 'Auto-Start nach Laden'}</div>
                            <div class="text-xs text-gray-500">${t.settings_auto_start_desc || 'Projekt laden und automatisch die Konvertierung starten (kostenpflichtig)'}</div>
                        </div>
                    </div>
                    <div>
                        <input type="checkbox" id="toggle-auto-start-load" class="h-5 w-5" />
                    </div>
                `;

                container.appendChild(wrapper);
            } catch (err) {
                console.warn('ensureAutoStartToggleExists failed', err);
            }
        }

        // Load settings from LocalStorage
        function loadSettings() {
            const saved = localStorage.getItem('featureSettings');
            if (saved) {
                Object.assign(featureSettings, JSON.parse(saved));
            }
            
            // Ensure our dynamic toggle exists (if the HTML doesn't include it)
            ensureAutoStartToggleExists();

            // Update toggle states
            document.getElementById('toggle-voice-preview').checked = featureSettings.voicePreview;
            document.getElementById('toggle-cost-calculator').checked = featureSettings.costCalculator;
            document.getElementById('toggle-live-preview').checked = featureSettings.livePreview;
            document.getElementById('toggle-project-library').checked = featureSettings.projectLibrary;
            document.getElementById('toggle-auto-speaker').checked = featureSettings.autoSpeaker;
            // Auto-start conversion toggle
            const autoToggle = document.getElementById('toggle-auto-start-load');
            if (autoToggle) autoToggle.checked = !!featureSettings.autoStartConversion;
        }

        // Save settings to LocalStorage
        function saveSettings() {
            featureSettings.voicePreview = document.getElementById('toggle-voice-preview').checked;
            featureSettings.costCalculator = document.getElementById('toggle-cost-calculator').checked;
            featureSettings.livePreview = document.getElementById('toggle-live-preview').checked;
            featureSettings.projectLibrary = document.getElementById('toggle-project-library').checked;
            featureSettings.autoSpeaker = document.getElementById('toggle-auto-speaker').checked;
            // Save auto-start conversion if toggle exists
            const autoToggle = document.getElementById('toggle-auto-start-load');
            if (autoToggle) featureSettings.autoStartConversion = !!autoToggle.checked;
            
            localStorage.setItem('featureSettings', JSON.stringify(featureSettings));
            
            // Show confirmation
            const t = translations[currentLang];
            alert('‚úÖ ' + (t.settings_saved || 'Einstellungen gespeichert!'));
            settingsModal.classList.add('hidden');
            
            // Apply settings (reload UI elements)
            applySettings();
        }

        // Apply settings to UI
        function applySettings() {
            // Diese Funktion wird sp√§ter erweitert, wenn die Features implementiert sind
            console.log('Settings applied:', featureSettings);
        }

        openSettingsBtn.addEventListener('click', () => {
            loadSettings();
            settingsModal.classList.remove('hidden');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveSettingsBtn.addEventListener('click', saveSettings);

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });

        // Load settings on startup
        loadSettings();

        // ==================== PROJECT LIBRARY ====================
        
        const projectLibraryModal = document.getElementById('project-library-modal');
        const openLibraryBtn = document.getElementById('open-library-btn');
        const closeLibraryBtn = document.getElementById('close-library-btn');
        const newProjectBtn = document.getElementById('new-project-btn');
        const libraryGrid = document.getElementById('project-library-grid');
        const libraryEmptyState = document.getElementById('library-empty-state');
        const librarySearch = document.getElementById('library-search');
        const librarySort = document.getElementById('library-sort');
        
        let projectLibrary = [];

        // Load projects from LocalStorage
        function loadProjectLibrary() {
            const saved = localStorage.getItem('projectLibrary');
            if (saved) {
                projectLibrary = JSON.parse(saved);
            }
            updateProjectLibraryBadge();
        }

        // Save projects to LocalStorage
        function saveProjectLibrary() {
            localStorage.setItem('projectLibrary', JSON.stringify(projectLibrary));
            updateProjectLibraryBadge();
        }

        // Save current project to library (safe version that uses current DOM ids)
        // This wrapper delegates to the main saveProjectToLibrary implementation.
        function saveProjectToLibrary_v2() {
            try {
                saveProjectToLibrary();
            } catch (e) {
                console.warn('saveProjectToLibrary_v2 failed, falling back to saveProjectToLibrary', e);
            }
        }

        // wire the big save button to the safe function
        const bigSaveBtn = document.getElementById('save-project-btn');
        if (bigSaveBtn) bigSaveBtn.addEventListener('click', saveProjectToLibrary_v2);

        // Update badge count
        function updateProjectLibraryBadge() {
            const badge = document.getElementById('library-badge-count');
            if (badge) {
                badge.textContent = projectLibrary.length;
            }
        }

        // Auto-detect emoji from text
        function detectEmoji(text) {
            const emojiMap = {
                'm√§rchen': 'üßö', 'fantasy': 'üßô', 'magie': '‚ú®',
                'krimi': 'üîç', 'thriller': 'üî™', 'mystery': 'üïµÔ∏è',
                'romance': 'üíï', 'liebe': '‚ù§Ô∏è', 'romantic': 'üíë',
                'science': 'üî¨', 'sci-fi': 'üöÄ', 'weltraum': 'üåå',
                'horror': 'üëª', 'grusel': 'üò±', 'scary': 'üíÄ',
                'kinder': 'üß∏', 'kids': 'üéà', 'child': 'üë∂',
                'business': 'üíº', 'gesch√§ft': 'üìä', 'finanzen': 'üí∞',
                'tutorial': 'üìö', 'lernen': 'üéì', 'education': 'üìñ',
                'podcast': 'üéôÔ∏è', 'interview': 'üé§', 'talk': 'üí¨',
                'news': 'üì∞', 'nachricht': 'üì°', 'aktuell': 'üì¢'
            };
            
            const lowerText = text.toLowerCase();
            for (const [key, emoji] of Object.entries(emojiMap)) {
                if (lowerText.includes(key)) {
                    return emoji;
                }
            }
            return 'üìñ'; // Default book emoji
        }

        // Save current project to library
        function saveProjectToLibrary() {
            if (!featureSettings.projectLibrary) {
                alert('‚ö†Ô∏è Projekt-Bibliothek ist deaktiviert. Aktiviere sie in den Einstellungen.');
                return;
            }

            const script = (bookText && bookText.value) ? bookText.value.trim() : '';
            if (!script) {
                alert('‚ö†Ô∏è ' + (translations[currentLang].library_empty || 'Bitte erst ein Skript eingeben!'));
                return;
            }

            const t = translations[currentLang];
            const projectName = prompt(t.save_project_prompt || 'Projekt-Name eingeben:', 'Mein H√∂rbuch');
            if (!projectName) return;

            const speakers = [];
            document.querySelectorAll('.speaker-container').forEach(container => {
                const nameInput = container.querySelector('.speaker-name-input');
                const voiceSelect = container.querySelector('.speaker-voice-select');
                if (nameInput && voiceSelect) {
                    speakers.push({
                        name: nameInput.value,
                        voice: voiceSelect.value
                    });
                }
            });

            const project = {
                id: 'proj_' + Date.now(),
                name: projectName,
                emoji: detectEmoji(projectName + ' ' + script),
                charCount: script.length,
                speakers: speakers.length,
                status: 'draft',
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                duration: Math.ceil(script.length / 20), // Rough estimate: 20 chars/sec
                data: {
                    speakers: speakers,
                    script: script,
                    apiChoice: apiChoice
                }
            };

            projectLibrary.push(project);
            saveProjectLibrary();
            alert('‚úÖ Projekt "' + projectName + '" gespeichert!');
            renderProjectLibrary();
        }

        // Load project from library
        function loadProjectFromLibrary(id) {
            const project = projectLibrary.find(p => p.id === id);
            if (!project) return;

            const t = translations[currentLang];
            if (!confirm((t.library_load_confirm || 'Aktuelles Projekt wird √ºberschrieben. Fortfahren?').replace('{name}', project.name))) {
                return;
            }

            // Load script
            if (bookText) setBookText(project.data.script || '', 'loadProjectFromLibrary');

            // Load API choice
            apiChoice = project.data.apiChoice || 'gemini';
            document.querySelectorAll('.api-choice-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-api') === apiChoice);
            });

            // Clear existing speakers
            if (speakersContainer) speakersContainer.innerHTML = '';

            // Add speakers
            project.data.speakers.forEach((speaker, index) => {
                addSpeaker();
                setTimeout(() => {
                    const containers = document.querySelectorAll('.speaker-container');
                    const container = containers[containers.length - 1];
                    const nameInput = container.querySelector('.speaker-name-input');
                    const voiceSelect = container.querySelector('.speaker-voice-select');
                    if (nameInput) nameInput.value = speaker.name;
                    if (voiceSelect) voiceSelect.value = speaker.voice;
                }, 50 * index);
            });

            // Update project modified timestamp
            project.lastModified = new Date().toISOString();
            saveProjectLibrary();

            projectLibraryModal.classList.add('hidden');
            alert('‚úÖ Projekt "' + project.name + '" geladen!');

            // After loading: either auto-start conversion (if enabled) or show a small non-blocking toast
            try {
                if (featureSettings.autoStartConversion) {
                    if (convertButton) convertButton.click();
                } else {
                    // show non-blocking toast offering to start conversion now
                    showLoadToast(project.name);
                }
            } catch (err) {
                console.warn('post-load auto-start/ toast failed', err);
            }
        }

        // Delete project from library
        function deleteProjectFromLibrary(id) {
            const project = projectLibrary.find(p => p.id === id);
            if (!project) return;

            const t = translations[currentLang];
            const confirmMsg = (t.library_delete_confirm || 'Projekt "{name}" wirklich l√∂schen?').replace('{name}', project.name);
            if (!confirm(confirmMsg)) return;

            projectLibrary = projectLibrary.filter(p => p.id !== id);
            saveProjectLibrary();
            renderProjectLibrary();
            alert('üóëÔ∏è Projekt gel√∂scht!');
        }

        // Expose to global scope so inline handlers (if present) and external scripts
        // can call these functions reliably. Wrapped in try/catch to avoid errors
        // during parse-time if something is unusual in the host environment.
        try {
            window.loadProjectFromLibrary = loadProjectFromLibrary;
            window.deleteProjectFromLibrary = deleteProjectFromLibrary;
        } catch (e) { /* non-fatal */ }

        // --- Toast shown after loading a project (non-blocking) ---
        function showLoadToast(projectName) {
            // Remove existing toast if any
            removeLoadToast();

            const t = (typeof translations !== 'undefined' ? translations[currentLang] : {}) || {};
            const toast = document.createElement('div');
            toast.id = 'load-toast';
            toast.className = 'fixed right-4 bottom-6 z-50 max-w-sm w-full bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg shadow-lg p-4 flex items-start gap-3';
            toast.innerHTML = `
                <div class="flex-1">
                    <div class="font-semibold text-sm">${t.toast_loaded_title || t.library_project_loaded || 'Projekt geladen'}</div>
                    <div class="text-xs text-gray-600 dark:text-gray-300">${projectName}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="load-toast-start" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm">${t.toast_start_now || 'Start'}</button>
                    <button id="load-toast-later" class="text-gray-700 dark:text-gray-200 px-3 py-1 rounded text-sm">${t.toast_later || 'Sp√§ter'}</button>
                </div>
                <div style="display:none" aria-hidden="true"></div>
            `;

            // Optional small checkbox to enable auto-start from the toast
            const opt = document.createElement('div');
            opt.className = 'w-full text-xs text-gray-500 mt-2 flex items-center gap-2';
            opt.innerHTML = `
                <label style="display:flex;align-items:center;gap:6px;cursor:pointer;" title="${t.toast_always_label || 'Auto-Start aktivieren'}">
                    <input type="checkbox" id="load-toast-autostart" style="width:14px;height:14px;" />
                    <span>${t.toast_always_label || 'Immer automatisch starten'}</span>
                </label>
            `;
            toast.appendChild(opt);

            document.body.appendChild(toast);

            document.getElementById('load-toast-start').addEventListener('click', () => {
                // If user checked the 'always' box, store preference
                const cb = document.getElementById('load-toast-autostart');
                if (cb && cb.checked) {
                    featureSettings.autoStartConversion = true;
                    localStorage.setItem('featureSettings', JSON.stringify(featureSettings));
                }
                removeLoadToast();
                if (convertButton) convertButton.click();
            });

            document.getElementById('load-toast-later').addEventListener('click', () => {
                removeLoadToast();
            });

            // Auto-remove after 12s
            toast._timeout = setTimeout(removeLoadToast, 12000);
        }

        function removeLoadToast() {
            const old = document.getElementById('load-toast');
            if (old) {
                clearTimeout(old._timeout);
                old.remove();
            }
        }

        // Visual feedback: briefly add a glow class to the project tile when loading
        function flashProjectTile(id) {
            try {
                const sel = libraryGrid.querySelector(`[data-project-id="${id}"]`);
                if (!sel) return;
                // ensure class for animation; use a stable class name and remove after timeout
                sel.classList.add('project-tile');
                sel.classList.add('tile-glow');
                setTimeout(() => {
                    try { sel.classList.remove('tile-glow'); } catch (e) {}
                }, 900);
            } catch (err) { console.warn('flashProjectTile failed', err); }
        }

        // Render project library
        function renderProjectLibrary(filteredProjects = null) {
            const projects = filteredProjects || projectLibrary;
            
            if (projects.length === 0) {
                libraryGrid.classList.add('hidden');
                libraryEmptyState.classList.remove('hidden');
                return;
            }

            libraryGrid.classList.remove('hidden');
            libraryEmptyState.classList.add('hidden');

            const t = translations[currentLang];
            
            libraryGrid.innerHTML = projects.map(project => {
                const date = new Date(project.lastModified);
                const dateStr = date.toLocaleDateString(currentLang === 'de' ? 'de-DE' : currentLang === 'zh' ? 'zh-CN' : currentLang === 'ja' ? 'ja-JP' : 'en-US');
                
                return `
                    <div data-project-id="${project.id}" tabindex="0" role="button" title="Doppelklick oder Enter zum Laden" class="bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 rounded-lg p-4 hover:border-purple-400 dark:hover:border-purple-600 transition-all hover:shadow-lg group" style="cursor:pointer">
                        <div class="flex items-start justify-between mb-3">
                            <div class="text-4xl">${project.emoji}</div>
                            <div class="flex gap-2">
                                <button data-action="load" data-project-id="${project.id}" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-1 hover:scale-110 transition-transform" title="${t.library_btn_load || 'Laden'}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                </button>
                                <button data-action="delete" data-project-id="${project.id}" class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1 hover:scale-110 transition-transform" title="${t.library_btn_delete || 'L√∂schen'}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white mb-2 truncate">${project.name}</h3>
                        <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex items-center gap-2">
                                <span>üìù ${project.charCount.toLocaleString()} ${t.library_chars || 'Zeichen'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span>üé≠ ${project.speakers} ${t.library_speakers || 'Sprecher'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span>‚è±Ô∏è ~${Math.floor(project.duration / 60)}m ${project.duration % 60}s</span>
                            </div>
                            <div class="flex items-center gap-2 text-xs">
                                <span>üìÖ ${dateStr}</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${project.status === 'completed' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300' : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300'}">
                                ${project.status === 'completed' ? (t.library_status_completed || '‚úì Fertig') : (t.library_status_draft || 'üìù Entwurf')}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            // Attach programmatic dblclick / Enter handlers to tiles as a robust
            // fallback in case inline handlers are ignored by the browser (e.g. CSP
            // or scoping issues). This does not remove existing inline handlers ‚Äî
            // it only guarantees that tiles are interactive.
            setTimeout(() => {
                try {
                    const tiles = Array.from(libraryGrid.querySelectorAll('[data-project-id]'));
                    tiles.forEach(tile => {
                        if (tile._projectListenersAttached) return;
                        const id = tile.getAttribute('data-project-id');
                        // ensure accessibility attributes
                        if (!tile.hasAttribute('tabindex')) tile.setAttribute('tabindex', '0');
                        if (!tile.getAttribute('role')) tile.setAttribute('role', 'button');

                        tile.addEventListener('dblclick', (ev) => {
                            ev.stopPropagation();
                            try {
                                flashProjectTile(id);
                                if (typeof window.loadProjectFromLibrary === 'function') {
                                    window.loadProjectFromLibrary(id);
                                } else {
                                    console.warn('loadProjectFromLibrary is not a function (dblclick fallback)');
                                }
                            } catch (err) {
                                console.error('tile dblclick handler error', err);
                            }
                        });

                        tile.addEventListener('keydown', (ev) => {
                            if (ev.key === 'Enter') {
                                ev.stopPropagation();
                                try {
                                    try { flashProjectTile(id); } catch(e){}
                                    if (typeof window.loadProjectFromLibrary === 'function') {
                                            window.loadProjectFromLibrary(id);
                                        } else {
                                            console.warn('loadProjectFromLibrary is not a function (keydown fallback)');
                                        }
                                } catch (err) {
                                    console.error('tile keydown handler error', err);
                                }
                            }
                        });

                        // Attach click handlers for inner action buttons (load/delete)
                        // and prevent dblclick from bubbling to the tile
                        tile.querySelectorAll('button').forEach(btn => {
                            btn.addEventListener('dblclick', (e) => e.stopPropagation());
                            const action = btn.getAttribute('data-action');
                            if (action === 'load') {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    try {
                                        try { flashProjectTile(id); } catch(e){}
                                        if (typeof window.loadProjectFromLibrary === 'function') {
                                            window.loadProjectFromLibrary(id);
                                        } else {
                                            console.warn('loadProjectFromLibrary is not a function (button)');
                                        }
                                    } catch (err) { console.error('button load handler error', err); }
                                });
                            } else if (action === 'delete') {
                                btn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    try {
                                        if (typeof window.deleteProjectFromLibrary === 'function') {
                                            window.deleteProjectFromLibrary(id);
                                        } else {
                                            console.warn('deleteProjectFromLibrary is not a function (button)');
                                        }
                                    } catch (err) { console.error('button delete handler error', err); }
                                });
                            }
                        });

                        tile._projectListenersAttached = true;
                    });
                } catch (err) {
                    console.warn('attachProjectTileListeners failed', err);
                }
            }, 20);
        }

        // Search projects
        function searchProjects(searchTerm) {
            const filtered = projectLibrary.filter(project => 
                project.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                project.data.script.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderProjectLibrary(filtered);
        }

        // Sort projects
        function sortProjects(sortBy) {
            const sorted = [...projectLibrary];
            
            switch(sortBy) {
                case 'newest':
                    sorted.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
                    break;
                case 'oldest':
                    sorted.sort((a, b) => new Date(a.lastModified) - new Date(b.lastModified));
                    break;
                case 'largest':
                    sorted.sort((a, b) => b.charCount - a.charCount);
                    break;
                case 'smallest':
                    sorted.sort((a, b) => a.charCount - b.charCount);
                    break;
                case 'alphabetical':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            renderProjectLibrary(sorted);
        }

        // Event Listeners
        openLibraryBtn.addEventListener('click', () => {
            if (!featureSettings.projectLibrary) {
                alert('‚ö†Ô∏è Projekt-Bibliothek ist deaktiviert. Aktiviere sie in den Einstellungen.');
                return;
            }
            loadProjectLibrary();
            renderProjectLibrary();
            projectLibraryModal.classList.remove('hidden');
        });

        closeLibraryBtn.addEventListener('click', () => {
            projectLibraryModal.classList.add('hidden');
        });

        newProjectBtn.addEventListener('click', () => {
            projectLibraryModal.classList.add('hidden');
            // Optionally clear the form for a new project
            if (confirm(translations[currentLang].library_new_confirm || 'Neues Projekt starten? (Aktuelles wird nicht gespeichert)')) {
                if (bookText) setBookText('', 'newProject');
                if (speakersContainer) speakersContainer.innerHTML = '';
                addSpeaker();
            }
        });

        projectLibraryModal.addEventListener('click', (e) => {
            if (e.target === projectLibraryModal) {
                projectLibraryModal.classList.add('hidden');
            }
        });

        librarySearch.addEventListener('input', (e) => {
            searchProjects(e.target.value);
        });

        // Prevent clicks on the sort <select> from bubbling to the modal backdrop
        // (some browsers/renderers can emit events that the modal interprets as outside clicks)
        if (librarySort) {
            ['mousedown','mouseup','click','touchstart','focus','keydown'].forEach(evt => {
                librarySort.addEventListener(evt, (ev) => ev.stopPropagation());
            });

            librarySort.addEventListener('change', (e) => {
                // stop propagation to avoid accidental modal backdrop handlers closing the modal
                e.stopPropagation();
                sortProjects(e.target.value);
            });
        }

        // Add "Save Project" button functionality (you can add a button in the UI)
        // For now, we can use Ctrl+S or add a button later
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveProjectToLibrary();
            }
        });

        // Make Tab/Shift+Tab insert/unindent in the main script textarea `#book-text`
        (function enableTextareaTabbing(){
            const ta = document.getElementById('book-text');
            if (!ta) return;

            ta.addEventListener('keydown', function(e){
                if (e.key !== 'Tab') return;
                e.preventDefault();

                const start = ta.selectionStart;
                const end = ta.selectionEnd;
                const value = ta.value;

                // If there's a selection spanning multiple lines, indent/unindent those lines
                const selected = value.slice(start, end);
                const lineStart = value.lastIndexOf('\n', start - 1) + 1;
                const lineEnd = value.indexOf('\n', end);
                const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

                if (e.shiftKey) {
                    // Unindent: remove one leading tab or up to 4 spaces from each line in selection
                    const before = value.slice(0, lineStart);
                    const block = value.slice(lineStart, actualLineEnd);
                    const lines = block.split('\n').map(l => l.replace(/^\t|^ {1,4}/, ''));
                    const newBlock = lines.join('\n');
                    ta.value = before + newBlock + value.slice(actualLineEnd);
                    // restore selection roughly to the same block range
                    const newStart = Math.max(lineStart, start - 1);
                    const newEnd = newStart + newBlock.length;
                    ta.setSelectionRange(newStart, newEnd);
                } else {
                    // Insert a tab character at caret, or indent selected lines
                    if (start === end) {
                        // simple insert
                        const before = value.slice(0, start);
                        const after = value.slice(end);
                        ta.value = before + '\t' + after;
                        ta.setSelectionRange(start + 1, start + 1);
                    } else {
                        // indent all lines in the selection
                        const before = value.slice(0, lineStart);
                        const block = value.slice(lineStart, actualLineEnd);
                        const lines = block.split('\n').map(l => '\t' + l);
                        const newBlock = lines.join('\n');
                        ta.value = before + newBlock + value.slice(actualLineEnd);
                        const newStart = lineStart;
                        const newEnd = newStart + newBlock.length;
                        ta.setSelectionRange(newStart, newEnd);
                    }
                }
            });
        })();

        // Load project library on startup
        loadProjectLibrary();

        // Prevent global document click handlers from interfering with native <select>
        // interactions (e.g. speaker voice selects). Add a small delegation that
        // stops propagation for clicks/mousedowns on form selects so the browser can
        // open the native dropdown without our global handlers closing it.
        (function shieldNativeSelects(){
            try {
                const onDown = (e) => {
                    const sel = e.target.closest('select');
                    if (sel) {
                        try { e.stopPropagation(); } catch(e) {}
                    }
                };
                document.body.addEventListener('mousedown', onDown, true);
                document.body.addEventListener('click', (e) => {
                    // also prevent synthetic click bubbling for selects
                    const sel = e.target.closest('select');
                    if (sel) {
                        try { e.stopPropagation(); } catch(e) {}
                    }
                }, true);
            } catch (err) { console.warn('shieldNativeSelects failed', err); }
        })();

        // ==================== END PROJECT LIBRARY ====================

        // ==================== VOICE PREVIEW MODAL ====================
        
        const voicePreviewModal = document.getElementById('voice-preview-modal');
        const closeVoicePreviewBtn = document.getElementById('close-voice-preview-btn');
        const voiceApiTabs = document.querySelectorAll('.voice-api-tab');
        const voiceGrids = document.querySelectorAll('.voice-grid');
        
        let currentAudioElement = null;

        // Open Voice Preview Modal (from UI button - we'll add this later)
        function openVoicePreviewModal() {
            if (!featureSettings.voicePreview) {
                alert('‚ö†Ô∏è Stimmen-Vorschau ist deaktiviert. Aktiviere sie in den Einstellungen.');
                return;
            }
            voicePreviewModal.classList.remove('hidden');
        }

        // Close Voice Preview Modal
        closeVoicePreviewBtn.addEventListener('click', () => {
            voicePreviewModal.classList.add('hidden');
            stopCurrentAudio();
        });

        voicePreviewModal.addEventListener('click', (e) => {
            if (e.target === voicePreviewModal) {
                voicePreviewModal.classList.add('hidden');
                stopCurrentAudio();
            }
        });

        // Tab switching
        voiceApiTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const api = tab.getAttribute('data-api');
                
                // Update tab styles
                voiceApiTabs.forEach(t => {
                    t.classList.remove('active', 'bg-indigo-600', 'text-white');
                    t.classList.add('bg-gray-200', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-gray-300');
                });
                tab.classList.remove('bg-gray-200', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-gray-300');
                tab.classList.add('active', 'bg-indigo-600', 'text-white');
                
                // Show corresponding grid
                voiceGrids.forEach(grid => {
                    if (grid.getAttribute('data-api') === api) {
                        grid.classList.remove('hidden');
                        grid.classList.add('active');
                    } else {
                        grid.classList.add('hidden');
                        grid.classList.remove('active');
                    }
                });
                
                stopCurrentAudio();
            });
        });

        // Initialize first tab
        voiceApiTabs[0].classList.add('bg-indigo-600', 'text-white');
        voiceApiTabs[0].classList.remove('bg-gray-200', 'dark:bg-slate-700');

        // Stop currently playing audio
        function stopCurrentAudio() {
            if (currentAudioElement) {
                currentAudioElement.pause();
                currentAudioElement.currentTime = 0;
                currentAudioElement = null;
            }
        }

        // Voice preview caching + queue
        const voicePreviewCache = new Map(); // key -> { type: 'utterance'|'blob', blobUrl?, createdAt }
        const voicePreviewQueue = [];
        let voicePreviewBusy = false;

        function processVoiceQueue() {
            if (voicePreviewBusy || voicePreviewQueue.length === 0) return;
            voicePreviewBusy = true;
            const job = voicePreviewQueue.shift();
            const { api, voice, demoText, button, originalHTML, key, resolve, reject } = job;

            // utility to restore UI and continue
            const finish = (result) => {
                try { if (button) button.innerHTML = originalHTML; button && (button.disabled = false); } catch (e) {}
                voicePreviewBusy = false;
                // short delay to avoid overlapping immediately
                setTimeout(() => processVoiceQueue(), 120);
                resolve(result);
            };

            const fail = (err) => {
                try { if (button) button.innerHTML = originalHTML; button && (button.disabled = false); } catch (e) {}
                voicePreviewBusy = false;
                setTimeout(() => processVoiceQueue(), 120);
                reject(err);
            };

            (async () => {
                try {
                    if (api === 'openai') {
                        // Use Web Speech API as demo TTS; wrap in promise that resolves onend
                        const utterance = new SpeechSynthesisUtterance(demoText);
                        const voices = window.speechSynthesis.getVoices() || [];
                        const matchingVoice = voices.find(v => 
                            v.name.toLowerCase().includes(voice.toLowerCase()) ||
                            (currentLang === 'de' && v.lang && v.lang.startsWith('de')) ||
                            (currentLang === 'en' && v.lang && v.lang.startsWith('en')) ||
                            (currentLang === 'es' && v.lang && v.lang.startsWith('es')) ||
                            (currentLang === 'zh' && v.lang && v.lang.startsWith('zh')) ||
                            (currentLang === 'ja' && v.lang && v.lang.startsWith('ja'))
                        );
                        if (matchingVoice) utterance.voice = matchingVoice;

                        utterance.onend = () => {
                            // cache simple marker that this combination has been played
                            voicePreviewCache.set(key, { type: 'utterance', createdAt: Date.now() });
                            finish({ type: 'utterance' });
                        };

                        utterance.onerror = (e) => {
                            fail(new Error('TTS error'));
                        };

                        window.speechSynthesis.speak(utterance);
                    } else {
                        // Non-openai: no actual TTS in demo, just inform and resolve
                        finish({ type: 'none' });
                    }
                } catch (err) {
                    fail(err);
                }
            })();
        }

        function enqueueVoicePreview(api, voice, demoText, button) {
            const key = `${api}:${voice}:${currentLang}:${demoText}`;

            // If cached, play quickly (for utterance type we just replay speechSynthesis)
            const cached = voicePreviewCache.get(key);
            if (cached) {
                return new Promise((resolve) => {
                    if (cached.type === 'utterance') {
                        // replay via speechSynthesis
                        const utterance = new SpeechSynthesisUtterance(demoText);
                        const voices = window.speechSynthesis.getVoices() || [];
                        const matchingVoice = voices.find(v => v.name.toLowerCase().includes(voice.toLowerCase()));
                        if (matchingVoice) utterance.voice = matchingVoice;
                        utterance.onend = () => resolve({ type: 'utterance' });
                        window.speechSynthesis.speak(utterance);
                    } else if (cached.blobUrl) {
                        const audio = new Audio(cached.blobUrl);
                        currentAudioElement = audio;
                        audio.onended = () => resolve({ type: 'blob' });
                        audio.onerror = () => resolve({ type: 'blob' });
                        audio.play().catch(() => resolve({ type: 'blob' }));
                    } else {
                        resolve(cached);
                    }
                });
            }

            // push to queue and return a promise
            return new Promise((resolve, reject) => {
                const originalHTML = button ? button.innerHTML : '';
                if (button) {
                    try { button.innerHTML = '<svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle></svg> <span>L√§dt...</span>'; button.disabled = true; } catch(e){}
                }
                voicePreviewQueue.push({ api, voice, demoText, button, originalHTML, key, resolve, reject });
                processVoiceQueue();
            });
        }

        // Play voice sample with queue + cache (simplified demo using Web Speech API)
        async function playVoiceSample(api, voice, button) {
            stopCurrentAudio();

            const t = translations[currentLang];
            const demoTexts = {
                de: "Hallo! Dies ist ein Beispiel, wie diese Stimme klingt. Perfekt f√ºr dein H√∂rbuch!",
                en: "Hello! This is an example of how this voice sounds. Perfect for your audiobook!",
                es: "¬°Hola! Este es un ejemplo de c√≥mo suena esta voz. ¬°Perfecto para tu audiolibro!",
                zh: "‰Ω†Â•ΩÔºÅËøôÊòØÊ≠§ËØ≠Èü≥ÁöÑÁ§∫‰æã„ÄÇÈùûÂ∏∏ÈÄÇÂêàÊÇ®ÁöÑÊúâÂ£∞ËØªÁâ©ÔºÅ",
                ja: "„Åì„Çì„Å´„Å°„ÅØÔºÅ„Åì„Çå„ÅØ„Åì„ÅÆÂ£∞„ÅÆ‰æã„Åß„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Å´ÊúÄÈÅ©„Åß„ÅôÔºÅ"
            };

            const demoText = demoTexts[currentLang] || demoTexts['de'];

            try {
                if (api === 'openai') {
                    // enqueue and play via queue to avoid overlapping requests
                    await enqueueVoicePreview(api, voice, demoText, button);
                } else {
                    alert('‚ÑπÔ∏è ' + (t.voice_preview_demo_only || 'Demo-Funktion. Vollst√§ndige API-Integration kommt bald!'));
                }
            } catch (error) {
                console.error('Voice preview error:', error);
                alert('‚ùå Fehler beim Abspielen der Stimme: ' + (error.message || error));
            }
        }

        // Make function globally available
        window.playVoiceSample = playVoiceSample;
        window.openVoicePreviewModal = openVoicePreviewModal;

        // ==================== END VOICE PREVIEW MODAL ====================

        // ==================== COST CALCULATOR MODAL ====================
        
        const costCalcModal = document.getElementById('cost-calculator-modal');
        const closeCostCalcBtn = document.getElementById('close-cost-calc-btn');
        const calcCharSlider = document.getElementById('calc-char-slider');
        const calcCharDisplay = document.getElementById('calc-char-display');
        const calcDurationDisplay = document.getElementById('calc-duration-display');
        const calcCostTableBody = document.getElementById('calc-cost-table-body');
        const calcBestDealText = document.getElementById('calc-best-deal-text');

        // API pricing (cost per 1M characters in USD)
        const API_PRICING = {
            gemini: 0.06,      // $60 per 1M chars = $0.06 per 1k
            openai: 0.225,     // $225 per 1M chars = $0.225 per 1k
            elevenlabs: 2.70,  // $2700 per 1M chars = $2.70 per 1k
            polly: 0.24        // $240 per 1M chars = $0.24 per 1k
        };

        // Our pricing markup (what we charge per 10k characters)
        const CREDIT_PRICING = {
            gemini: 0.60,      // 30x markup
            openai: 3.50,      // updated price per 10k chars
            elevenlabs: 27.00, // 16x markup (was 10x, now 16x)
            polly: 3.50        // updated price per 10k chars
        };

        // Update shop package visible prices from CREDIT_PRICING so prices stay in sync
        (function updateShopPrices() {
            try {
                // Choose which base to use for store pricing (we use openai price per 10k as canonical)
                const storePricePer10k = CREDIT_PRICING.openai ?? Object.values(CREDIT_PRICING)[0];

                document.querySelectorAll('.buy-package-btn').forEach(btn => {
                    const credits = parseInt(btn.getAttribute('data-credits')) || 0;
                    const price = (credits / 10000) * storePricePer10k;
                    const priceFixed = Number(price.toFixed(2));

                    // Update button data-price
                    btn.setAttribute('data-price', priceFixed.toFixed(2));

                    // Update visible price display if present
                    const card = btn.closest('div');
                    // Look for our tagged price element first
                    let display = card && card.querySelector('[data-price-display]');
                    // Fallback: find first large-price element
                    if (!display) display = card && card.querySelector('.text-3xl');
                    if (display) display.textContent = `$${priceFixed.toFixed(2)}`;
                });
            } catch (err) {
                console.warn('updateShopPrices failed', err);
            }
        })();

        function openCostCalculatorModal() {
            if (!featureSettings.costCalculator) {
                alert('‚ö†Ô∏è Kosten-Kalkulator ist deaktiviert. Aktiviere ihn in den Einstellungen.');
                return;
            }
            costCalcModal.classList.remove('hidden');
            updateCostCalculation();
        }

        closeCostCalcBtn.addEventListener('click', () => {
            costCalcModal.classList.add('hidden');
        });

        costCalcModal.addEventListener('click', (e) => {
            if (e.target === costCalcModal) {
                costCalcModal.classList.add('hidden');
            }
        });

        // Set slider value from quick select buttons
        function setCalcSlider(value) {
            calcCharSlider.value = value;
            updateCostCalculation();
        }
        window.setCalcSlider = setCalcSlider;

        // Update calculation when slider moves
        calcCharSlider.addEventListener('input', updateCostCalculation);

        function updateCostCalculation() {
            const chars = parseInt(calcCharSlider.value);
            
            // Update display
            calcCharDisplay.textContent = chars.toLocaleString();
            
            // Calculate duration (assuming ~330 chars per minute for German audiobooks)
            const minutes = Math.round(chars / 330);
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            calcDurationDisplay.textContent = hours > 0 ? `~${hours}h ${mins}min` : `~${mins}min`;
            
            // Calculate costs for each API
            const costs = {};
            const margins = {};
            
            for (const api in API_PRICING) {
                const apiCost = (chars / 1000) * API_PRICING[api]; // Cost per 1k chars
                const userCost = (chars / 10000) * CREDIT_PRICING[api]; // Our price per 10k chars
                const margin = ((userCost - apiCost) / apiCost * 100);
                
                costs[api] = {
                    apiCost: apiCost,
                    userCost: userCost,
                    credits: Math.ceil(chars / 10000), // Credits needed (1 credit = 10k chars)
                    margin: margin
                };
            }
            
            // Find cheapest and most expensive
            const sortedByUserCost = Object.entries(costs).sort((a, b) => a[1].userCost - b[1].userCost);
            const cheapest = sortedByUserCost[0];
            const mostExpensive = sortedByUserCost[sortedByUserCost.length - 1];
            
            // Render table
            const t = translations[currentLang];
            calcCostTableBody.innerHTML = Object.entries(costs).map(([api, data]) => {
                const isCheapest = api === cheapest[0];
                const isMostExpensive = api === mostExpensive[0];
                const rowClass = isCheapest ? 'bg-green-50 dark:bg-green-900/30 border-2 border-green-400 dark:border-green-600' : 
                                 isMostExpensive ? 'bg-red-50 dark:bg-red-900/30 border-2 border-red-400 dark:border-red-600' : 
                                 'border-b border-gray-200 dark:border-gray-700';
                
                // API-spezifische Farben f√ºr Badges
                const apiBadgeColors = {
                    gemini: 'bg-gradient-to-r from-blue-500 to-cyan-500 text-white',
                    openai: 'bg-gradient-to-r from-emerald-500 to-teal-500 text-white',
                    elevenlabs: 'bg-gradient-to-r from-purple-500 to-pink-500 text-white',
                    polly: 'bg-gradient-to-r from-orange-500 to-amber-500 text-white'
                };
                
                return `
                    <tr class="${rowClass}">
                        <td class="py-3 px-4">
                            <span class="${apiBadgeColors[api]} px-3 py-1.5 rounded-lg font-bold text-sm shadow-md inline-block">
                                ${api.toUpperCase()}
                            </span>
                            ${isCheapest ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded-full">' + (t.cost_calc_cheapest || 'G√ºnstigste') + '</span>' : ''}
                            ${isMostExpensive ? '<span class="ml-2 text-xs bg-red-500 text-white px-2 py-1 rounded-full">' + (t.cost_calc_expensive || 'Teuerste') + '</span>' : ''}
                        </td>
                        <td class="py-3 px-4 text-right font-bold ${isCheapest ? 'text-green-700 dark:text-green-400' : isMostExpensive ? 'text-red-700 dark:text-red-400' : 'text-gray-900 dark:text-white'}">
                            $${data.userCost.toFixed(2)}
                        </td>
                        <td class="py-3 px-4 text-right text-gray-700 dark:text-gray-300">
                            ${data.credits}
                        </td>
                        <td class="py-3 px-4 text-right text-sm text-gray-600 dark:text-gray-400">
                            ${data.margin.toFixed(0)}%
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update best deal banner
            const savings = mostExpensive[1].userCost - cheapest[1].userCost;
            const savingsPercent = ((savings / mostExpensive[1].userCost) * 100).toFixed(0);
            calcBestDealText.textContent = `${cheapest[0].toUpperCase()} - ${t.cost_calc_saves || 'Spart dir'} $${savings.toFixed(2)} (${savingsPercent}% ${t.cost_calc_cheaper || 'g√ºnstiger'})`;
        }

        window.openCostCalculatorModal = openCostCalculatorModal;

        // ==================== END COST CALCULATOR MODAL ====================

        // Paket-Kauf Buttons
        document.querySelectorAll('.buy-package-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const packageName = btn.getAttribute('data-package');
                const credits = parseInt(btn.getAttribute('data-credits'));
                const price = parseFloat(btn.getAttribute('data-price'));

                // Disable button w√§hrend der Verarbeitung
                btn.disabled = true;
                btn.innerHTML = '‚è≥ L√§dt...';

                try {
                    // Stripe Checkout Session erstellen
                    await createStripeCheckout(packageName, credits, price);
                } catch (error) {
                    console.error('Stripe Checkout Error:', error);
                    alert('‚ùå Fehler beim √ñffnen der Zahlungsseite. Bitte versuche es sp√§ter erneut.');
                    btn.disabled = false;
                    btn.innerHTML = btn.getAttribute('data-original-text') || 'Jetzt kaufen';
                }
            });
        });

        // Stripe Checkout erstellen
        async function createStripeCheckout(packageName, credits, price) {
            const STRIPE_PAYMENT_LINK_BASE = 'https://buy.stripe.com/test_'; // Dein Stripe Payment Link

            // Mapping f√ºr Stripe Payment Links (diese musst du in Stripe Dashboard erstellen)
            const paymentLinks = {
                'starter': 'DEINE_STRIPE_LINK_ID_1',     // Ersetze mit echtem Link
                'author': 'DEINE_STRIPE_LINK_ID_2',      // Ersetze mit echtem Link
                'bestseller': 'DEINE_STRIPE_LINK_ID_3',  // Ersetze mit echtem Link
                'publisher': 'DEINE_STRIPE_LINK_ID_4'    // Ersetze mit echtem Link
            };

            // F√ºr Demo: Simuliere Zahlung (sp√§ter durch echte Stripe Links ersetzen)
            const useDemo = true; // Setze auf false wenn du echte Stripe Links hast

            if (useDemo) {
                // DEMO-MODUS: Simuliere erfolgreiche Zahlung
                const confirmed = confirm(
                    `üõí ${packageName.toUpperCase()} PAKET\n\n` +
                    `üíé ${credits.toLocaleString('de-DE')} Zeichen\n` +
                    `üí∞ $${price.toFixed(2)}\n\n` +
                    `‚ö†Ô∏è DEMO-MODUS\n` +
                    `In der finalen Version wirst du zu Stripe weitergeleitet.\n\n` +
                    `Credits jetzt hinzuf√ºgen?`
                );
                
                if (confirmed) {
                    addCredits(credits);
                    creditShopModal.classList.add('hidden');
                    
                    // Erfolgs-Meldung
                    alert(`üéâ Erfolgreich!\n\n+${credits.toLocaleString('de-DE')} Zeichen wurden deinem Konto gutgeschrieben!\n\nNeuer Kontostand: ${userCredits.toLocaleString('de-DE')} Zeichen`);
                }
            } else {
                // PRODUKTIV-MODUS: Echte Stripe Weiterleitung
                const stripeLink = paymentLinks[packageName];
                
                if (!stripeLink || stripeLink.includes('DEINE_')) {
                    throw new Error('Stripe Payment Link nicht konfiguriert');
                }

                // Speichere Paket-Info f√ºr Erfolgsseite
                sessionStorage.setItem('pendingCreditPurchase', JSON.stringify({
                    package: packageName,
                    credits: credits,
                    price: price,
                    timestamp: Date.now()
                }));

                // Weiterleitung zu Stripe Checkout
                window.location.href = `${STRIPE_PAYMENT_LINK_BASE}${stripeLink}`;
            }
        }

        // Pr√ºfe bei Seitenladung ob Zahlung erfolgreich war
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentSuccess = urlParams.get('payment_success');
            
            if (paymentSuccess === 'true') {
                const pendingPurchase = sessionStorage.getItem('pendingCreditPurchase');
                
                if (pendingPurchase) {
                    const purchase = JSON.parse(pendingPurchase);
                    addCredits(purchase.credits);
                    sessionStorage.removeItem('pendingCreditPurchase');
                    
                    // Erfolgs-Benachrichtigung
                    setTimeout(() => {
                        alert(`üéâ Zahlung erfolgreich!\n\n+${purchase.credits.toLocaleString('de-DE')} Zeichen wurden gutgeschrieben!\n\nNeuer Kontostand: ${userCredits.toLocaleString('de-DE')} Zeichen`);
                    }, 500);
                    
                    // Entferne URL-Parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            
            // Glow-States initialisieren (MUSS im DOMContentLoaded sein!)
            initializeGlowStates();
            
            // DEBUG block removed: kein erzwungenes Gl√ºhen mehr auf #lang-select-wrapper
        });

        const containerGlowToggle = document.getElementById('toggle-container-glow');
        const inputGlowToggle = document.getElementById('toggle-input-glow');
        const containerGlowStatus = document.getElementById('container-glow-status');
        const inputGlowStatus = document.getElementById('input-glow-status');
        const mainContainer = document.getElementById('main-container');
        
        function getAllGlowingInputs() {
            // Include language select so it uses the same glow behaviour as the API selector
            // Also include our visible custom-select displays so the glow is visible
            return document.querySelectorAll('#lang-select, #api-select, .custom-select-display, .speaker-name, .speaker-voice');
        }

        function initializeGlowStates() {
            const t = translations[currentLang];
            const containerGlowState = localStorage.getItem('containerGlow') ?? 'on';
            mainContainer.classList.toggle('glowing-container-active', containerGlowState === 'on');
            containerGlowStatus.textContent = containerGlowState === 'on' ? t.status_on : t.status_off;

            const inputGlowState = localStorage.getItem('inputGlow') ?? 'on';
            getAllGlowingInputs().forEach(input => {
                input.classList.toggle('input-glowing-active', inputGlowState === 'on');
            });
            inputGlowStatus.textContent = inputGlowState === 'on' ? t.status_on : t.status_off;
        }

        containerGlowToggle.addEventListener('click', () => {
            const t = translations[currentLang];
            const isActive = mainContainer.classList.toggle('glowing-container-active');
            localStorage.setItem('containerGlow', isActive ? 'on' : 'off');
            containerGlowStatus.textContent = isActive ? t.status_on : t.status_off;
        });

        inputGlowToggle.addEventListener('click', () => {
            const t = translations[currentLang];
            const inputs = getAllGlowingInputs();
            const isTurningOn = !inputs[0]?.classList.contains('input-glowing-active');
            inputs.forEach(input => input.classList.toggle('input-glowing-active', isTurningOn));
            localStorage.setItem('inputGlow', isTurningOn ? 'on' : 'off');
            inputGlowStatus.textContent = isTurningOn ? t.status_on : t.status_off;
        });
        
        const PROXY_SERVER_URL = 'https://hoerbuch-proxy-start.workers.dev'; 
        const translations = {
            'de': {
                main_title: 'H√∂rbuch Studio Pro', main_subtitle: 'Erstelle professionelle H√∂rb√ºcher mit mehreren Stimmen.', char_title: '1. Personen & Stimmen', char_name_label: 'Personenname', voice_label: 'Stimme', add_char_button: 'Person hinzuf√ºgen', script_label_part1: 'Skript hier einf√ºgen (Format: ', script_format_text: 'Person: Text...', script_placeholder: 'Erz√§hler: Es var einmal...', convert_button_base: 'In Audio umwandeln', api_select_title: '0. API-Auswahl', api_select_label: 'W√§hle die zu verwendende KI-Plattform:', api_select_hint: 'Du kannst wechseln, wenn eine Anfrage fehlschl√§gt.', gemini_option: 'Google Gemini', openai_option: 'OpenAI ChatGPT', elevenlabs_option: 'ElevenLabs', polly_option: 'Amazon Polly', result_title: 'Dein Ergebnis:', download_base: 'Audio herunterladen', error_no_script: 'Bitte gib zuerst einen Skript-Text ein.', error_no_char: 'Bitte definiere mindestens eine Person.', error_proxy_failed: 'Fehler: Die Kommunikation mit dem Proxy-Server ist fehlgeschlagen.', lang_title: '0.1 Sprache ausw√§hlen', char_name_input_placeholder: 'z.B. Erz√§hler', char_remove_aria: 'Person entfernen', default_speaker_name: 'Erz√§hler', voice_preview_aria: 'Stimme vorh√∂ren', voice_preview_text: 'Hallo, dies ist eine Teststimme.', project_title: 'Projektverwaltung', save_project_button: 'Projekt speichern', load_project_button: 'Projekt laden', project_saved: 'Projekt erfolgreich gespeichert!', project_loaded: 'Projekt erfolgreich geladen!', project_not_found: 'Kein gespeichertes Projekt gefunden.', import_from_script_button: 'Aus Skript importieren', speakers_imported: 'Neue Personen aus dem Skript importiert!', no_new_speakers_found: 'Keine neuen Personen im Skript gefunden.', stats_words: 'W√∂rter', stats_chars: 'Zeichen', stats_duration: 'Dauer',
                drag_handle_aria: 'Person verschieben', char_copy_suffix: '(Kopie)', duplicate_char_aria: 'Person duplizieren', design_title: 'Design-Steuerung',
                tooltip_theme: 'Heller/Dunkler Modus', tooltip_add_char: 'Eine neue Personen-Zeile hinzuf√ºgen', tooltip_import: 'Personen aus dem Skript-Text importieren',
                tooltip_save: 'Aktuelles Projekt im Browser speichern', tooltip_load: 'Zuletzt gespeichertes Projekt laden', tooltip_glow_container: 'Gl√ºheffekt des Rahmens umschalten',
                tooltip_glow_inputs: 'Gl√ºheffekt der Eingabefelder umschalten', tooltip_drag: 'Reihenfolge √§ndern', tooltip_preview: 'Ausgew√§hlte Stimme vorh√∂ren',
                tooltip_duplicate: 'Diese Person duplizieren', tooltip_remove: 'Diese Person entfernen', tooltip_toggle_tooltips: 'Tooltips an-/ausschalten',
                credit_balance_label: 'Dein Guthaben', credit_balance_unit: 'Zeichen', buy_credits_btn: 'Credits kaufen',
                credit_shop_title: 'üíé Credits kaufen', credit_shop_subtitle: 'W√§hle das passende Paket f√ºr deine Projekte',
                pkg_starter: 'STARTER PAKET', pkg_author: 'AUTOR PAKET', pkg_bestseller: 'BESTSELLER PAKET', pkg_publisher: 'VERLAGS PAKET',
                pkg_starter_desc: '10.000 Zeichen (1 Credit)', pkg_author_desc: '100.000 Zeichen (10 Credits)', pkg_bestseller_desc: '300.000 Zeichen (30 Credits)', pkg_publisher_desc: '1.000.000 Zeichen (100 Credits)',
                pkg_badge_bestseller: '‚≠ê BESTSELLER', pkg_badge_best_deal: 'üëë BESTER DEAL',
                pkg_save: 'SPARE', pkg_bonus: '+10% BONUS Credits!',
                pkg_feat_short: 'Perfekt f√ºr Kurzgeschichten', pkg_feat_novella: 'Perfekt f√ºr Novellen', pkg_feat_novel: 'Perfekt f√ºr Romane', pkg_feat_series: 'Perfekt f√ºr Serien/Verlage',
                pkg_feat_all_apis: 'Alle 4 APIs verf√ºgbar', pkg_feat_premium: 'Premium Support', pkg_feat_priority: 'Priority Support', pkg_feat_vip: 'VIP Support 24/7',
                pkg_feat_validity: '365 Tage g√ºltig',
                btn_buy_now: 'Jetzt kaufen',
                shop_footer: 'üîí Sichere Zahlung via Stripe ‚Ä¢ ‚è∞ Credits verfallen nach 365 Tagen',
                shop_tip: 'üí° Tipp: Je gr√∂√üer das Paket, desto mehr sparst du!',
                shop_modal_title: 'üíé Credit Shop',
                shop_modal_subtitle: 'W√§hle dein perfektes Paket',
                credit_balance_label: 'Dein Guthaben',
                credit_balance_unit: 'Zeichen',
                btn_buy_credits: 'Credits kaufen',
                btn_settings: 'Einstellungen',
                settings_title: '‚öôÔ∏è Einstellungen',
                settings_subtitle: 'Passe die Features nach deinen W√ºnschen an',
                settings_features_title: 'Features aktivieren/deaktivieren:',
                setting_voice_preview: 'Stimmen-Vorschau-Modal',
                setting_voice_preview_desc: 'Zeige Modal mit allen verf√ºgbaren Stimmen zum Anh√∂ren',
                setting_cost_calculator: 'Echtzeit-Kosten-Kalkulator',
                setting_cost_calculator_desc: 'Interaktiver Slider zur Projektkosten-Planung',
                setting_live_preview: 'Live Audio-Vorschau',
                setting_live_preview_desc: 'Automatische Vorschau w√§hrend der Eingabe (nach 2 Sek.)',
                setting_project_library: 'Projekt-Bibliothek',
                setting_project_library_desc: 'Visuelle Galerie aller gespeicherten Projekte',
                setting_auto_speaker: 'KI-Sprecher-Erkennung',
                setting_auto_speaker_desc: 'Automatische Sprecher-Zuordnung aus Skript',
                settings_auto_start_label: 'Auto-Start nach Laden',
                settings_auto_start_desc: 'Projekt laden und automatisch die Konvertierung starten (kostenpflichtig)',
                toast_loaded_title: 'Projekt geladen',
                toast_start_now: 'Jetzt konvertieren',
                toast_later: 'Sp√§ter',
                toast_always_label: 'Immer automatisch starten',
                btn_save_settings: 'Einstellungen speichern',
                settings_saved: 'Einstellungen gespeichert!',
                btn_preview_voices: 'üé≠ Stimmen anh√∂ren',
                voice_preview_title: 'üé≠ Stimmen-Vorschau',
                voice_preview_subtitle: 'H√∂re dir alle verf√ºgbaren Stimmen an',
                voice_neutral: 'Neutral',
                voice_male: 'M√§nnlich',
                voice_female: 'Weiblich',
                voice_alloy_desc: 'Vielseitig & ausgeglichen',
                voice_echo_desc: 'Klar & kraftvoll',
                voice_fable_desc: 'Warm & expressiv',
                voice_onyx_desc: 'Tief & markant',
                voice_nova_desc: 'Jung & energisch',
                voice_shimmer_desc: 'Sanft & melodisch',
                btn_play_sample: 'Probe h√∂ren',
                voice_preview_coming_soon: 'Stimmen f√ºr diese API bald verf√ºgbar',
                voice_preview_api_key_required: 'API-Key erforderlich f√ºr Vorschau',
                voice_preview_hint: 'üí° Tipp: Klicke auf "Probe h√∂ren" um einen Demo-Text mit der jeweiligen Stimme zu h√∂ren',
                voice_preview_demo_only: 'Demo-Funktion. Vollst√§ndige API-Integration kommt bald!',
                auto_detect_title: 'ü§ñ KI-Erkennung',
                auto_detect_new_speakers: 'neue Sprecher erkannt',
                live_preview_title: 'Live-Vorschau',
                live_preview_generating: 'Generiere Vorschau...',
                live_preview_chars: 'Zeichen verbraucht',
                btn_cost_calculator: 'Kosten planen',
                cost_calc_title: 'üìä Kosten-Kalkulator',
                cost_calc_subtitle: 'Berechne die Kosten f√ºr dein H√∂rbuch-Projekt',
                cost_calc_chars_label: 'Zeichen-Anzahl:',
                cost_calc_short: 'Kurzgeschichte (10k)',
                cost_calc_novella: 'Novelle (50k)',
                cost_calc_novel: 'Roman (100k)',
                cost_calc_epic: 'Epos (300k)',
                cost_calc_duration: 'Gesch√§tzte Dauer:',
                cost_calc_reading_speed: 'Lesegeschwindigkeit:',
                cost_calc_api: 'API',
                cost_calc_cost_usd: 'Kosten (USD)',
                cost_calc_credits: 'Credits',
                cost_calc_margin: 'Marge',
                cost_calc_cheapest: 'G√ºnstigste',
                cost_calc_expensive: 'Teuerste',
                cost_calc_best_choice: 'üèÜ Beste Wahl:',
                cost_calc_saves: 'Spart dir',
                cost_calc_cheaper: 'g√ºnstiger',
                cost_calc_hint: 'üí° Tipp: Verwende den Slider um verschiedene Projektgr√∂√üen zu kalkulieren',
                btn_my_projects: 'Meine Projekte',
                btn_save_project: 'üíæ Projekt speichern',
                library_title: 'üìö Meine H√∂rbuch-Projekte',
                library_search_placeholder: 'Projekte durchsuchen...',
                library_sort_newest: 'Neueste zuerst',
                library_sort_oldest: '√Ñlteste zuerst',
                library_sort_largest: 'Gr√∂√üte zuerst',
                library_sort_smallest: 'Kleinste zuerst',
                library_sort_alphabetical: 'Alphabetisch',
                library_characters: 'Zeichen',
                library_speakers: 'Sprecher',
                library_status_completed: 'Komplett',
                library_status_draft: 'Entwurf',
                library_duration_min: 'Min',
                library_btn_load: 'Laden',
                library_btn_delete: 'L√∂schen',
                library_btn_new: 'Neues Projekt erstellen',
                library_empty: 'Noch keine Projekte gespeichert',
                library_empty_hint: 'Erstelle dein erstes H√∂rbuch und speichere es!',
                library_delete_confirm: 'Projekt wirklich l√∂schen?',
                library_delete_warning: 'Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!',
                library_project_loaded: 'Projekt geladen!',
                library_project_deleted: 'Projekt gel√∂scht!',
                library_chars: 'Zeichen',
                library_speakers: 'Sprecher',
                library_load_confirm: 'Aktuelles Projekt wird √ºberschrieben. Fortfahren?',
                library_new_confirm: 'Neues Projekt starten? (Aktuelles wird nicht gespeichert)',
                save_project_prompt: 'Projektnamen eingeben:',
                save_project_success: 'Projekt gespeichert!',
                package_starter: 'Starter', package_author: 'Autor', package_bestseller: 'Bestseller', package_publisher: 'Verlags',
                badge_bestseller: 'Bestseller', badge_best_deal: 'Bestes Angebot', badge_bonus: 'Bonus',
                feature_chars: 'Zeichen', feature_discount: 'Rabatt', feature_instant: 'Sofort verf√ºgbar', feature_all_apis: 'Alle APIs nutzbar',
                buy_package_btn: 'Jetzt kaufen', credit_insufficient: 'Nicht genug Credits!', credit_required: 'Ben√∂tigt', credit_current: 'Dein Guthaben', credit_missing: 'Fehlend',
                credit_buy_now: 'M√∂chtest du jetzt Credits kaufen?',
                templates_title: '‚ö° Schnell-Vorlagen', templates_subtitle: 'Starte schnell mit vorgefertigten Szenarien:',
                glow_container_label: 'Rand-Gl√ºhen:', glow_input_label: 'Feld-Gl√ºhen:', tooltips_label: 'Infos:', status_on: 'An', status_off: 'Aus',
                template_fairytale: 'üìö M√§rchen', template_podcast: 'üéôÔ∏è Podcast', template_novel: 'üìñ Roman', template_dialog: 'üí¨ Dialog',
                clear_all_button: 'Alle l√∂schen', script_title: '2. Skript',
                cost_title: 'üí∞ Gesch√§tzte Kosten:', time_estimate_label: '‚è±Ô∏è Gesch√§tzte Zeit:',
                pricing_table_title: 'üìä Credit-Preise (Optimierte Gewinnmarge):', pricing_api: 'API',
                pricing_10k: '10.000 Zeichen', pricing_100k: '100.000 Zeichen', pricing_300k: '300.000 Zeichen', pricing_novel: '(Roman)',
                templates: {
                    fairytale: {
                        speakers: [
                            { name: 'Erz√§hler', voice: 'nova' },
                            { name: 'Prinzessin', voice: 'shimmer' },
                            { name: 'Drache', voice: 'onyx' }
                        ],
                        script: `Erz√§hler: Es war einmal in einem fernen K√∂nigreich eine wundersch√∂ne Prinzessin.
Prinzessin: Ich tr√§ume davon, die Welt zu erkunden und Abenteuer zu erleben!
Erz√§hler: Eines Tages erschien ein furchteinfl√∂√üender Drache am Horizont.
Drache: Wer wagt es, mein Territorium zu betreten?
Prinzessin: Ich habe keine Angst vor dir! Lass uns Freunde werden statt zu k√§mpfen.
Erz√§hler: Und so begann eine ungew√∂hnliche Freundschaft...`
                    },
                    podcast: {
                        speakers: [
                            { name: 'Moderator', voice: 'echo' },
                            { name: 'Gast', voice: 'fable' }
                        ],
                        script: `Moderator: Willkommen zu unserem Podcast! Heute haben wir einen besonderen Gast.
Gast: Vielen Dank f√ºr die Einladung! Ich freue mich sehr, hier zu sein.
Moderator: Erz√§hlen Sie uns doch, wie alles begann.
Gast: Es war im Sommer 2020, als ich die Idee hatte...
Moderator: Faszinierend! Was waren die gr√∂√üten Herausforderungen?
Gast: Die gr√∂√üte Herausforderung war definitiv die Anfangsphase.`
                    },
                    novel: {
                        speakers: [
                            { name: 'Erz√§hler', voice: 'alloy' },
                            { name: 'Protagonist', voice: 'nova' },
                            { name: 'Antagonist', voice: 'onyx' },
                            { name: 'Mentor', voice: 'echo' },
                            { name: 'Freund', voice: 'fable' }
                        ],
                        script: `Erz√§hler: Die Sonne ging √ºber der Stadt unter, als unsere Geschichte beginnt.
Protagonist: Ich wusste, dass heute alles anders werden w√ºrde.
Mentor: Du hast das Potenzial, Gro√ües zu erreichen. Aber der Weg wird nicht einfach sein.
Freund: Ich stehe an deiner Seite, egal was kommt!
Antagonist: Sie werden alle scheitern. Diese Stadt geh√∂rt mir.
Erz√§hler: Und so begann der Kampf zwischen Licht und Dunkelheit...`
                    },
                    dialog: {
                        speakers: [
                            { name: 'Person A', voice: 'shimmer' },
                            { name: 'Person B', voice: 'alloy' }
                        ],
                        script: `Person A: Hast du schon von dem neuen Projekt geh√∂rt?
Person B: Ja, klingt wirklich spannend! Wann geht es los?
Person A: N√§chste Woche. Bist du dabei?
Person B: Auf jeden Fall! Lass uns das zusammen angehen.
Person A: Perfekt! Ich freue mich schon darauf.
Person B: Ich auch. Das wird gro√üartig!`
                    }
                },
            },
            'en': {
                main_title: 'Audiobook Studio Pro', main_subtitle: 'Create professional audiobooks with multiple voices.', char_title: '1. Characters & Voices', char_name_label: 'Character Name', voice_label: 'Voice', add_char_button: 'Add Character', script_label_part1: 'Paste script here (Format: ', script_format_text: 'Character: Text...', script_placeholder: 'Narrator: Once upon a time...', convert_button_base: 'Convert to Audio', api_select_title: '0. API Selection', api_select_label: 'Choose the AI platform to use:', api_select_hint: 'You can switch if a request fails.', gemini_option: 'Google Gemini', openai_option: 'OpenAI ChatGPT', elevenlabs_option: 'ElevenLabs', polly_option: 'Amazon Polly', result_title: 'Your Result:', download_base: 'Download Audio', error_no_script: 'Please enter a script text first.', error_no_char: 'Please define at least one character.', error_proxy_failed: 'Error: Communication with the proxy server failed.', lang_title: '0.1 Select Language', char_name_input_placeholder: 'e.g. Narrator', char_remove_aria: 'Remove character', default_speaker_name: 'Narrator', voice_preview_aria: 'Preview voice', voice_preview_text: 'Hello, this is a test voice.', project_title: 'Project Management', save_project_button: 'Save Project', load_project_button: 'Load Project', project_saved: 'Project saved successfully!', project_loaded: 'Project loaded successfully!', project_not_found: 'No saved project found.', import_from_script_button: 'Import from Script', speakers_imported: 'Imported new characters from script!', no_new_speakers_found: 'No new characters found in script.', stats_words: 'Words', stats_chars: 'Characters', stats_duration: 'Duration',
                drag_handle_aria: 'Move character', char_copy_suffix: '(Copy)', duplicate_char_aria: 'Duplicate character', design_title: 'Design Controls',
                tooltip_theme: 'Toggle Light/Dark Mode', tooltip_add_char: 'Add a new character row', tooltip_import: 'Import characters from the script text',
                tooltip_save: 'Save current project in the browser', tooltip_load: 'Load the last saved project', tooltip_glow_container: 'Toggle container glow effect',
                tooltip_glow_inputs: 'Toggle input fields glow effect', tooltip_drag: 'Change order', tooltip_preview: 'Preview selected voice',
                tooltip_duplicate: 'Duplicate this character', tooltip_remove: 'Remove this character', tooltip_toggle_tooltips: 'Toggle tooltips on/off',
                credit_balance_label: 'Your Balance', credit_balance_unit: 'Characters', buy_credits_btn: 'Buy Credits',
                credit_shop_title: 'üíé Buy Credits', credit_shop_subtitle: 'Choose the perfect package for your projects',
                pkg_starter: 'STARTER PACKAGE', pkg_author: 'AUTHOR PACKAGE', pkg_bestseller: 'BESTSELLER PACKAGE', pkg_publisher: 'PUBLISHER PACKAGE',
                pkg_starter_desc: '10,000 Characters (1 Credit)', pkg_author_desc: '100,000 Characters (10 Credits)', pkg_bestseller_desc: '300,000 Characters (30 Credits)', pkg_publisher_desc: '1,000,000 Characters (100 Credits)',
                pkg_badge_bestseller: '‚≠ê BESTSELLER', pkg_badge_best_deal: 'üëë BEST DEAL',
                pkg_save: 'SAVE', pkg_bonus: '+10% BONUS Credits!',
                pkg_feat_short: 'Perfect for Short Stories', pkg_feat_novella: 'Perfect for Novellas', pkg_feat_novel: 'Perfect for Novels', pkg_feat_series: 'Perfect for Series/Publishers',
                pkg_feat_all_apis: 'All 4 APIs Available', pkg_feat_premium: 'Premium Support', pkg_feat_priority: 'Priority Support', pkg_feat_vip: 'VIP Support 24/7',
                pkg_feat_validity: '365 Days Valid',
                btn_buy_now: 'Buy Now',
                shop_footer: 'üîí Secure Payment via Stripe ‚Ä¢ ‚è∞ Credits expire after 365 days',
                shop_tip: 'üí° Tip: The bigger the package, the more you save!',
                shop_modal_title: 'üíé Credit Shop',
                shop_modal_subtitle: 'Choose your perfect package',
                credit_balance_label: 'Your Balance',
                credit_balance_unit: 'Characters',
                btn_buy_credits: 'Buy Credits',
                btn_settings: 'Settings',
                settings_title: '‚öôÔ∏è Settings',
                settings_subtitle: 'Customize features to your preferences',
                settings_features_title: 'Enable/Disable Features:',
                setting_voice_preview: 'Voice Preview Modal',
                setting_voice_preview_desc: 'Show modal with all available voices to listen',
                setting_cost_calculator: 'Real-time Cost Calculator',
                setting_cost_calculator_desc: 'Interactive slider for project cost planning',
                setting_live_preview: 'Live Audio Preview',
                setting_live_preview_desc: 'Automatic preview while typing (after 2 sec)',
                setting_project_library: 'Project Library',
                setting_project_library_desc: 'Visual gallery of all saved projects',
                setting_auto_speaker: 'AI Speaker Detection',
                setting_auto_speaker_desc: 'Automatic speaker assignment from script',
                settings_auto_start_label: 'Auto-start after load',
                settings_auto_start_desc: 'When enabled, loading a project will automatically begin conversion (may consume credits)',
                toast_loaded_title: 'Project loaded',
                toast_start_now: 'Start now',
                toast_later: 'Later',
                toast_always_label: 'Always start automatically',
                btn_save_settings: 'Save Settings',
                settings_saved: 'Settings saved!',
                btn_preview_voices: 'üé≠ Preview Voices',
                voice_preview_title: 'üé≠ Voice Preview',
                voice_preview_subtitle: 'Listen to all available voices',
                voice_neutral: 'Neutral',
                voice_male: 'Male',
                voice_female: 'Female',
                voice_alloy_desc: 'Versatile & balanced',
                voice_echo_desc: 'Clear & powerful',
                voice_fable_desc: 'Warm & expressive',
                voice_onyx_desc: 'Deep & distinctive',
                voice_nova_desc: 'Young & energetic',
                voice_shimmer_desc: 'Soft & melodic',
                btn_play_sample: 'Play Sample',
                voice_preview_coming_soon: 'Voices for this API coming soon',
                voice_preview_api_key_required: 'API key required for preview',
                voice_preview_hint: 'üí° Tip: Click "Play Sample" to hear a demo text with the respective voice',
                voice_preview_demo_only: 'Demo function. Full API integration coming soon!',
                auto_detect_title: 'ü§ñ AI Detection',
                auto_detect_new_speakers: 'new speakers detected',
                live_preview_title: 'Live Preview',
                live_preview_generating: 'Generating preview...',
                live_preview_chars: 'characters used',
                btn_cost_calculator: 'Plan Costs',
                cost_calc_title: 'üìä Cost Calculator',
                cost_calc_subtitle: 'Calculate costs for your audiobook project',
                cost_calc_chars_label: 'Character Count:',
                cost_calc_short: 'Short Story (10k)',
                cost_calc_novella: 'Novella (50k)',
                cost_calc_novel: 'Novel (100k)',
                cost_calc_epic: 'Epic (300k)',
                cost_calc_duration: 'Estimated Duration:',
                cost_calc_reading_speed: 'Reading Speed:',
                cost_calc_api: 'API',
                cost_calc_cost_usd: 'Cost (USD)',
                cost_calc_credits: 'Credits',
                cost_calc_margin: 'Margin',
                cost_calc_cheapest: 'Cheapest',
                cost_calc_expensive: 'Most Expensive',
                cost_calc_best_choice: 'üèÜ Best Choice:',
                cost_calc_saves: 'Saves you',
                cost_calc_cheaper: 'cheaper',
                cost_calc_hint: 'üí° Tip: Use the slider to calculate different project sizes',
                btn_my_projects: 'My Projects',
                btn_save_project: 'üíæ Save Project',
                library_title: 'üìö My Audiobook Projects',
                library_search_placeholder: 'Search projects...',
                library_sort_newest: 'Newest first',
                library_sort_oldest: 'Oldest first',
                library_sort_largest: 'Largest first',
                library_sort_smallest: 'Smallest first',
                library_sort_alphabetical: 'Alphabetical',
                library_characters: 'Characters',
                library_speakers: 'Speakers',
                library_status_completed: 'Completed',
                library_status_draft: 'Draft',
                library_duration_min: 'Min',
                library_btn_load: 'Load',
                library_btn_delete: 'Delete',
                library_btn_new: 'Create New Project',
                library_empty: 'No projects saved yet',
                library_empty_hint: 'Create your first audiobook and save it!',
                library_delete_confirm: 'Really delete this project?',
                library_delete_warning: 'This action cannot be undone!',
                library_project_loaded: 'Project loaded!',
                library_project_deleted: 'Project deleted!',
                library_chars: 'Characters',
                library_speakers: 'Speakers',
                library_load_confirm: 'Current project will be overwritten. Continue?',
                library_new_confirm: 'Start new project? (Current will not be saved)',
                save_project_prompt: 'Enter project name:',
                save_project_success: 'Project saved!',
                package_starter: 'Starter', package_author: 'Author', package_bestseller: 'Bestseller', package_publisher: 'Publisher',
                badge_bestseller: 'Bestseller', badge_best_deal: 'Best Deal', badge_bonus: 'Bonus',
                feature_chars: 'Characters', feature_discount: 'Discount', feature_instant: 'Instant Access', feature_all_apis: 'All APIs available',
                buy_package_btn: 'Buy Now', credit_insufficient: 'Not enough credits!', credit_required: 'Required', credit_current: 'Your Balance', credit_missing: 'Missing',
                credit_buy_now: 'Would you like to buy credits now?',
                templates_title: '‚ö° Quick Templates', templates_subtitle: 'Get started quickly with ready-made scenarios:',
                glow_container_label: 'Border Glow:', glow_input_label: 'Field Glow:', tooltips_label: 'Tooltips:', status_on: 'On', status_off: 'Off',
                template_fairytale: 'üìö Fairy Tale', template_podcast: 'üéôÔ∏è Podcast', template_novel: 'üìñ Novel', template_dialog: 'üí¨ Dialog',
                clear_all_button: 'Clear All', script_title: '2. Script',
                cost_title: 'üí∞ Estimated Cost:', time_estimate_label: '‚è±Ô∏è Estimated Time:',
                pricing_table_title: 'üìä Credit Prices (Optimized Margin):', pricing_api: 'API',
                pricing_10k: '10,000 Characters', pricing_100k: '100,000 Characters', pricing_300k: '300,000 Characters', pricing_novel: '(Novel)',
                templates: {
                    fairytale: {
                        speakers: [
                            { name: 'Narrator', voice: 'nova' },
                            { name: 'Princess', voice: 'shimmer' },
                            { name: 'Dragon', voice: 'onyx' }
                        ],
                        script: `Narrator: Once upon a time in a distant kingdom, there lived a beautiful princess.
Princess: I dream of exploring the world and having adventures!
Narrator: One day, a fearsome dragon appeared on the horizon.
Dragon: Who dares to enter my territory?
Princess: I'm not afraid of you! Let's be friends instead of fighting.
Narrator: And so began an unusual friendship...`
                    },
                    podcast: {
                        speakers: [
                            { name: 'Host', voice: 'echo' },
                            { name: 'Guest', voice: 'fable' }
                        ],
                        script: `Host: Welcome to our podcast! Today we have a very special guest.
Guest: Thank you so much for having me! I'm really excited to be here.
Host: Tell us how it all began.
Guest: It was in the summer of 2020 when I had the idea...
Host: Fascinating! What were the biggest challenges?
Guest: The biggest challenge was definitely the initial phase.`
                    },
                    novel: {
                        speakers: [
                            { name: 'Narrator', voice: 'alloy' },
                            { name: 'Protagonist', voice: 'nova' },
                            { name: 'Antagonist', voice: 'onyx' },
                            { name: 'Mentor', voice: 'echo' },
                            { name: 'Friend', voice: 'fable' }
                        ],
                        script: `Narrator: The sun was setting over the city as our story begins.
Protagonist: I knew that today everything would change.
Mentor: You have the potential to achieve greatness. But the path won't be easy.
Friend: I'll stand by your side, no matter what comes!
Antagonist: They will all fail. This city belongs to me.
Narrator: And so began the battle between light and darkness...`
                    },
                    dialog: {
                        speakers: [
                            { name: 'Person A', voice: 'shimmer' },
                            { name: 'Person B', voice: 'alloy' }
                        ],
                        script: `Person A: Have you heard about the new project?
Person B: Yes, sounds really exciting! When does it start?
Person A: Next week. Are you in?
Person B: Absolutely! Let's do this together.
Person A: Perfect! I'm looking forward to it.
Person B: Me too. This is going to be great!`
                    }
                },
            },
            'es': {
                main_title: 'Estudio de Audiolibros Pro', main_subtitle: 'Crea audiolibros profesionales con m√∫ltiples voces.', char_title: '1. Personajes y Voces', char_name_label: 'Nombre del Personaje', voice_label: 'Voz', add_char_button: 'A√±adir Personaje', script_label_part1: 'Pega el guion aqu√≠ (Formato: ', script_format_text: 'Personaje: Texto...', script_placeholder: 'Narrador: √ârase una vez...', convert_button_base: 'Convertir a Audio', api_select_title: '0. Selecci√≥n de API', api_select_label: 'Elige la plataforma de IA a utilizar:', api_select_hint: 'Puedes cambiar si una solicitud falla.', gemini_option: 'Google Gemini', openai_option: 'OpenAI ChatGPT', elevenlabs_option: 'ElevenLabs', polly_option: 'Amazon Polly', result_title: 'Tu Resultado:', download_base: 'Descargar Audio', error_no_script: 'Por favor, introduce primero un texto de guion.', error_no_char: 'Por favor, define al menos un personaje.', error_proxy_failed: 'Error: La comunicaci√≥n con el servidor proxy ha fallado.', lang_title: '0.1 Seleccionar Idioma', char_name_input_placeholder: 'p.ej. Narrador', char_remove_aria: 'Eliminar personaje', default_speaker_name: 'Narrador', voice_preview_aria: 'Previsualizar voz', voice_preview_text: 'Hola, esta es una voz de prueba.', project_title: 'Gesti√≥n de Proyectos', save_project_button: 'Guardar Proyecto', load_project_button: 'Cargar Proyecto', project_saved: '¬°Proyecto guardado con √©xito!', project_loaded: '¬°Proyecto cargado con √©xito!', project_not_found: 'No se encontr√≥ ning√∫n proyecto guardado.', import_from_script_button: 'Importar desde el guion', speakers_imported: '¬°Nuevos personajes importados del guion!', no_new_speakers_found: 'No se encontraron nuevos personajes en el guion.', stats_words: 'Palabras', stats_chars: 'Caracteres', stats_duration: 'Duraci√≥n',
                drag_handle_aria: 'Mover personaje', char_copy_suffix: '(Copia)', duplicate_char_aria: 'Duplicar personaje', design_title: 'Controles de Dise√±o',
                tooltip_theme: 'Alternar Modo Claro/Oscuro', tooltip_add_char: 'A√±adir una nueva fila de personaje', tooltip_import: 'Importar personajes desde el texto del guion',
                tooltip_save: 'Guardar proyecto actual en el navegador', tooltip_load: 'Cargar el √∫ltimo proyecto guardado', tooltip_glow_container: 'Alternar efecto de brillo del contenedor',
                tooltip_glow_inputs: 'Alternar efecto de brillo de los campos de entrada', tooltip_drag: 'Cambiar orden', tooltip_preview: 'Previsualizar voz seleccionada',
                tooltip_duplicate: 'Duplicar este personaje', tooltip_remove: 'Eliminar este personaje', tooltip_toggle_tooltips: 'Activar/desactivar informaci√≥n sobre herramientas',
                credit_balance_label: 'Tu Saldo', credit_balance_unit: 'Caracteres', buy_credits_btn: 'Comprar Cr√©ditos',
                credit_shop_title: 'üíé Comprar Cr√©ditos', credit_shop_subtitle: 'Elige el paquete perfecto para tus proyectos',
                pkg_starter: 'PAQUETE INICIAL', pkg_author: 'PAQUETE AUTOR', pkg_bestseller: 'PAQUETE BESTSELLER', pkg_publisher: 'PAQUETE EDITORIAL',
                pkg_starter_desc: '10,000 Caracteres (1 Cr√©dito)', pkg_author_desc: '100,000 Caracteres (10 Cr√©ditos)', pkg_bestseller_desc: '300,000 Caracteres (30 Cr√©ditos)', pkg_publisher_desc: '1,000,000 Caracteres (100 Cr√©ditos)',
                pkg_badge_bestseller: '‚≠ê BESTSELLER', pkg_badge_best_deal: 'üëë MEJOR OFERTA',
                pkg_save: 'AHORRA', pkg_bonus: '¬°+10% Cr√©ditos BONUS!',
                pkg_feat_short: 'Perfecto para Cuentos Cortos', pkg_feat_novella: 'Perfecto para Novelas Cortas', pkg_feat_novel: 'Perfecto para Novelas', pkg_feat_series: 'Perfecto para Series/Editoriales',
                pkg_feat_all_apis: 'Todas las 4 APIs Disponibles', pkg_feat_premium: 'Soporte Premium', pkg_feat_priority: 'Soporte Prioritario', pkg_feat_vip: 'Soporte VIP 24/7',
                pkg_feat_validity: 'V√°lido 365 D√≠as',
                btn_buy_now: 'Comprar Ahora',
                shop_footer: 'üîí Pago Seguro v√≠a Stripe ‚Ä¢ ‚è∞ Los cr√©ditos caducan despu√©s de 365 d√≠as',
                shop_tip: 'üí° Consejo: ¬°Cuanto m√°s grande el paquete, m√°s ahorras!',
                shop_modal_title: 'üíé Tienda de Cr√©ditos',
                shop_modal_subtitle: 'Elige tu paquete perfecto',
                credit_balance_label: 'Tu Saldo',
                credit_balance_unit: 'Caracteres',
                btn_buy_credits: 'Comprar Cr√©ditos',
                btn_settings: 'Configuraci√≥n',
                settings_title: '‚öôÔ∏è Configuraci√≥n',
                settings_subtitle: 'Personaliza las funciones seg√∫n tus preferencias',
                settings_features_title: 'Activar/Desactivar Funciones:',
                setting_voice_preview: 'Modal de Vista Previa de Voz',
                setting_voice_preview_desc: 'Mostrar modal con todas las voces disponibles',
                setting_cost_calculator: 'Calculadora de Costos en Tiempo Real',
                setting_cost_calculator_desc: 'Slider interactivo para planificaci√≥n de costos',
                setting_live_preview: 'Vista Previa de Audio en Vivo',
                setting_live_preview_desc: 'Vista previa autom√°tica al escribir (despu√©s de 2 seg)',
                setting_project_library: 'Biblioteca de Proyectos',
                setting_project_library_desc: 'Galer√≠a visual de todos los proyectos guardados',
                setting_auto_speaker: 'Detecci√≥n de Hablantes por IA',
                setting_auto_speaker_desc: 'Asignaci√≥n autom√°tica de hablantes desde el guion',
                settings_auto_start_label: 'Inicio autom√°tico al cargar',
                settings_auto_start_desc: 'Al activar, cargar un proyecto iniciar√° autom√°ticamente la conversi√≥n (puede consumir cr√©ditos)',
                toast_loaded_title: 'Proyecto cargado',
                toast_start_now: 'Iniciar ahora',
                toast_later: 'M√°s tarde',
                toast_always_label: 'Iniciar siempre autom√°ticamente',
                btn_save_settings: 'Guardar Configuraci√≥n',
                settings_saved: '¬°Configuraci√≥n guardada!',
                btn_preview_voices: 'üé≠ Escuchar Voces',
                voice_preview_title: 'üé≠ Vista Previa de Voces',
                voice_preview_subtitle: 'Escucha todas las voces disponibles',
                voice_neutral: 'Neutral',
                voice_male: 'Masculino',
                voice_female: 'Femenino',
                voice_alloy_desc: 'Vers√°til y equilibrada',
                voice_echo_desc: 'Clara y potente',
                voice_fable_desc: 'C√°lida y expresiva',
                voice_onyx_desc: 'Profunda y distintiva',
                voice_nova_desc: 'Joven y en√©rgica',
                voice_shimmer_desc: 'Suave y mel√≥dica',
                btn_play_sample: 'Escuchar Muestra',
                voice_preview_coming_soon: 'Voces para esta API pr√≥ximamente',
                voice_preview_api_key_required: 'Se requiere clave API para vista previa',
                voice_preview_hint: 'üí° Consejo: Haz clic en "Escuchar Muestra" para o√≠r un texto de demostraci√≥n con la voz respectiva',
                voice_preview_demo_only: 'Funci√≥n demo. ¬°Integraci√≥n API completa pr√≥ximamente!',
                auto_detect_title: 'ü§ñ Detecci√≥n IA',
                auto_detect_new_speakers: 'nuevos narradores detectados',
                live_preview_title: 'Vista Previa en Vivo',
                live_preview_generating: 'Generando vista previa...',
                live_preview_chars: 'caracteres usados',
                btn_cost_calculator: 'Planificar Costos',
                cost_calc_title: 'üìä Calculadora de Costos',
                cost_calc_subtitle: 'Calcula los costos de tu proyecto de audiolibro',
                cost_calc_chars_label: 'N√∫mero de Caracteres:',
                cost_calc_short: 'Cuento Corto (10k)',
                cost_calc_novella: 'Novela Corta (50k)',
                cost_calc_novel: 'Novela (100k)',
                cost_calc_epic: '√âpica (300k)',
                cost_calc_duration: 'Duraci√≥n Estimada:',
                cost_calc_reading_speed: 'Velocidad de Lectura:',
                cost_calc_api: 'API',
                cost_calc_cost_usd: 'Costo (USD)',
                cost_calc_credits: 'Cr√©ditos',
                cost_calc_margin: 'Margen',
                cost_calc_cheapest: 'M√°s Barato',
                cost_calc_expensive: 'M√°s Caro',
                cost_calc_best_choice: 'üèÜ Mejor Opci√≥n:',
                cost_calc_saves: 'Ahorras',
                cost_calc_cheaper: 'm√°s barato',
                cost_calc_hint: 'üí° Consejo: Usa el deslizador para calcular diferentes tama√±os de proyecto',
                btn_my_projects: 'Mis Proyectos',
                btn_save_project: 'üíæ Guardar Proyecto',
                library_title: 'üìö Mis Proyectos de Audiolibros',
                library_search_placeholder: 'Buscar proyectos...',
                library_sort_newest: 'M√°s recientes primero',
                library_sort_oldest: 'M√°s antiguos primero',
                library_sort_largest: 'M√°s grandes primero',
                library_sort_smallest: 'M√°s peque√±os primero',
                library_sort_alphabetical: 'Alfab√©tico',
                library_characters: 'Caracteres',
                library_speakers: 'Hablantes',
                library_status_completed: 'Completado',
                library_status_draft: 'Borrador',
                library_duration_min: 'Min',
                library_btn_load: 'Cargar',
                library_btn_delete: 'Eliminar',
                library_btn_new: 'Crear Nuevo Proyecto',
                library_empty: 'A√∫n no hay proyectos guardados',
                library_empty_hint: '¬°Crea tu primer audiolibro y gu√°rdalo!',
                library_delete_confirm: '¬øRealmente eliminar este proyecto?',
                library_delete_warning: '¬°Esta acci√≥n no se puede deshacer!',
                library_project_loaded: '¬°Proyecto cargado!',
                library_project_deleted: '¬°Proyecto eliminado!',
                library_chars: 'Caracteres',
                library_speakers: 'Narradores',
                library_load_confirm: 'El proyecto actual ser√° sobrescrito. ¬øContinuar?',
                library_new_confirm: '¬øIniciar nuevo proyecto? (El actual no se guardar√°)',
                save_project_prompt: 'Ingresa el nombre del proyecto:',
                save_project_success: '¬°Proyecto guardado!',
                package_starter: 'Inicial', package_author: 'Autor', package_bestseller: 'Bestseller', package_publisher: 'Editorial',
                badge_bestseller: 'M√°s Vendido', badge_best_deal: 'Mejor Oferta', badge_bonus: 'Bonus',
                feature_chars: 'Caracteres', feature_discount: 'Descuento', feature_instant: 'Acceso Instant√°neo', feature_all_apis: 'Todas las APIs disponibles',
                buy_package_btn: 'Comprar Ahora', credit_insufficient: '¬°No hay suficientes cr√©ditos!', credit_required: 'Requerido', credit_current: 'Tu Saldo', credit_missing: 'Faltante',
                credit_buy_now: '¬øQuieres comprar cr√©ditos ahora?',
                templates_title: '‚ö° Plantillas R√°pidas', templates_subtitle: 'Comienza r√°pidamente con escenarios predefinidos:',
                glow_container_label: 'Brillo de Borde:', glow_input_label: 'Brillo de Campo:', tooltips_label: 'Informaci√≥n:', status_on: 'Activado', status_off: 'Desactivado',
                template_fairytale: 'üìö Cuento de Hadas', template_podcast: 'üéôÔ∏è Podcast', template_novel: 'üìñ Novela', template_dialog: 'üí¨ Di√°logo',
                clear_all_button: 'Borrar Todo', script_title: '2. Guion',
                cost_title: 'üí∞ Costo Estimado:', time_estimate_label: '‚è±Ô∏è Tiempo Estimado:',
                pricing_table_title: 'üìä Precios de Cr√©ditos (Margen Optimizado):', pricing_api: 'API',
                pricing_10k: '10,000 Caracteres', pricing_100k: '100,000 Caracteres', pricing_300k: '300,000 Caracteres', pricing_novel: '(Novela)',
                templates: {
                    fairytale: {
                        speakers: [
                            { name: 'Narrador', voice: 'nova' },
                            { name: 'Princesa', voice: 'shimmer' },
                            { name: 'Drag√≥n', voice: 'onyx' }
                        ],
                        script: `Narrador: √ârase una vez en un reino lejano, una hermosa princesa.
Princesa: ¬°Sue√±o con explorar el mundo y vivir aventuras!
Narrador: Un d√≠a, un drag√≥n aterrador apareci√≥ en el horizonte.
Drag√≥n: ¬øQui√©n se atreve a entrar en mi territorio?
Princesa: ¬°No te tengo miedo! Seamos amigos en lugar de luchar.
Narrador: Y as√≠ comenz√≥ una amistad inusual...`
                    },
                    podcast: {
                        speakers: [
                            { name: 'Presentador', voice: 'echo' },
                            { name: 'Invitado', voice: 'fable' }
                        ],
                        script: `Presentador: ¬°Bienvenidos a nuestro podcast! Hoy tenemos un invitado muy especial.
Invitado: ¬°Muchas gracias por recibirme! Estoy muy emocionado de estar aqu√≠.
Presentador: Cu√©ntanos c√≥mo empez√≥ todo.
Invitado: Fue en el verano de 2020 cuando tuve la idea...
Presentador: ¬°Fascinante! ¬øCu√°les fueron los mayores desaf√≠os?
Invitado: El mayor desaf√≠o fue definitivamente la fase inicial.`
                    },
                    novel: {
                        speakers: [
                            { name: 'Narrador', voice: 'alloy' },
                            { name: 'Protagonista', voice: 'nova' },
                            { name: 'Antagonista', voice: 'onyx' },
                            { name: 'Mentor', voice: 'echo' },
                            { name: 'Amigo', voice: 'fable' }
                        ],
                        script: `Narrador: El sol se pon√≠a sobre la ciudad mientras comienza nuestra historia.
Protagonista: Sab√≠a que hoy todo cambiar√≠a.
Mentor: Tienes el potencial para lograr grandes cosas. Pero el camino no ser√° f√°cil.
Amigo: ¬°Estar√© a tu lado, pase lo que pase!
Antagonista: Todos fracasar√°n. Esta ciudad me pertenece.
Narrador: Y as√≠ comenz√≥ la batalla entre la luz y la oscuridad...`
                    },
                    dialog: {
                        speakers: [
                            { name: 'Persona A', voice: 'shimmer' },
                            { name: 'Persona B', voice: 'alloy' }
                        ],
                        script: `Persona A: ¬øHas o√≠do hablar del nuevo proyecto?
Persona B: S√≠, ¬°suena muy emocionante! ¬øCu√°ndo empieza?
Persona A: La pr√≥xima semana. ¬øEst√°s dentro?
Persona B: ¬°Por supuesto! Hag√°moslo juntos.
Persona A: ¬°Perfecto! Ya estoy deseando que llegue.
Persona B: Yo tambi√©n. ¬°Esto va a ser genial!`
                    }
                },
            },
            'zh': {
                main_title: 'ÊúâÂ£∞‰π¶Â∑•‰ΩúÂÆ§‰∏ì‰∏öÁâà', main_subtitle: 'Áî®Â§öÁßçÂ£∞Èü≥Âàõ‰Ωú‰∏ì‰∏öÊúâÂ£∞‰π¶„ÄÇ', char_title: '1. ËßíËâ≤‰∏éÂ£∞Èü≥', char_name_label: 'ËßíËâ≤ÂêçÁß∞', voice_label: 'Â£∞Èü≥', add_char_button: 'Ê∑ªÂä†ËßíËâ≤', script_label_part1: 'Âú®Ê≠§Â§ÑÁ≤òË¥¥ËÑöÊú¨ (Ê†ºÂºè: ', script_format_text: 'ËßíËâ≤: ÊñáÊú¨...', script_placeholder: 'ÊóÅÁôΩÔºöÊõæÂá†‰ΩïÊó∂...', convert_button_base: 'ËΩ¨Êç¢‰∏∫Èü≥È¢ë', api_select_title: '0. API ÈÄâÊã©', api_select_label: 'ÈÄâÊã©Ë¶Å‰ΩøÁî®ÁöÑAIÂπ≥Âè∞Ôºö', api_select_hint: 'Â¶ÇÊûúËØ∑Ê±ÇÂ§±Ë¥•ÔºåÊÇ®ÂèØ‰ª•ÂàáÊç¢„ÄÇ', gemini_option: 'Ë∞∑Ê≠å Gemini', openai_option: 'OpenAI ChatGPT', elevenlabs_option: 'ElevenLabs', polly_option: '‰∫öÈ©¨ÈÄä Polly', result_title: 'ÊÇ®ÁöÑÁªìÊûúÔºö', download_base: '‰∏ãËΩΩÈü≥È¢ë', error_no_script: 'ËØ∑ÂÖàËæìÂÖ•ËÑöÊú¨ÊñáÂ≠ó„ÄÇ', error_no_char: 'ËØ∑Ëá≥Â∞ëÂÆö‰πâ‰∏Ä‰∏™ËßíËâ≤„ÄÇ', error_proxy_failed: 'ÈîôËØØÔºö‰∏é‰ª£ÁêÜÊúçÂä°Âô®ÈÄö‰ø°Â§±Ë¥•„ÄÇ', lang_title: '0.1 ÈÄâÊã©ËØ≠Ë®Ä', char_name_input_placeholder: '‰æãÂ¶Ç ÊóÅÁôΩ', char_remove_aria: 'Âà†Èô§ËßíËâ≤', default_speaker_name: 'ÊóÅÁôΩ', voice_preview_aria: 'È¢ÑËßàÂ£∞Èü≥', voice_preview_text: '‰Ω†Â•ΩÔºåËøôÊòØ‰∏Ä‰∏™ÊµãËØïÂ£∞Èü≥„ÄÇ', project_title: 'È°πÁõÆÁÆ°ÁêÜ', save_project_button: '‰øùÂ≠òÈ°πÁõÆ', load_project_button: 'Âä†ËΩΩÈ°πÁõÆ', project_saved: 'È°πÁõÆ‰øùÂ≠òÊàêÂäüÔºÅ', project_loaded: 'È°πÁõÆÂä†ËΩΩÊàêÂäüÔºÅ', project_not_found: 'Êú™ÊâæÂà∞Â∑≤‰øùÂ≠òÁöÑÈ°πÁõÆ„ÄÇ', import_from_script_button: '‰ªéËÑöÊú¨ÂØºÂÖ•', speakers_imported: 'Â∑≤‰ªéËÑöÊú¨ÂØºÂÖ•Êñ∞ËßíËâ≤ÔºÅ', no_new_speakers_found: 'ËÑöÊú¨‰∏≠Êú™ÊâæÂà∞Êñ∞ËßíËâ≤„ÄÇ', stats_words: 'ÂçïËØç', stats_chars: 'Â≠óÁ¨¶', stats_duration: 'Êó∂Èïø',
                drag_handle_aria: 'ÁßªÂä®ËßíËâ≤', char_copy_suffix: 'ÔºàÂ§çÂà∂Ôºâ', duplicate_char_aria: 'Â§çÂà∂ËßíËâ≤', design_title: 'ËÆæËÆ°ÊéßÂà∂',
                tooltip_theme: 'ÂàáÊç¢ÊµÖËâ≤/Ê∑±Ëâ≤Ê®°Âºè', tooltip_add_char: 'Ê∑ªÂä†Êñ∞ÁöÑËßíËâ≤Ë°å', tooltip_import: '‰ªéËÑöÊú¨ÊñáÊú¨ÂØºÂÖ•ËßíËâ≤',
                tooltip_save: 'Âú®ÊµèËßàÂô®‰∏≠‰øùÂ≠òÂΩìÂâçÈ°πÁõÆ', tooltip_load: 'Âä†ËΩΩ‰∏äÊ¨°‰øùÂ≠òÁöÑÈ°πÁõÆ', tooltip_glow_container: 'ÂàáÊç¢ÂÆπÂô®ÂèëÂÖâÊïàÊûú',
                tooltip_glow_inputs: 'ÂàáÊç¢ËæìÂÖ•Ê°ÜÂèëÂÖâÊïàÊûú', tooltip_drag: 'Êõ¥ÊîπÈ°∫Â∫è', tooltip_preview: 'È¢ÑËßàÊâÄÈÄâÂ£∞Èü≥',
                tooltip_duplicate: 'Â§çÂà∂Ê≠§ËßíËâ≤', tooltip_remove: 'Âà†Èô§Ê≠§ËßíËâ≤', tooltip_toggle_tooltips: 'ÂàáÊç¢Â∑•ÂÖ∑ÊèêÁ§∫',
                credit_balance_label: 'ÊÇ®ÁöÑ‰ΩôÈ¢ù', credit_balance_unit: 'Â≠óÁ¨¶', buy_credits_btn: 'Ë¥≠‰π∞ÁßØÂàÜ',
                credit_shop_title: 'üíé Ë¥≠‰π∞ÁßØÂàÜ', credit_shop_subtitle: '‰∏∫ÊÇ®ÁöÑÈ°πÁõÆÈÄâÊã©ÂÆåÁæéÁöÑÂ•óÈ§ê',
                pkg_starter: 'ÂÖ•Èó®Â•óÈ§ê', pkg_author: '‰ΩúËÄÖÂ•óÈ§ê', pkg_bestseller: 'ÁïÖÈîÄ‰π¶Â•óÈ§ê', pkg_publisher: 'Âá∫ÁâàÂïÜÂ•óÈ§ê',
                pkg_starter_desc: '10,000 Â≠óÁ¨¶Ôºà1 ÁßØÂàÜÔºâ', pkg_author_desc: '100,000 Â≠óÁ¨¶Ôºà10 ÁßØÂàÜÔºâ', pkg_bestseller_desc: '300,000 Â≠óÁ¨¶Ôºà30 ÁßØÂàÜÔºâ', pkg_publisher_desc: '1,000,000 Â≠óÁ¨¶Ôºà100 ÁßØÂàÜÔºâ',
                pkg_badge_bestseller: '‚≠ê ÁïÖÈîÄ', pkg_badge_best_deal: 'üëë ÊúÄ‰Ω≥‰ºòÊÉ†',
                pkg_save: 'ËäÇÁúÅ', pkg_bonus: '+10% Â•ñÂä±ÁßØÂàÜÔºÅ',
                pkg_feat_short: 'ÈùûÂ∏∏ÈÄÇÂêàÁü≠ÁØáÊïÖ‰∫ã', pkg_feat_novella: 'ÈùûÂ∏∏ÈÄÇÂêà‰∏≠ÁØáÂ∞èËØ¥', pkg_feat_novel: 'ÈùûÂ∏∏ÈÄÇÂêàÈïøÁØáÂ∞èËØ¥', pkg_feat_series: 'ÈùûÂ∏∏ÈÄÇÂêàÁ≥ªÂàó/Âá∫ÁâàÂïÜ',
                pkg_feat_all_apis: 'ÊâÄÊúâ 4 ‰∏™ API ÂèØÁî®', pkg_feat_premium: 'È´òÁ∫ßÊîØÊåÅ', pkg_feat_priority: '‰ºòÂÖàÊîØÊåÅ', pkg_feat_vip: 'VIP ÊîØÊåÅ 24/7',
                pkg_feat_validity: 'ÊúâÊïàÊúü 365 Â§©',
                btn_buy_now: 'Á´ãÂç≥Ë¥≠‰π∞',
                shop_footer: 'üîí ÈÄöËøá Stripe ÂÆâÂÖ®ÊîØ‰ªò ‚Ä¢ ‚è∞ ÁßØÂàÜÂú® 365 Â§©ÂêéËøáÊúü',
                shop_tip: 'üí° ÊèêÁ§∫ÔºöÂ•óÈ§êË∂äÂ§ßÔºåËäÇÁúÅË∂äÂ§öÔºÅ',
                shop_modal_title: 'üíé ÁßØÂàÜÂïÜÂ∫ó',
                shop_modal_subtitle: 'ÈÄâÊã©ÊÇ®ÁöÑÂÆåÁæéÂ•óÈ§ê',
                credit_balance_label: 'ÊÇ®ÁöÑ‰ΩôÈ¢ù',
                credit_balance_unit: 'Â≠óÁ¨¶',
                btn_buy_credits: 'Ë¥≠‰π∞ÁßØÂàÜ',
                btn_settings: 'ËÆæÁΩÆ',
                settings_title: '‚öôÔ∏è ËÆæÁΩÆ',
                settings_subtitle: 'Ê†πÊçÆÊÇ®ÁöÑÂÅèÂ•ΩËá™ÂÆö‰πâÂäüËÉΩ',
                settings_features_title: 'ÂêØÁî®/Á¶ÅÁî®ÂäüËÉΩÔºö',
                setting_voice_preview: 'ËØ≠Èü≥È¢ÑËßàÊ®°ÊÄÅÊ°Ü',
                setting_voice_preview_desc: 'ÊòæÁ§∫ÊâÄÊúâÂèØÁî®ËØ≠Èü≥ÁöÑÊ®°ÊÄÅÊ°Ü',
                setting_cost_calculator: 'ÂÆûÊó∂ÊàêÊú¨ËÆ°ÁÆóÂô®',
                setting_cost_calculator_desc: 'Áî®‰∫éÈ°πÁõÆÊàêÊú¨ËßÑÂàíÁöÑ‰∫§‰∫íÂºèÊªëÂùó',
                setting_live_preview: 'ÂÆûÊó∂Èü≥È¢ëÈ¢ÑËßà',
                setting_live_preview_desc: 'ËæìÂÖ•Êó∂Ëá™Âä®È¢ÑËßàÔºà2ÁßíÂêéÔºâ',
                setting_project_library: 'È°πÁõÆÂ∫ì',
                setting_project_library_desc: 'ÊâÄÊúâÂ∑≤‰øùÂ≠òÈ°πÁõÆÁöÑÂèØËßÜÂåñÂõæÂ∫ì',
                setting_auto_speaker: 'AI ËØ¥ËØù‰∫∫ËØÜÂà´',
                setting_auto_speaker_desc: '‰ªéËÑöÊú¨Ëá™Âä®ÂàÜÈÖçËØ¥ËØù‰∫∫',
                settings_auto_start_label: 'Âä†ËΩΩÂêéËá™Âä®ÂºÄÂßã',
                settings_auto_start_desc: 'ÂêØÁî®ÂêéÔºåÂä†ËΩΩÈ°πÁõÆ‰ºöËá™Âä®ÂºÄÂßãËΩ¨Êç¢ÔºàÂèØËÉΩ‰ºöÊ∂àËÄóÁßØÂàÜÔºâ',
                toast_loaded_title: 'È°πÁõÆÂ∑≤Âä†ËΩΩ',
                toast_start_now: 'Á´ãÂç≥ÂºÄÂßã',
                toast_later: 'Á®çÂêé',
                toast_always_label: 'ÂßãÁªàËá™Âä®ÂºÄÂßã',
                btn_save_settings: '‰øùÂ≠òËÆæÁΩÆ',
                settings_saved: 'ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ',
                btn_preview_voices: 'üé≠ ËØïÂê¨ËØ≠Èü≥',
                voice_preview_title: 'üé≠ ËØ≠Èü≥È¢ÑËßà',
                voice_preview_subtitle: 'ËØïÂê¨ÊâÄÊúâÂèØÁî®ËØ≠Èü≥',
                voice_neutral: '‰∏≠ÊÄß',
                voice_male: 'Áî∑ÊÄß',
                voice_female: 'Â•≥ÊÄß',
                voice_alloy_desc: 'Â§öÂäüËÉΩ‰∏îÂπ≥Ë°°',
                voice_echo_desc: 'Ê∏ÖÊô∞ËÄåÊúâÂäõ',
                voice_fable_desc: 'Ê∏©ÊöñËÄåÂØåÊúâË°®Áé∞Âäõ',
                voice_onyx_desc: '‰ΩéÊ≤âËÄåÁã¨Áâπ',
                voice_nova_desc: 'Âπ¥ËΩªËÄåÊúâÊ¥ªÂäõ',
                voice_shimmer_desc: 'ÊüîÂíåËÄåÊÇ¶ËÄ≥',
                btn_play_sample: 'Êí≠ÊîæÊ†∑Êú¨',
                voice_preview_coming_soon: 'Ê≠§APIÁöÑËØ≠Èü≥Âç≥Â∞ÜÊé®Âá∫',
                voice_preview_api_key_required: 'È¢ÑËßàÈúÄË¶ÅAPIÂØÜÈí•',
                voice_preview_hint: 'üí° ÊèêÁ§∫ÔºöÁÇπÂáª"Êí≠ÊîæÊ†∑Êú¨"‰ΩøÁî®Áõ∏Â∫îËØ≠Èü≥Êî∂Âê¨ÊºîÁ§∫ÊñáÊú¨',
                voice_preview_demo_only: 'ÊºîÁ§∫ÂäüËÉΩ„ÄÇÂÆåÊï¥APIÈõÜÊàêÂç≥Â∞ÜÊé®Âá∫ÔºÅ',
                auto_detect_title: 'ü§ñ AIÊ£ÄÊµã',
                auto_detect_new_speakers: 'Ê£ÄÊµãÂà∞Êñ∞ËØ¥ËØù‰∫∫',
                live_preview_title: 'ÂÆûÊó∂È¢ÑËßà',
                live_preview_generating: 'Ê≠£Âú®ÁîüÊàêÈ¢ÑËßà...',
                live_preview_chars: 'Â∑≤‰ΩøÁî®Â≠óÁ¨¶',
                btn_cost_calculator: 'ÊàêÊú¨ËßÑÂàí',
                cost_calc_title: 'üìä ÊàêÊú¨ËÆ°ÁÆóÂô®',
                cost_calc_subtitle: 'ËÆ°ÁÆóÊÇ®ÁöÑÊúâÂ£∞‰π¶È°πÁõÆÊàêÊú¨',
                cost_calc_chars_label: 'Â≠óÁ¨¶Êï∞Ôºö',
                cost_calc_short: 'Áü≠ÁØáÂ∞èËØ¥ (10k)',
                cost_calc_novella: '‰∏≠ÁØáÂ∞èËØ¥ (50k)',
                cost_calc_novel: 'ÈïøÁØáÂ∞èËØ¥ (100k)',
                cost_calc_epic: 'Âè≤ËØó (300k)',
                cost_calc_duration: 'È¢ÑËÆ°Êó∂ÈïøÔºö',
                cost_calc_reading_speed: 'ÈòÖËØªÈÄüÂ∫¶Ôºö',
                cost_calc_api: 'API',
                cost_calc_cost_usd: 'ÊàêÊú¨ (ÁæéÂÖÉ)',
                cost_calc_credits: 'ÁßØÂàÜ',
                cost_calc_margin: 'Âà©Ê∂¶Áéá',
                cost_calc_cheapest: 'ÊúÄ‰æøÂÆú',
                cost_calc_expensive: 'ÊúÄË¥µ',
                cost_calc_best_choice: 'üèÜ ÊúÄ‰Ω≥ÈÄâÊã©Ôºö',
                cost_calc_saves: 'ËäÇÁúÅ',
                cost_calc_cheaper: 'Êõ¥‰æøÂÆú',
                cost_calc_hint: 'üí° ÊèêÁ§∫Ôºö‰ΩøÁî®ÊªëÂùóËÆ°ÁÆó‰∏çÂêåÈ°πÁõÆËßÑÊ®°',
                btn_my_projects: 'ÊàëÁöÑÈ°πÁõÆ',
                btn_save_project: 'üíæ ‰øùÂ≠òÈ°πÁõÆ',
                library_title: 'üìö ÊàëÁöÑÊúâÂ£∞‰π¶È°πÁõÆ',
                library_search_placeholder: 'ÊêúÁ¥¢È°πÁõÆ...',
                library_sort_newest: 'ÊúÄÊñ∞‰ºòÂÖà',
                library_sort_oldest: 'ÊúÄÊóß‰ºòÂÖà',
                library_sort_largest: 'ÊúÄÂ§ß‰ºòÂÖà',
                library_sort_smallest: 'ÊúÄÂ∞è‰ºòÂÖà',
                library_sort_alphabetical: 'ÊåâÂ≠óÊØçÈ°∫Â∫è',
                library_characters: 'Â≠óÁ¨¶',
                library_speakers: 'ËØ¥ËØù‰∫∫',
                library_status_completed: 'Â∑≤ÂÆåÊàê',
                library_status_draft: 'ËçâÁ®ø',
                library_duration_min: 'ÂàÜÈíü',
                library_btn_load: 'Âä†ËΩΩ',
                library_btn_delete: 'Âà†Èô§',
                library_btn_new: 'ÂàõÂª∫Êñ∞È°πÁõÆ',
                library_empty: 'Â∞öÊú™‰øùÂ≠òÈ°πÁõÆ',
                library_empty_hint: 'ÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™ÊúâÂ£∞‰π¶Âπ∂‰øùÂ≠òÔºÅ',
                library_delete_confirm: 'Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§È°πÁõÆÂêóÔºü',
                library_delete_warning: 'Ê≠§Êìç‰ΩúÊó†Ê≥ïÊí§Ê∂àÔºÅ',
                library_project_loaded: 'È°πÁõÆÂ∑≤Âä†ËΩΩÔºÅ',
                library_project_deleted: 'È°πÁõÆÂ∑≤Âà†Èô§ÔºÅ',
                library_chars: 'Â≠óÁ¨¶',
                library_speakers: 'ÊºîËÆ≤ËÄÖ',
                library_load_confirm: 'ÂΩìÂâçÈ°πÁõÆÂ∞ÜË¢´Ë¶ÜÁõñ„ÄÇÁªßÁª≠Ôºü',
                library_new_confirm: 'ÂºÄÂßãÊñ∞È°πÁõÆÔºüÔºàÂΩìÂâçÈ°πÁõÆ‰∏ç‰ºö‰øùÂ≠òÔºâ',
                save_project_prompt: 'ËæìÂÖ•È°πÁõÆÂêçÁß∞Ôºö',
                save_project_success: 'È°πÁõÆÂ∑≤‰øùÂ≠òÔºÅ',
                package_starter: 'ÂÖ•Èó®Áâà', package_author: '‰ΩúËÄÖÁâà', package_bestseller: 'ÁïÖÈîÄÁâà', package_publisher: 'Âá∫ÁâàÂïÜÁâà',
                badge_bestseller: 'ÁïÖÈîÄ', badge_best_deal: 'ÊúÄ‰ºòÊÉ†', badge_bonus: 'Â•ñÂä±',
                feature_chars: 'Â≠óÁ¨¶', feature_discount: 'ÊäòÊâ£', feature_instant: 'Âç≥Êó∂ÂèØÁî®', feature_all_apis: 'ÊâÄÊúâAPIÂèØÁî®',
                buy_package_btn: 'Á´ãÂç≥Ë¥≠‰π∞', credit_insufficient: 'ÁßØÂàÜ‰∏çË∂≥ÔºÅ', credit_required: 'ÈúÄË¶Å', credit_current: 'ÊÇ®ÁöÑ‰ΩôÈ¢ù', credit_missing: 'Áº∫Â∞ë',
                credit_buy_now: 'ÊÇ®ÊÉ≥Áé∞Âú®Ë¥≠‰π∞ÁßØÂàÜÂêóÔºü',
                templates_title: '‚ö° Âø´ÈÄüÊ®°Êùø', templates_subtitle: '‰ΩøÁî®È¢ÑÂà∂Âú∫ÊôØÂø´ÈÄüÂºÄÂßãÔºö',
                glow_container_label: 'ËæπÊ°ÜÂèëÂÖâÔºö', glow_input_label: 'Â≠óÊÆµÂèëÂÖâÔºö', tooltips_label: 'ÊèêÁ§∫Ôºö', status_on: 'ÂºÄ', status_off: 'ÂÖ≥',
                template_fairytale: 'üìö Á´•ËØùÊïÖ‰∫ã', template_podcast: 'üéôÔ∏è Êí≠ÂÆ¢', template_novel: 'üìñ Â∞èËØ¥', template_dialog: 'üí¨ ÂØπËØù',
                clear_all_button: 'Ê∏ÖÈô§ÂÖ®ÈÉ®', script_title: '2. ËÑöÊú¨',
                cost_title: 'üí∞ È¢ÑËÆ°ÊàêÊú¨Ôºö', time_estimate_label: '‚è±Ô∏è È¢ÑËÆ°Êó∂Èó¥Ôºö',
                pricing_table_title: 'üìä ÁßØÂàÜ‰ª∑Ê†ºÔºà‰ºòÂåñÂà©Ê∂¶ÁéáÔºâÔºö', pricing_api: 'API',
                pricing_10k: '10,000 Â≠óÁ¨¶', pricing_100k: '100,000 Â≠óÁ¨¶', pricing_300k: '300,000 Â≠óÁ¨¶', pricing_novel: 'ÔºàÂ∞èËØ¥Ôºâ',
                templates: {
                    fairytale: {
                        speakers: [
                            { name: 'ÊóÅÁôΩ', voice: 'nova' },
                            { name: 'ÂÖ¨‰∏ª', voice: 'shimmer' },
                            { name: 'Èæô', voice: 'onyx' }
                        ],
                        script: `ÊóÅÁôΩ: Âæà‰πÖÂæà‰πÖ‰ª•ÂâçÔºåÂú®‰∏Ä‰∏™ÈÅ•ËøúÁöÑÁéãÂõΩÈáå‰ΩèÁùÄ‰∏Ä‰ΩçÁæé‰∏ΩÁöÑÂÖ¨‰∏ª„ÄÇ
ÂÖ¨‰∏ª: ÊàëÊ¢¶ÊÉ≥ÁùÄÊé¢Á¥¢‰∏ñÁïåÔºåÁªèÂéÜÂÜíÈô©ÔºÅ
ÊóÅÁôΩ: Êúâ‰∏ÄÂ§©Ôºå‰∏ÄÊù°ÂèØÊÄïÁöÑÈæôÂá∫Áé∞Âú®Âú∞Âπ≥Á∫ø‰∏ä„ÄÇ
Èæô: Ë∞ÅÊï¢ËøõÂÖ•ÊàëÁöÑÈ¢ÜÂú∞Ôºü
ÂÖ¨‰∏ª: Êàë‰∏çÊÄï‰Ω†ÔºÅËÆ©Êàë‰ª¨Êàê‰∏∫ÊúãÂèãÔºåËÄå‰∏çÊòØÊàòÊñó„ÄÇ
ÊóÅÁôΩ: Â∞±ËøôÊ†∑Ôºå‰∏ÄÊÆµ‰∏çÂØªÂ∏∏ÁöÑÂèãË∞äÂºÄÂßã‰∫Ü...`
                    },
                    podcast: {
                        speakers: [
                            { name: '‰∏ªÊåÅ‰∫∫', voice: 'echo' },
                            { name: 'ÂòâÂÆæ', voice: 'fable' }
                        ],
                        script: `‰∏ªÊåÅ‰∫∫: Ê¨¢ËøéÊù•Âà∞Êàë‰ª¨ÁöÑÊí≠ÂÆ¢ÔºÅ‰ªäÂ§©Êàë‰ª¨Êúâ‰∏Ä‰ΩçÈùûÂ∏∏ÁâπÂà´ÁöÑÂòâÂÆæ„ÄÇ
ÂòâÂÆæ: ÈùûÂ∏∏ÊÑüË∞¢ÈÇÄËØ∑ÊàëÔºÅÊàëÂæàÈ´òÂÖ¥ËÉΩÊù•Âà∞ËøôÈáå„ÄÇ
‰∏ªÊåÅ‰∫∫: ÂëäËØâÊàë‰ª¨‰∏ÄÂàáÊòØÂ¶Ç‰ΩïÂºÄÂßãÁöÑ„ÄÇ
ÂòâÂÆæ: ÈÇ£ÊòØÂú®2020Âπ¥Â§èÂ§©ÔºåÂΩìÊó∂ÊàëÊúâ‰∫ÜËøô‰∏™ÊÉ≥Ê≥ï...
‰∏ªÊåÅ‰∫∫: Â§™Ê£í‰∫ÜÔºÅÊúÄÂ§ßÁöÑÊåëÊàòÊòØ‰ªÄ‰πàÔºü
ÂòâÂÆæ: ÊúÄÂ§ßÁöÑÊåëÊàòËÇØÂÆöÊòØÂàùÂßãÈò∂ÊÆµ„ÄÇ`
                    },
                    novel: {
                        speakers: [
                            { name: 'ÊóÅÁôΩ', voice: 'alloy' },
                            { name: '‰∏ªËßí', voice: 'nova' },
                            { name: 'ÂèçÊ¥æ', voice: 'onyx' },
                            { name: 'ÂØºÂ∏à', voice: 'echo' },
                            { name: 'ÊúãÂèã', voice: 'fable' }
                        ],
                        script: `ÊóÅÁôΩ: ÂΩìÊàë‰ª¨ÁöÑÊïÖ‰∫ãÂºÄÂßãÊó∂ÔºåÂ§™Èò≥Ê≠£ËêΩÂú®ÂüéÂ∏Ç‰∏äÁ©∫„ÄÇ
‰∏ªËßí: ÊàëÁü•ÈÅì‰ªäÂ§©‰∏ÄÂàáÈÉΩ‰ºöÊîπÂèò„ÄÇ
ÂØºÂ∏à: ‰Ω†ÊúâÊΩúÂäõÂèñÂæó‰ºüÂ§ßÊàêÂ∞±„ÄÇ‰ΩÜÈÅìË∑Ø‰∏ç‰ºöÂÆπÊòì„ÄÇ
ÊúãÂèã: Êó†ËÆ∫ÂèëÁîü‰ªÄ‰πàÔºåÊàëÈÉΩ‰ºöÁ´ôÂú®‰Ω†Ë∫´ËæπÔºÅ
ÂèçÊ¥æ: ‰ªñ‰ª¨ÈÉΩ‰ºöÂ§±Ë¥•„ÄÇËøôÂ∫ßÂüéÂ∏ÇÂ±û‰∫éÊàë„ÄÇ
ÊóÅÁôΩ: Â∞±ËøôÊ†∑ÔºåÂÖâÊòé‰∏éÈªëÊöó‰πãÈó¥ÁöÑÊàòÊñóÂºÄÂßã‰∫Ü...`
                    },
                    dialog: {
                        speakers: [
                            { name: '‰∫∫Áâ©A', voice: 'shimmer' },
                            { name: '‰∫∫Áâ©B', voice: 'alloy' }
                        ],
                        script: `‰∫∫Áâ©A: ‰Ω†Âê¨ËØ¥Êñ∞È°πÁõÆ‰∫ÜÂêóÔºü
‰∫∫Áâ©B: Âê¨ËØ¥‰∫ÜÔºåÂê¨Ëµ∑Êù•ÁúüÁöÑÂæà‰ª§‰∫∫ÂÖ¥Â•ãÔºÅ‰ªÄ‰πàÊó∂ÂÄôÂºÄÂßãÔºü
‰∫∫Áâ©A: ‰∏ãÂë®„ÄÇ‰Ω†ÂèÇÂä†ÂêóÔºü
‰∫∫Áâ©B: ÂΩìÁÑ∂ÔºÅËÆ©Êàë‰ª¨‰∏ÄËµ∑ÂÅöÂêß„ÄÇ
‰∫∫Áâ©A: ÂÆåÁæéÔºÅÊàëÂæàÊúüÂæÖ„ÄÇ
‰∫∫Áâ©B: Êàë‰πüÊòØ„ÄÇËøôÂ∞Ü‰ºöÂæàÊ£íÔºÅ`
                    }
                },
            },
            'ja': {
                main_title: '„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Çπ„Çø„Ç∏„Ç™„Éó„É≠', main_subtitle: 'Ë§áÊï∞„ÅÆÂ£∞„Åß„Éó„É≠„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÄÇ', char_title: '1. „Ç≠„É£„É©„ÇØ„Çø„Éº„Å®Â£∞', char_name_label: '„Ç≠„É£„É©„ÇØ„Çø„ÉºÂêç', voice_label: 'Â£∞', add_char_button: '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíËøΩÂä†', script_label_part1: '„Åì„Åì„Å´„Çπ„ÇØ„É™„Éó„Éà„ÇíË≤º„Çä‰ªò„Åë„Åæ„Åô (ÂΩ¢Âºè: ', script_format_text: '„Ç≠„É£„É©„ÇØ„Çø„ÉºÔºö„ÉÜ„Ç≠„Çπ„Éà...', script_placeholder: '„Éä„É¨„Éº„Çø„ÉºÔºöÊòî„ÄÖ...', convert_button_base: '„Ç™„Éº„Éá„Ç£„Ç™„Å´Â§âÊèõ', api_select_title: '0. API„ÅÆÈÅ∏Êäû', api_select_label: '‰ΩøÁî®„Åô„ÇãAI„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†„ÇíÈÅ∏ÊäûÔºö', api_select_hint: '„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂàá„ÇäÊõø„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ', gemini_option: 'Google Gemini', openai_option: 'OpenAI ChatGPT', elevenlabs_option: 'ElevenLabs', polly_option: 'Amazon Polly', result_title: '„ÅÇ„Å™„Åü„ÅÆÁµêÊûúÔºö', download_base: '„Ç™„Éº„Éá„Ç£„Ç™„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ', error_no_script: '„Åæ„Åö„Çπ„ÇØ„É™„Éó„Éà„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', error_no_char: 'Â∞ë„Å™„Åè„Å®„ÇÇ1‰∫∫„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂÆöÁæ©„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', error_proxy_failed: '„Ç®„É©„ÉºÔºö„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„Å®„ÅÆÈÄö‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', lang_title: '0.1 Ë®ÄË™û„ÇíÈÅ∏Êäû', char_name_input_placeholder: '‰æãÔºö„Éä„É¨„Éº„Çø„Éº', char_remove_aria: '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂâäÈô§', default_speaker_name: '„Éä„É¨„Éº„Çø„Éº', voice_preview_aria: 'Èü≥Â£∞„Çí„Éó„É¨„Éì„É•„Éº', voice_preview_text: '„Åì„Çì„Å´„Å°„ÅØ„ÄÅ„Åì„Çå„ÅØ„ÉÜ„Çπ„ÉàÁî®„ÅÆÈü≥Â£∞„Åß„Åô„ÄÇ', project_title: '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁÆ°ÁêÜ', save_project_button: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò', load_project_button: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ', project_saved: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅ', project_loaded: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåÊ≠£Â∏∏„Å´Ë™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„ÅüÔºÅ', project_not_found: '‰øùÂ≠ò„Åï„Çå„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', import_from_script_button: '„Çπ„ÇØ„É™„Éó„Éà„Åã„Çâ„Ç§„É≥„Éù„Éº„Éà', speakers_imported: '„Çπ„ÇØ„É™„Éó„Éà„Åã„ÇâÊñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„ÅüÔºÅ', no_new_speakers_found: '„Çπ„ÇØ„É™„Éó„Éà„Å´Êñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', stats_words: 'ÂçòË™û', stats_chars: 'ÊñáÂ≠ó', stats_duration: 'ÊôÇÈñì',
                drag_handle_aria: '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÁßªÂãï', char_copy_suffix: 'Ôºà„Ç≥„Éî„ÉºÔºâ', duplicate_char_aria: '„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíË§áË£Ω', design_title: '„Éá„Ç∂„Ç§„É≥„Ç≥„É≥„Éà„É≠„Éº„É´',
                tooltip_theme: '„É©„Ç§„Éà/„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„ÅÆÂàá„ÇäÊõø„Åà', tooltip_add_char: 'Êñ∞„Åó„ÅÑ„Ç≠„É£„É©„ÇØ„Çø„ÉºË°å„ÇíËøΩÂä†', tooltip_import: '„Çπ„ÇØ„É™„Éó„Éà„ÉÜ„Ç≠„Çπ„Éà„Åã„Çâ„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Ç§„É≥„Éù„Éº„Éà',
                tooltip_save: 'ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí„Éñ„É©„Ç¶„Ç∂„Å´‰øùÂ≠ò', tooltip_load: 'ÊúÄÂæå„Å´‰øùÂ≠ò„Åó„Åü„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ', tooltip_glow_container: '„Ç≥„É≥„ÉÜ„Éä„ÅÆ„Ç∞„É≠„ÉºÂäπÊûú„ÇíÂàá„ÇäÊõø„Åà',
                tooltip_glow_inputs: 'ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç∞„É≠„ÉºÂäπÊûú„ÇíÂàá„ÇäÊõø„Åà', tooltip_drag: 'È†ÜÂ∫è„ÇíÂ§âÊõ¥', tooltip_preview: 'ÈÅ∏Êäû„Åó„ÅüÈü≥Â£∞„Çí„Éó„É¨„Éì„É•„Éº',
                tooltip_duplicate: '„Åì„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíË§áË£Ω', tooltip_remove: '„Åì„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÂâäÈô§', tooltip_toggle_tooltips: '„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆÂàá„ÇäÊõø„Åà',
                credit_balance_label: 'ÊÆãÈ´ò', credit_balance_unit: 'ÊñáÂ≠ó', buy_credits_btn: '„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíË≥ºÂÖ•',
                credit_shop_title: 'üíé „ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíË≥ºÂÖ•', credit_shop_subtitle: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´ÊúÄÈÅ©„Å™„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÈÅ∏Êäû',
                pkg_starter: '„Çπ„Çø„Éº„Çø„Éº„Éë„ÉÉ„Ç±„Éº„Ç∏', pkg_author: 'ËëóËÄÖ„Éë„ÉÉ„Ç±„Éº„Ç∏', pkg_bestseller: '„Éô„Çπ„Éà„Çª„É©„Éº„Éë„ÉÉ„Ç±„Éº„Ç∏', pkg_publisher: 'Âá∫ÁâàÁ§æ„Éë„ÉÉ„Ç±„Éº„Ç∏',
                pkg_starter_desc: '10,000ÊñáÂ≠óÔºà1„ÇØ„É¨„Ç∏„ÉÉ„ÉàÔºâ', pkg_author_desc: '100,000ÊñáÂ≠óÔºà10„ÇØ„É¨„Ç∏„ÉÉ„ÉàÔºâ', pkg_bestseller_desc: '300,000ÊñáÂ≠óÔºà30„ÇØ„É¨„Ç∏„ÉÉ„ÉàÔºâ', pkg_publisher_desc: '1,000,000ÊñáÂ≠óÔºà100„ÇØ„É¨„Ç∏„ÉÉ„ÉàÔºâ',
                pkg_badge_bestseller: '‚≠ê „Éô„Çπ„Éà„Çª„É©„Éº', pkg_badge_best_deal: 'üëë „Éô„Çπ„Éà„Éá„Ç£„Éº„É´',
                pkg_save: 'ÁØÄÁ¥Ñ', pkg_bonus: '+10% „Éú„Éº„Éä„Çπ„ÇØ„É¨„Ç∏„ÉÉ„ÉàÔºÅ',
                pkg_feat_short: 'Áü≠Á∑®Â∞èË™¨„Å´ÊúÄÈÅ©', pkg_feat_novella: '‰∏≠Á∑®Â∞èË™¨„Å´ÊúÄÈÅ©', pkg_feat_novel: 'Èï∑Á∑®Â∞èË™¨„Å´ÊúÄÈÅ©', pkg_feat_series: '„Ç∑„É™„Éº„Ç∫/Âá∫ÁâàÁ§æ„Å´ÊúÄÈÅ©',
                pkg_feat_all_apis: '„Åô„Åπ„Å¶„ÅÆ4„Å§„ÅÆAPI„ÅåÂà©Áî®ÂèØËÉΩ', pkg_feat_premium: '„Éó„É¨„Éü„Ç¢„É†„Çµ„Éù„Éº„Éà', pkg_feat_priority: 'ÂÑ™ÂÖà„Çµ„Éù„Éº„Éà', pkg_feat_vip: 'VIP„Çµ„Éù„Éº„Éà24/7',
                pkg_feat_validity: 'ÊúâÂäπÊúüÈñì365Êó•',
                btn_buy_now: '‰ªä„Åô„ÅêË≥ºÂÖ•',
                shop_footer: 'üîí Stripe„Å´„Çà„ÇãÂÆâÂÖ®„Å™ÊîØÊâï„ÅÑ ‚Ä¢ ‚è∞ „ÇØ„É¨„Ç∏„ÉÉ„Éà„ÅØ365Êó•Âæå„Å´Â§±Âäπ',
                shop_tip: 'üí° „Éí„É≥„ÉàÔºö„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅåÂ§ß„Åç„ÅÑ„Åª„Å©„ÄÅ„Çà„Çä„ÅäÂæó„Åß„ÅôÔºÅ',
                shop_modal_title: 'üíé „ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç∑„Éß„ÉÉ„Éó',
                shop_modal_subtitle: 'ÂÆåÁíß„Å™„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÈÅ∏Êäû',
                credit_balance_label: 'ÊÆãÈ´ò',
                credit_balance_unit: 'ÊñáÂ≠ó',
                btn_buy_credits: '„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíË≥ºÂÖ•',
                btn_settings: 'Ë®≠ÂÆö',
                settings_title: '‚öôÔ∏è Ë®≠ÂÆö',
                settings_subtitle: 'Â•Ω„Åø„Å´Âêà„Çè„Åõ„Å¶Ê©üËÉΩ„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫',
                settings_features_title: 'Ê©üËÉΩ„ÅÆÊúâÂäπÂåñ/ÁÑ°ÂäπÂåñÔºö',
                setting_voice_preview: 'Èü≥Â£∞„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´',
                setting_voice_preview_desc: 'Âà©Áî®ÂèØËÉΩ„Å™„Åô„Åπ„Å¶„ÅÆÈü≥Â£∞„ÇíËÅ¥„Åè„Åü„ÇÅ„ÅÆ„É¢„Éº„ÉÄ„É´',
                setting_cost_calculator: '„É™„Ç¢„É´„Çø„Ç§„É†„Ç≥„Çπ„ÉàË®àÁÆóÊ©ü',
                setting_cost_calculator_desc: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç≥„Çπ„ÉàË®àÁîªÁî®„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Çπ„É©„Ç§„ÉÄ„Éº',
                setting_live_preview: '„É©„Ç§„ÉñÈü≥Â£∞„Éó„É¨„Éì„É•„Éº',
                setting_live_preview_desc: 'ÂÖ•Âäõ‰∏≠„Å´Ëá™Âãï„Éó„É¨„Éì„É•„ÉºÔºà2ÁßíÂæåÔºâ',
                setting_project_library: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„É©„Ç§„Éñ„É©„É™',
                setting_project_library_desc: '‰øùÂ≠ò„Åï„Çå„Åü„Åô„Åπ„Å¶„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éì„Ç∏„É•„Ç¢„É´„ÇÆ„É£„É©„É™„Éº',
                setting_auto_speaker: 'AIË©±ËÄÖË™çË≠ò',
                setting_auto_speaker_desc: '„Çπ„ÇØ„É™„Éó„Éà„Åã„ÇâËá™Âãï„ÅßË©±ËÄÖ„ÇíÂâ≤„ÇäÂΩì„Å¶',
                settings_auto_start_label: 'Ë™≠„ÅøËæº„ÅøÂæå„Å´Ëá™ÂãïÈñãÂßã',
                settings_auto_start_desc: 'ÊúâÂäπ„Å´„Åô„Çã„Å®„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„ÇÄ„Å®Ëá™ÂãïÁöÑ„Å´Â§âÊèõ„ÅåÈñãÂßã„Åï„Çå„Åæ„ÅôÔºà„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíÊ∂àË≤ª„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ',
                toast_loaded_title: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü',
                toast_start_now: '‰ªä„Åô„ÅêÈñãÂßã',
                toast_later: 'Âæå„Åß',
                toast_always_label: 'Â∏∏„Å´Ëá™ÂãïÁöÑ„Å´ÈñãÂßã„Åô„Çã',
                btn_save_settings: 'Ë®≠ÂÆö„Çí‰øùÂ≠ò',
                settings_saved: 'Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ',
                btn_preview_voices: 'üé≠ Èü≥Â£∞„ÇíË©¶ËÅ¥',
                voice_preview_title: 'üé≠ Èü≥Â£∞„Éó„É¨„Éì„É•„Éº',
                voice_preview_subtitle: 'Âà©Áî®ÂèØËÉΩ„Å™„Åô„Åπ„Å¶„ÅÆÈü≥Â£∞„ÇíË©¶ËÅ¥',
                voice_neutral: '„Éã„É•„Éº„Éà„É©„É´',
                voice_male: 'Áî∑ÊÄß',
                voice_female: 'Â•≥ÊÄß',
                voice_alloy_desc: 'Ê±éÁî®ÊÄß„Åå„ÅÇ„Çä„Éê„É©„É≥„Çπ„ÅåËâØ„ÅÑ',
                voice_echo_desc: 'ÊòéÁû≠„Åß„Éë„ÉØ„Éï„É´',
                voice_fable_desc: 'Ê∏©„Åã„ÅèË°®ÁèæË±ä„Åã',
                voice_onyx_desc: 'Ê∑±„Åø„Åå„ÅÇ„ÇäÁã¨Áâπ',
                voice_nova_desc: 'Ëã•„ÄÖ„Åó„Åè„Ç®„Éç„É´„ÇÆ„ÉÉ„Ç∑„É•',
                voice_shimmer_desc: 'Êüî„Çâ„Åã„Åè„É°„É≠„Éá„Ç£„Ç¢„Çπ',
                btn_play_sample: '„Çµ„É≥„Éó„É´„ÇíÂÜçÁîü',
                voice_preview_coming_soon: '„Åì„ÅÆAPI„ÅÆÈü≥Â£∞„ÅØËøëÊó•ÂÖ¨Èñã',
                voice_preview_api_key_required: '„Éó„É¨„Éì„É•„Éº„Å´„ÅØAPI„Ç≠„Éº„ÅåÂøÖË¶Å„Åß„Åô',
                voice_preview_hint: 'üí° „Éí„É≥„ÉàÔºö„Äå„Çµ„É≥„Éó„É´„ÇíÂÜçÁîü„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„ÄÅ„Åù„ÅÆÈü≥Â£∞„Åß„Éá„É¢„ÉÜ„Ç≠„Çπ„Éà„ÇíËÅû„Åè„Åì„Å®„Åå„Åß„Åç„Åæ„Åô',
                voice_preview_demo_only: '„Éá„É¢Ê©üËÉΩ„ÄÇÂÆåÂÖ®„Å™APIÁµ±Âêà„ÅØËøëÊó•ÂÖ¨ÈñãÔºÅ',
                auto_detect_title: 'ü§ñ AIÊ§úÂá∫',
                auto_detect_new_speakers: 'Êñ∞„Åó„ÅÑ„Çπ„Éî„Éº„Ç´„Éº„ÇíÊ§úÂá∫',
                live_preview_title: '„É©„Ç§„Éñ„Éó„É¨„Éì„É•„Éº',
                live_preview_generating: '„Éó„É¨„Éì„É•„Éº„ÇíÁîüÊàê‰∏≠...',
                live_preview_chars: '‰ΩøÁî®ÊñáÂ≠óÊï∞',
                btn_cost_calculator: '„Ç≥„Çπ„Éà„Éó„É©„É≥',
                cost_calc_title: 'üìä „Ç≥„Çπ„ÉàË®àÁÆóÊ©ü',
                cost_calc_subtitle: '„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≥„Çπ„Éà„ÇíË®àÁÆó',
                cost_calc_chars_label: 'ÊñáÂ≠óÊï∞Ôºö',
                cost_calc_short: 'Áü≠Á∑®Â∞èË™¨ (10k)',
                cost_calc_novella: '‰∏≠Á∑®Â∞èË™¨ (50k)',
                cost_calc_novel: 'Èï∑Á∑®Â∞èË™¨ (100k)',
                cost_calc_epic: 'Âèô‰∫ãË©© (300k)',
                cost_calc_duration: 'Êé®ÂÆöÊôÇÈñìÔºö',
                cost_calc_reading_speed: 'Ë™≠„ÇÄÈÄüÂ∫¶Ôºö',
                cost_calc_api: 'API',
                cost_calc_cost_usd: '„Ç≥„Çπ„Éà (USD)',
                cost_calc_credits: '„ÇØ„É¨„Ç∏„ÉÉ„Éà',
                cost_calc_margin: '„Éû„Éº„Ç∏„É≥',
                cost_calc_cheapest: 'ÊúÄÂÆâ',
                cost_calc_expensive: 'ÊúÄÈ´ò',
                cost_calc_best_choice: 'üèÜ „Éô„Çπ„Éà„ÉÅ„Éß„Ç§„ÇπÔºö',
                cost_calc_saves: 'ÁØÄÁ¥Ñ',
                cost_calc_cheaper: 'ÂÆâ„ÅÑ',
                cost_calc_hint: 'üí° „Éí„É≥„ÉàÔºö„Çπ„É©„Ç§„ÉÄ„Éº„Çí‰ΩøÁî®„Åó„Å¶„Åï„Åæ„Åñ„Åæ„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çµ„Ç§„Ç∫„ÇíË®àÁÆó',
                btn_my_projects: '„Éû„Ç§„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                btn_save_project: 'üíæ „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò',
                library_title: 'üìö „Éû„Ç§„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Éó„É≠„Ç∏„Çß„ÇØ„Éà',
                library_search_placeholder: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊ§úÁ¥¢...',
                library_sort_newest: 'ÊúÄÊñ∞È†Ü',
                library_sort_oldest: 'ÊúÄÂè§È†Ü',
                library_sort_largest: 'ÊúÄÂ§ßÈ†Ü',
                library_sort_smallest: 'ÊúÄÂ∞èÈ†Ü',
                library_sort_alphabetical: '„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„ÉàÈ†Ü',
                library_characters: 'ÊñáÂ≠ó',
                library_speakers: 'Ë©±ËÄÖ',
                library_status_completed: 'ÂÆå‰∫Ü',
                library_status_draft: '‰∏ãÊõ∏„Åç',
                library_duration_min: 'ÂàÜ',
                library_btn_load: 'Ë™≠„ÅøËæº„ÇÄ',
                library_btn_delete: 'ÂâäÈô§',
                library_btn_new: 'Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê',
                library_empty: '„Åæ„Å†„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì',
                library_empty_hint: 'ÊúÄÂàù„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™„Éñ„ÉÉ„ÇØ„Çí‰ΩúÊàê„Åó„Å¶‰øùÂ≠ò„Åó„Åæ„Åó„Çá„ÅÜÔºÅ',
                library_delete_confirm: '„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü',
                library_delete_warning: '„Åì„ÅÆÊìç‰Ωú„ÅØÂÖÉ„Å´Êàª„Åõ„Åæ„Åõ„ÇìÔºÅ',
                library_project_loaded: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ',
                library_project_deleted: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„ÅüÔºÅ',
                library_chars: 'ÊñáÂ≠ó',
                library_speakers: '„Çπ„Éî„Éº„Ç´„Éº',
                library_load_confirm: 'ÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü',
                library_new_confirm: 'Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñãÂßã„Åó„Åæ„Åô„ÅãÔºüÔºàÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅØ‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„ÇìÔºâ',
                save_project_prompt: '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÂÖ•ÂäõÔºö',
                save_project_success: '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ',
                package_starter: '„Çπ„Çø„Éº„Çø„Éº', package_author: 'ËëóËÄÖ', package_bestseller: '„Éô„Çπ„Éà„Çª„É©„Éº', package_publisher: 'Âá∫ÁâàÁ§æ',
                badge_bestseller: '„Éô„Çπ„Éà„Çª„É©„Éº', badge_best_deal: 'ÊúÄ„ÇÇ„ÅäÂæó', badge_bonus: '„Éú„Éº„Éä„Çπ',
                feature_chars: 'ÊñáÂ≠ó', feature_discount: 'Ââ≤Âºï', feature_instant: 'Âç≥Â∫ß„Å´Âà©Áî®ÂèØËÉΩ', feature_all_apis: '„Åô„Åπ„Å¶„ÅÆAPI„ÅåÂà©Áî®ÂèØËÉΩ',
                buy_package_btn: '‰ªä„Åô„ÅêË≥ºÂÖ•', credit_insufficient: '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ', credit_required: 'ÂøÖË¶Å', credit_current: 'ÊÆãÈ´ò', credit_missing: '‰∏çË∂≥',
                credit_buy_now: '‰ªä„Åô„Åê„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÇíË≥ºÂÖ•„Åó„Åæ„Åô„ÅãÔºü',
                templates_title: '‚ö° „ÇØ„Ç§„ÉÉ„ÇØ„ÉÜ„É≥„Éó„É¨„Éº„Éà', templates_subtitle: 'Êó¢Ë£Ω„ÅÆ„Ç∑„Éä„É™„Ç™„Åß„Åô„Åê„Å´ÈñãÂßãÔºö',
                glow_container_label: 'Êû†„ÅÆÂÖâÔºö', glow_input_label: '„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÖâÔºö', tooltips_label: '„Éí„É≥„ÉàÔºö', status_on: '„Ç™„É≥', status_off: '„Ç™„Éï',
                template_fairytale: 'üìö „Åä„Å®„ÅéË©±', template_podcast: 'üéôÔ∏è „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà', template_novel: 'üìñ Â∞èË™¨', template_dialog: 'üí¨ ÂØæË©±',
                clear_all_button: '„Åô„Åπ„Å¶„ÇØ„É™„Ç¢', script_title: '2. „Çπ„ÇØ„É™„Éó„Éà',
                cost_title: 'üí∞ Êé®ÂÆö„Ç≥„Çπ„ÉàÔºö', time_estimate_label: '‚è±Ô∏è Êé®ÂÆöÊôÇÈñìÔºö',
                pricing_table_title: 'üìä „ÇØ„É¨„Ç∏„ÉÉ„Éà‰æ°Ê†ºÔºàÊúÄÈÅ©Âåñ„Åï„Çå„Åü„Éû„Éº„Ç∏„É≥ÔºâÔºö', pricing_api: 'API',
                pricing_10k: '10,000ÊñáÂ≠ó', pricing_100k: '100,000ÊñáÂ≠ó', pricing_300k: '300,000ÊñáÂ≠ó', pricing_novel: 'ÔºàÂ∞èË™¨Ôºâ',
                templates: {
                    fairytale: {
                        speakers: [
                            { name: '„Éä„É¨„Éº„Çø„Éº', voice: 'nova' },
                            { name: '„Éó„É™„É≥„Çª„Çπ', voice: 'shimmer' },
                            { name: '„Éâ„É©„Ç¥„É≥', voice: 'onyx' }
                        ],
                        script: `„Éä„É¨„Éº„Çø„Éº: Êòî„ÄÖ„ÄÅÈÅ†„ÅÑÁéãÂõΩ„Å´Áæé„Åó„ÅÑ„Éó„É™„É≥„Çª„Çπ„Åå‰Ωè„Çì„Åß„ÅÑ„Åæ„Åó„Åü„ÄÇ
„Éó„É™„É≥„Çª„Çπ: ÁßÅ„ÅØ‰∏ñÁïå„ÇíÊé¢Ê§ú„Åó„Å¶ÂÜíÈô∫„Åô„Çã„Åì„Å®„ÇíÂ§¢Ë¶ã„Å¶„ÅÑ„Åæ„ÅôÔºÅ
„Éä„É¨„Éº„Çø„Éº: „ÅÇ„ÇãÊó•„ÄÅÊÅê„Çç„Åó„ÅÑ„Éâ„É©„Ç¥„É≥„ÅåÂú∞Âπ≥Á∑ö„Å´Áèæ„Çå„Åæ„Åó„Åü„ÄÇ
„Éâ„É©„Ç¥„É≥: Ë™∞„ÅåÁßÅ„ÅÆÈ†òÂúü„Å´ÂÖ•„ÇãÂãáÊ∞ó„Åå„ÅÇ„Çã„ÅÆ„ÅãÔºü
„Éó„É™„É≥„Çª„Çπ: „ÅÇ„Å™„Åü„ÇíÊÅê„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅÊà¶„ÅÜ‰ª£„Çè„Çä„Å´ÂèãÈÅî„Å´„Å™„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ
„Éä„É¨„Éº„Çø„Éº: „Åù„Åó„Å¶„ÄÅÁèç„Åó„ÅÑÂèãÊÉÖ„ÅåÂßã„Åæ„Çä„Åæ„Åó„Åü...`
                    },
                    podcast: {
                        speakers: [
                            { name: '„Éõ„Çπ„Éà', voice: 'echo' },
                            { name: '„Ç≤„Çπ„Éà', voice: 'fable' }
                        ],
                        script: `„Éõ„Çπ„Éà: „Éù„ÉÉ„Éâ„Ç≠„É£„Çπ„Éà„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅ‰ªäÊó•„ÅØÁâπÂà•„Å™„Ç≤„Çπ„Éà„Çí„ÅäËøé„Åà„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
„Ç≤„Çπ„Éà: „ÅäÊãõ„Åç„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Åì„Åì„Å´Êù•„Çâ„Çå„Å¶Êú¨ÂΩì„Å´Â¨â„Åó„ÅÑ„Åß„Åô„ÄÇ
„Éõ„Çπ„Éà: „Åô„Åπ„Å¶„Åå„Å©„ÅÆ„Çà„ÅÜ„Å´Âßã„Åæ„Å£„Åü„ÅãÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
„Ç≤„Çπ„Éà: 2020Âπ¥„ÅÆÂ§è„Å´„Ç¢„Ç§„Éá„Ç¢„ÅåÊµÆ„Åã„Çì„Å†„Çì„Åß„Åô...
„Éõ„Çπ„Éà: Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÊúÄÂ§ß„ÅÆË™≤È°å„ÅØ‰Ωï„Åß„Åó„Åü„ÅãÔºü
„Ç≤„Çπ„Éà: ÊúÄÂ§ß„ÅÆË™≤È°å„ÅØÈñìÈÅï„ÅÑ„Å™„ÅèÂàùÊúüÊÆµÈöé„Åß„Åó„Åü„ÄÇ`
                    },
                    novel: {
                        speakers: [
                            { name: '„Éä„É¨„Éº„Çø„Éº', voice: 'alloy' },
                            { name: '‰∏ª‰∫∫ÂÖ¨', voice: 'nova' },
                            { name: 'ÊïµÂΩπ', voice: 'onyx' },
                            { name: '„É°„É≥„Çø„Éº', voice: 'echo' },
                            { name: 'Âèã‰∫∫', voice: 'fable' }
                        ],
                        script: `„Éä„É¨„Éº„Çø„Éº: Áâ©Ë™û„ÅåÂßã„Åæ„ÇãÊôÇ„ÄÅÂ§™ÈôΩ„ÅåË°ó„Å´Ê≤à„Çì„Åß„ÅÑ„Åæ„Åó„Åü„ÄÇ
‰∏ª‰∫∫ÂÖ¨: ‰ªäÊó•„Åô„Åπ„Å¶„ÅåÂ§â„Çè„Çã„Åì„Å®„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åó„Åü„ÄÇ
„É°„É≥„Çø„Éº: „ÅÇ„Å™„Åü„Å´„ÅØÂÅâÂ§ß„Å™„Åì„Å®„ÇíÊàê„ÅóÈÅÇ„Åí„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åó„Åã„Åó„ÄÅÈÅì„ÅØÁ∞°Âçò„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ
Âèã‰∫∫: ‰Ωï„Åå„ÅÇ„Å£„Å¶„ÇÇ„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Åù„Å∞„Å´„ÅÑ„Åæ„ÅôÔºÅ
ÊïµÂΩπ: ÂΩº„Çâ„ÅØÁöÜÂ§±Êïó„Åô„Çã„Å†„Çç„ÅÜ„ÄÇ„Åì„ÅÆË°ó„ÅØÁßÅ„ÅÆ„ÇÇ„ÅÆ„Å†„ÄÇ
„Éä„É¨„Éº„Çø„Éº: „Åù„Åó„Å¶„ÄÅÂÖâ„Å®Èóá„ÅÆÊà¶„ÅÑ„ÅåÂßã„Åæ„Å£„Åü...`
                    },
                    dialog: {
                        speakers: [
                            { name: '‰∫∫Áâ©A', voice: 'shimmer' },
                            { name: '‰∫∫Áâ©B', voice: 'alloy' }
                        ],
                        script: `‰∫∫Áâ©A: Êñ∞„Åó„ÅÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Åì„Å®ËÅû„ÅÑ„ÅüÔºü
‰∫∫Áâ©B: „ÅÜ„Çì„ÄÅ„Åô„Åî„ÅèÈù¢ÁôΩ„Åù„ÅÜÔºÅ„ÅÑ„Å§Âßã„Åæ„Çã„ÅÆÔºü
‰∫∫Áâ©A: Êù•ÈÄ±„Å†„Çà„ÄÇÂèÇÂä†„Åô„ÇãÔºü
‰∫∫Áâ©B: „ÇÇ„Å°„Çç„ÇìÔºÅ‰∏ÄÁ∑í„Å´„ÇÑ„Çç„ÅÜ„ÄÇ
‰∫∫Áâ©A: ÂÆåÁíßÔºÅÊ•Ω„Åó„Åø„Å†„Å≠„ÄÇ
‰∫∫Áâ©B: ÁßÅ„ÇÇ„ÄÇ„Åì„Çå„ÅØÁ¥†Êô¥„Çâ„Åó„ÅÑ„Åì„Å®„Å´„Å™„Çã„ÇàÔºÅ`
                    }
                },
            },
        };
        const apiSelect = document.getElementById('api-select');
        const speakersContainer = document.getElementById('speakers-container');
        const convertButton = document.getElementById('convert-button');
        const bookText = document.getElementById('book-text');
        const highlightLayer = document.getElementById('highlight-layer');
    // current API selection (kept in a variable for legacy code paths)
    let apiChoice = apiSelect ? apiSelect.value : 'openai';
    const scriptFontSelect = document.getElementById('script-font-select');
    const scriptFontSample = document.getElementById('script-font-sample');
        const addSpeakerButton = document.getElementById('add-speaker-button');
        const importSpeakersButton = document.getElementById('import-speakers-button');
        const langSelect = document.getElementById('lang-select');
        const buttonText = document.getElementById('button-text');
        const downloadLink = document.getElementById('download-link');
        // Prevent the default anchor navigation when no downloadable file is present
        if (downloadLink) {
            downloadLink.addEventListener('click', (e) => {
                // If no download filename set yet, prevent navigation (avoids jump-to-top)
                if (!downloadLink.download) {
                    e.preventDefault();
                }
            });
        }

        // Global guard: prevent anchors without href or with href="#" from navigating (common cause for jump-to-top)
        document.addEventListener('click', (e) => {
            const a = e.target.closest('a');
            if (!a) return;
            const href = a.getAttribute('href');
            if (!href || href === '#' || href.trim() === '') {
                e.preventDefault();
            }
        });
        const statusArea = document.getElementById('status-area');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const resultArea = document.getElementById('result-area');
        const audioPlayer = document.getElementById('audio-player');
        const equalizerCanvas = document.getElementById('equalizer');
        const saveProjectButton = document.getElementById('save-project-button');
        const loadProjectButton = document.getElementById('load-project-button');
        const projectStatusMessage = document.getElementById('project-status-message');
        const statsWordCount = document.getElementById('stats-word-count');
        const statsCharCount = document.getElementById('stats-char-count');
        const statsDuration = document.getElementById('stats-duration');

        // Script editor font handling
        function applyScriptEditorFont(font) {
            try {
                const editor = document.querySelector('.script-editor-container textarea');
                const highlight = document.getElementById('highlight-layer');
                if (editor) editor.style.fontFamily = font;
                if (highlight) highlight.style.fontFamily = font;
                if (scriptFontSample) scriptFontSample.style.fontFamily = font;
                localStorage.setItem('scriptFont', font);
            } catch (e) { console.warn('applyScriptEditorFont failed', e); }
        }

        // Initialize font select after DOM elements available
        try {
            const savedFont = localStorage.getItem('scriptFont') || "'Roboto Mono', monospace";
            if (scriptFontSelect) {
                // set saved value if present in options
                let found = false;
                Array.from(scriptFontSelect.options).forEach(opt => { if (opt.value === savedFont) found = true; });
                if (found) scriptFontSelect.value = savedFont;
                applyScriptEditorFont(scriptFontSelect.value || savedFont);
                scriptFontSelect.addEventListener('change', (e) => {
                    applyScriptEditorFont(e.target.value);
                });
            } else {
                // fallback: apply saved font to editor directly
                applyScriptEditorFont(savedFont);
            }
        } catch (e) { console.warn('script font init failed', e); }

        const GEMINI_VOICES = ['Zephyr','Puck','Charon','Kore','Fenrir','Leda','Orus','Aoede','Callirrhoe','Autonoe','Enceladus','Iapetus','Umbriel','Algieba','Despina','Erinome','Algenib','Rasalgethi','Laomedeia','Achernar','Alnilam','Schedar','Gacrux','Pulcherrima','Achird','Zubenelgenubi','Vindemiatrix','Sadachbia','Sadaltager','Sulafat'];
        const OPENAI_VOICES = ['nova','onyx','echo','shimmer','fable','alloy'];
        const POLLY_VOICES = ['Hans','Marlene','Vicki','Daniel','Hannah'];
        const ELEVENLABS_VOICE_MAP = {'Adam':'pNInz6obpgDQGcFUPNUG','Bella':'EXAVITQu4vr4xnSDxMaL','Arnold':'21m00Tcm4oz871Tymokv','Rachel':'ErXwBdymOqszjKVvANUN'};
        let currentLang = 'de';
        let activeTemplate = null; // Speichert das aktive Template f√ºr Re-Translation
        let activePreviewAudio = null;
        let audioContext, analyser, sourceNode, dataArray, animationFrameId;


        new Sortable(speakersContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function() {
                saveProject(true); // Save silently without showing message
            }
        });

        // --- Tooltip Logic ---
        let tooltipElement = null;
        let tooltipsAreEnabled = true;

        function handleTooltipMouseOver(e) {
            if (!tooltipsAreEnabled) return;

            const target = e.target.closest('[data-tooltip-key]');
            if (!target) return;

            if (tooltipElement) {
                tooltipElement.remove();
                tooltipElement = null;
            }

            const t = translations[currentLang];
            const key = target.getAttribute('data-tooltip-key');
            const text = t[key];
            if (!text) return;

            tooltipElement = document.createElement('div');
            tooltipElement.className = 'fixed bg-slate-800 text-white dark:bg-slate-200 dark:text-slate-800 text-xs font-semibold px-2 py-1 rounded-md shadow-lg z-50 transition-opacity duration-200 opacity-0 pointer-events-none';
            tooltipElement.textContent = text;
            document.body.appendChild(tooltipElement);

            const rect = target.getBoundingClientRect();
            const tooltipRect = tooltipElement.getBoundingClientRect();

            let top = rect.bottom + 8;
            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;

            if (left < 8) left = 8;
            if (left + tooltipRect.width > window.innerWidth - 8) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top + tooltipRect.height > window.innerHeight - 8) {
                top = rect.top - tooltipRect.height - 8;
            }

            tooltipElement.style.left = `${left}px`;
            tooltipElement.style.top = `${top}px`;
            
            requestAnimationFrame(() => {
                if(tooltipElement) tooltipElement.style.opacity = '1';
            });
        }

        function handleTooltipMouseOut(e) {
             if (tooltipElement) {
                tooltipElement.style.opacity = '0';
                setTimeout(() => {
                    if(tooltipElement) tooltipElement.remove();
                    tooltipElement = null;
                }, 200);
            }
        }
        
        document.body.addEventListener('mouseover', handleTooltipMouseOver);
        document.body.addEventListener('mouseout', handleTooltipMouseOut);

        const toggleTooltipsButton = document.getElementById('toggle-tooltips');
        const tooltipStatus = document.getElementById('tooltip-status');
        
        function setTooltipState(state) {
            const t = translations[currentLang];
            tooltipsAreEnabled = state === 'on';
            localStorage.setItem('tooltipsEnabled', state);
            tooltipStatus.textContent = state === 'on' ? t.status_on : t.status_off;
        }

        toggleTooltipsButton.addEventListener('click', () => {
            const newState = tooltipsAreEnabled ? 'off' : 'on';
            setTooltipState(newState);
        });

        setTooltipState(localStorage.getItem('tooltipsEnabled') ?? 'on');


        function setupAudioVisualizer() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                sourceNode = audioContext.createMediaElementSource(audioPlayer);
                sourceNode.connect(analyser);
                sourceNode.connect(audioContext.destination);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            }
        }
        
        function drawEqualizer() {
            animationFrameId = requestAnimationFrame(drawEqualizer);
            analyser.getByteFrequencyData(dataArray);

            const canvas = equalizerCanvas;
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            
            ctx.clearRect(0, 0, width, height);

            const barWidth = (width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const primaryColor = isDarkMode ? '#fecaca' : '#881337'; // rose-200 or rose-900

            for(let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] * (height / 255);
                
                ctx.fillStyle = primaryColor;
                ctx.fillRect(x, height - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        audioPlayer.addEventListener('play', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            setupAudioVisualizer();
            drawEqualizer();
        });

        audioPlayer.addEventListener('pause', () => {
             if(animationFrameId) cancelAnimationFrame(animationFrameId);
        });

        audioPlayer.addEventListener('ended', () => {
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
        });


        function updateConvertButtonText() {
            const t = translations[currentLang] || translations['de'];
            const selectedOptionText = apiSelect.options[apiSelect.selectedIndex].text;
            buttonText.textContent = `${t.convert_button_base} (${selectedOptionText})`;
            downloadLink.textContent = t.download_base;
        }

        function getAvailableVoices() {
            const selectedApi = apiSelect.value;
            if (selectedApi === 'openai') return OPENAI_VOICES;
            if (selectedApi === 'polly') return POLLY_VOICES;
            if (selectedApi === 'elevenlabs') return Object.keys(ELEVENLABS_VOICE_MAP);
            return GEMINI_VOICES;
        }

        function updateUI(lang) {
            const t = translations[lang] || translations['de'];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) el.placeholder = t[key];
            });
            updateConvertButtonText();
            updateScriptStats();
            
            // Lade Template neu, wenn eines aktiv ist
            if (activeTemplate) {
                reloadActiveTemplate();
            }
            // Refresh visual custom selects so translated option text is shown
            try {
                document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                    try { populateCustomSelect(w); } catch (e) { /* ignore */ }
                });
            } catch (e) {}
        }
        
        function reloadActiveTemplate() {
            if (!activeTemplate) return;
            
            const template = translations[currentLang].templates[activeTemplate];
            if (!template) return;
            
            // Leere Sprecher
            speakersContainer.innerHTML = '';
            
            // F√ºge √ºbersetzte Sprecher hinzu
            template.speakers.forEach(speaker => {
                speakersContainer.appendChild(addSpeakerRow(speaker.name, speaker.voice));
            });
            
            // Setze √ºbersetztes Skript
            setBookText(template.script, 'reloadActiveTemplate');
            
            // Update UI
            analyzeAndHighlightScript();
            updateScriptStats();
            calculateCosts();
            
            // Markiere aktiven Button (falls Template-Button existiert)
            const activeBtn = document.querySelector(`.template-btn[data-template="${activeTemplate}"]`);
            if (activeBtn) {
                document.querySelectorAll('.template-btn').forEach(b => {
                    b.classList.remove('ring-4', 'ring-offset-2', 'ring-rose-500', 'dark:ring-rose-400');
                    b.style.transform = 'scale(1)';
                });
                activeBtn.classList.add('ring-4', 'ring-offset-2', 'ring-rose-500', 'dark:ring-rose-400');
                activeBtn.style.transform = 'scale(1.05)';
            }
        }

        async function previewVoice(button, voice) {
            if (button.disabled) return;
            if(activePreviewAudio) activePreviewAudio.pause();

            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="spinner-small"></div>';
            button.disabled = true;

            const t = translations[currentLang];
            try {
                const payload = {
                    api: apiSelect.value,
                    script: `preview: ${t.voice_preview_text}`,
                    speakers: [{ name: 'preview', voice: apiSelect.value === 'elevenlabs' ? ELEVENLABS_VOICE_MAP[voice] : voice }]
                };
                const response = await fetch(PROXY_SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`Proxy error ${response.status}`);
                
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                activePreviewAudio = new Audio(audioUrl);
                activePreviewAudio.play();
                activePreviewAudio.onended = () => activePreviewAudio = null;
            } catch (error) {
                console.error('Voice preview failed:', error);
                setStatus('error', 'Stimmenvorschau fehlgeschlagen.');
            } finally {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        }

        function updateAllSpeakerVoiceOptions() {
            const availableVoices = getAvailableVoices();
            speakersContainer.querySelectorAll('.speaker-row').forEach(row => {
                const voiceSelect = row.querySelector('.speaker-voice');
                if (voiceSelect) {
                    const currentSelectedVoice = voiceSelect.value;
                    voiceSelect.innerHTML = availableVoices.map(voice => `<option value="${voice}">${voice}</option>`).join('');
                    voiceSelect.value = availableVoices.includes(currentSelectedVoice) ? currentSelectedVoice : availableVoices[0];
                }
            });
        }
        
        apiSelect.addEventListener('change', () => {
            updateAllSpeakerVoiceOptions();
            updateConvertButtonText();
        });

        langSelect.addEventListener('change', (e) => {
            currentLang = e.target.value;
            document.documentElement.lang = currentLang;
            updateUI(currentLang);
        });
        
        // ===== KOSTENRECHNER (NEU!) =====
        function calculateCosts() {
            const charCount = bookText.value.length;
            
            // Zeige Basis-Kosten f√ºr 10.000 Zeichen (1 Credit) wenn leer
            const baseChars = charCount === 0 ? 10000 : charCount;
            
            // OpenAI TTS: $150 pro 1M √ó 1.5 = $225 pro 1M (Verkaufspreis)
            // 10.000 Zeichen = $3.50
            const openaiCost = (baseChars / 1000000) * 225;
            document.getElementById('cost-openai').textContent = `$${openaiCost.toFixed(2)}`;
            
            // Gemini: $20 pro 1M √ó 3 = $60 pro 1M (Verkaufspreis, extra profitabel)
            // 10.000 Zeichen = $0.60
            const geminiCost = (baseChars / 1000000) * 60;
            document.getElementById('cost-gemini').textContent = `$${geminiCost.toFixed(2)}`;
            
            // ElevenLabs: $0.165/1k (Scale Plan Einkauf) √ó 1.5 = $2.70/1k (Verkaufspreis)
            // 10.000 Zeichen = $27.00 | Echte Gewinnmarge: ~16x
            const elevenlabsCost = (baseChars / 1000) * 2.70;
            document.getElementById('cost-elevenlabs').textContent = `$${elevenlabsCost.toFixed(2)}`;
            
            // Amazon Polly: $160 pro 1M √ó 1.5 = $240 pro 1M (Verkaufspreis)
            // 10.000 Zeichen = $2.40
            const pollyCost = (baseChars / 1000000) * 240;
            document.getElementById('cost-polly').textContent = `$${pollyCost.toFixed(2)}`;
            
            // Gesch√§tzte Zeit: ~2 Sek pro Segment
            const segments = bookText.value.split('\n').filter(line => line.includes(':')).length;
            const estimatedTime = segments === 0 ? 20 : segments * 2; // Default 20 Sek f√ºr 10k Zeichen
            document.getElementById('time-estimate').textContent = `~${estimatedTime} Sek`;
        }
        
        function updateScriptStats() {
            const text = bookText.value;
            const charCount = text.length;
            const words = text.trim() === '' ? [] : text.trim().split(/\s+/);
            const wordCount = words.length;
            
            statsCharCount.textContent = charCount;
            statsWordCount.textContent = wordCount;

            const WORDS_PER_MINUTE = 150;
            const totalSeconds = (wordCount / WORDS_PER_MINUTE) * 60;
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            const formattedDuration = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            statsDuration.textContent = `~ ${formattedDuration}`;
            
            // Update Kosten
            calculateCosts();
        }

        function analyzeAndHighlightScript() {
            const text = bookText.value;
            const existingSpeakers = Array.from(speakersContainer.querySelectorAll('.speaker-name'))
                .map(input => input.value.trim().toLowerCase())
                .filter(name => name);

            const escapedText = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const speakerRegex = /^(\s*[^:\n]+:)/gm;
            
            const highlightedHtml = escapedText.replace(speakerRegex, (match, speakerTag) => {
                const speakerName = speakerTag.slice(0, -1).trim().toLowerCase();
                if (speakerName && existingSpeakers.includes(speakerName)) {
                    return `<span class="speaker-ok">${speakerTag}</span>`;
                } else if (speakerName) {
                    return `<span class="speaker-unknown">${speakerTag}</span>`;
                }
                return speakerTag;
            });

            highlightLayer.innerHTML = highlightedHtml + '<br>';
        }

        function onSpeakerListChange() {
            updateSpeakerCount();
            setTimeout(analyzeAndHighlightScript, 50);
        }
        
        function updateSpeakerCount() {
            const count = speakersContainer.querySelectorAll('.speaker-row').length;
            const counterEl = document.getElementById('speaker-count');
            if (counterEl) {
                counterEl.textContent = count;
                counterEl.classList.toggle('hidden', count === 0);
            }
        }

        function addSpeakerRow(name = '', selectedVoice) {
            const div = document.createElement('div');
            div.className = 'speaker-row bg-slate-50 dark:bg-slate-900 p-3 rounded-lg grid grid-cols-[auto_1fr_auto] sm:grid-cols-[auto_1fr_1fr_auto] gap-x-3 gap-y-2 items-center';
            
            const availableVoices = getAvailableVoices();
            const finalSelectedVoice = availableVoices.includes(selectedVoice) ? selectedVoice : availableVoices[0];
            const voiceOptions = availableVoices.map(voice => `<option value="${voice}" ${voice === finalSelectedVoice ? 'selected' : ''}>${voice}</option>`).join('');
            const t = translations[currentLang];

            div.innerHTML = `
                <div class="drag-handle row-span-2 flex items-center justify-center text-slate-400 dark:text-slate-500 active:cursor-grabbing" data-tooltip-key="tooltip_drag">
                     <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <circle cx="9" cy="6" r="1.5" /><circle cx="15" cy="6" r="1.5" />
                        <circle cx="9" cy="12" r="1.5" /><circle cx="15" cy="12" r="1.5" />
                        <circle cx="9" cy="18" r="1.5" /><circle cx="15" cy="18" r="1.5" />
                    </svg>
                </div>

                <div class="col-span-1 sm:col-span-1">
                    <label class="text-xs font-medium text-slate-600 dark:text-gray-400 speaker-name-label">${t.char_name_label}</label>
                    <input type="text" value="${name}" class="speaker-name w-full mt-1 px-2 py-1.5 border-2 border-gray-200 dark:border-slate-800 rounded-md text-sm focus:border-red-500 dark:bg-slate-950 dark:text-white" placeholder="${t.char_name_input_placeholder}">
                </div>

                <div class="col-span-1 sm:col-span-1">
                    <label class="text-xs font-medium text-slate-600 dark:text-gray-400 speaker-voice-label">${t.voice_label}</label>
                    <div class="flex items-center gap-2 mt-1">
                        <select class="speaker-voice w-full px-2 py-1.5 border-2 border-gray-200 dark:border-slate-800 rounded-md text-sm focus:border-red-500 dark:bg-slate-950 dark:text-white">${voiceOptions}</select>
                        <button type="button" class="preview-voice-button flex-shrink-0 h-9 w-9 flex items-center justify-center bg-slate-200 text-slate-600 rounded-full hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600" data-tooltip-key="tooltip_preview">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div class="col-start-3 sm:col-start-4 row-start-1 row-span-2 flex items-center gap-1">
                     <button type="button" class="duplicate-speaker-button h-9 w-9 flex items-center justify-center bg-sky-100 text-sky-600 rounded-full hover:bg-sky-200 dark:bg-sky-900/50 dark:text-sky-400 dark:hover:bg-sky-900" data-tooltip-key="tooltip_duplicate">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M4 3a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H4z" /></svg>
                     </button>
                    <button type="button" class="remove-speaker-button h-9 w-9 flex items-center justify-center bg-red-100 text-red-600 rounded-full hover:bg-red-200 dark:bg-red-900/50 dark:text-red-400 dark:hover:bg-red-900" data-tooltip-key="tooltip_remove">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;
            
            div.querySelector('.remove-speaker-button').addEventListener('click', () => {
                div.remove();
                onSpeakerListChange();
            });

            div.querySelector('.duplicate-speaker-button').addEventListener('click', () => {
                const currentName = div.querySelector('.speaker-name').value;
                const currentVoice = div.querySelector('.speaker-voice').value;
                const t = translations[currentLang];
                const newName = `${currentName} ${t.char_copy_suffix || '(Copy)'}`;
                
                const newRow = addSpeakerRow(newName, currentVoice);
                div.insertAdjacentElement('afterend', newRow);
                onSpeakerListChange();
            });

            div.querySelector('.speaker-name').addEventListener('input', onSpeakerListChange);

            const previewButton = div.querySelector('.preview-voice-button');
            const voiceSelect = div.querySelector('.speaker-voice');
            previewButton.addEventListener('click', () => previewVoice(previewButton, voiceSelect.value));

            if (localStorage.getItem('inputGlow') !== 'off') {
                div.querySelectorAll('input, select').forEach(el => el.classList.add('input-glowing-active'));
            }
            onSpeakerListChange();
            return div;
        }

        // Backwards-compatible helper: older code calls `addSpeaker()`; keep a
        // thin wrapper that creates a row via addSpeakerRow and appends it to
        // the speakers container so existing call sites keep working.
        function addSpeaker(name = '', selectedVoice) {
            try {
                const row = addSpeakerRow(name, selectedVoice);
                if (speakersContainer) speakersContainer.appendChild(row);
                onSpeakerListChange();
                return row;
            } catch (err) {
                console.error('addSpeaker wrapper failed', err);
            }
        }

        function showProjectStatus(messageKey) {
            const t = translations[currentLang];
            projectStatusMessage.textContent = t[messageKey];
            projectStatusMessage.classList.remove('opacity-0');
            setTimeout(() => {
                projectStatusMessage.classList.add('opacity-0');
            }, 3000);
        }

        function saveProject(isSilent = false) {
            const speakerRows = speakersContainer.querySelectorAll('.speaker-row');
            const speakers = Array.from(speakerRows).map(row => ({
                name: row.querySelector('.speaker-name').value,
                voice: row.querySelector('.speaker-voice').value
            }));
            const projectData = {
                api: apiSelect.value,
                script: bookText.value,
                speakers: speakers,
            };
            localStorage.setItem('audiobookProject', JSON.stringify(projectData));
            if(!isSilent) showProjectStatus('project_saved');
        }

        function loadProject(isInitialLoad = false) {
            const savedData = localStorage.getItem('audiobookProject');
            if (savedData) {
                const projectData = JSON.parse(savedData);
                apiSelect.value = projectData.api;
                setBookText(projectData.script, 'loadProject');
                
                speakersContainer.innerHTML = ''; 
                
                if (projectData.speakers && projectData.speakers.length > 0) {
                    projectData.speakers.forEach(speaker => {
                       speakersContainer.appendChild(addSpeakerRow(speaker.name, speaker.voice));
                    });
                } else {
                    initializeSpeakers(false); 
                }
                
                updateAllSpeakerVoiceOptions();
                updateUI(currentLang); 

                if (!isInitialLoad) {
                    showProjectStatus('project_loaded');
                }
                onSpeakerListChange();
                return true;
            } else {
                if (!isInitialLoad) {
                    showProjectStatus('project_not_found');
                }
                return false;
            }
        }

        // Serialize current project to a portable JSON object
        function serializeProject() {
            try {
                const speakerRows = speakersContainer.querySelectorAll('.speaker-row');
                const speakers = Array.from(speakerRows).map(row => ({
                    name: row.querySelector('.speaker-name').value,
                    voice: row.querySelector('.speaker-voice').value
                }));

                const useSSML = (document.getElementById('use-ssml-checkbox') && document.getElementById('use-ssml-checkbox').checked) ? true : false;
                const project = {
                    version: '1.0.0',
                    timestamp: Date.now(),
                    meta: {
                        title: document.title || 'HHHoerbuch Projekt'
                    },
                    api: apiSelect ? apiSelect.value : null,
                    script: bookText ? bookText.value : '',
                    speakers: speakers,
                    settings: {
                        lang: currentLang,
                        featureSettings: featureSettings || {},
                        useSSML: useSSML
                    }
                };
                return project;
            } catch (e) {
                console.error('serializeProject failed', e);
                return null;
            }
        }

        // Trigger download of current project as JSON file
    async function exportProjectAsJSON() {
            const project = serializeProject();
            if (!project) {
                showProjectStatus('project_save_failed');
                return;
            }
            try {
                const json = JSON.stringify(project, null, 2);

                // Check if user requested password-protected export
                const encCheckbox = document.getElementById('project-encrypt-checkbox');
                const pwdInput = document.getElementById('project-password-input');
                const useEncryption = encCheckbox && encCheckbox.checked;
                if (useEncryption) {
                    const pwd = pwdInput ? pwdInput.value : '';
                    if (!pwd) {
                        // If no password entered, ask user
                        const p = prompt('Gib ein Passwort zum Sch√ºtzen des Projekts ein:');
                        if (!p) { showProjectStatus('project_save_failed'); return; }
                        try {
                            const wrapper = await encryptProjectJSON(json, p);
                            const blob = new Blob([JSON.stringify(wrapper, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `audiobook-project-${new Date().toISOString().replace(/[:\.]/g,'-')}.hhbproj.enc.json`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            setTimeout(() => URL.revokeObjectURL(url), 5000);
                            showProjectStatus('project_exported');
                            return;
                        } catch (e) { console.error('encryptProjectJSON failed', e); showProjectStatus('project_save_failed'); return; }
                    } else {
                        try {
                            const wrapper = await encryptProjectJSON(json, pwd);
                            const blob = new Blob([JSON.stringify(wrapper, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `audiobook-project-${new Date().toISOString().replace(/[:\.]/g,'-')}.hhbproj.enc.json`;
                            document.body.appendChild(a);
                            a.click();
                            a.remove();
                            setTimeout(() => URL.revokeObjectURL(url), 5000);
                            showProjectStatus('project_exported');
                            return;
                        } catch (e) { console.error('encryptProjectJSON failed', e); showProjectStatus('project_save_failed'); return; }
                    }
                }

                // Default: plain export with .hhbproj.json extension
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audiobook-project-${new Date().toISOString().replace(/[:\.]/g,'-')}.hhbproj.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 5000);
                showProjectStatus('project_exported');
            } catch (e) {
                console.error('exportProjectAsJSON failed', e);
                showProjectStatus('project_save_failed');
            }
        }

        // Import from a parsed project object (overwrites current project)
        function importProjectObject(obj) {
            try {
                // Basic validation
                if (!obj || typeof obj !== 'object') throw new Error('Ung√ºltiges Projektformat');
                // Optional version handling
                const v = obj.version || '1.0.0';
                // Overwrite fields
                if (obj.api && apiSelect) apiSelect.value = obj.api;
                if (obj.script && bookText) {
                    setBookText(obj.script, 'importProjectObject');
                }
                // Replace speakers
                if (Array.isArray(obj.speakers)) {
                    speakersContainer.innerHTML = '';
                    obj.speakers.forEach(s => {
                        try { speakersContainer.appendChild(addSpeakerRow(s.name || '', s.voice || '')); } catch(e){}
                    });
                }
                // Restore settings if present
                try { if (obj.settings && obj.settings.lang) currentLang = obj.settings.lang; } catch(e){}
                updateAllSpeakerVoiceOptions();
                updateUI(currentLang);
                onSpeakerListChange();
                showProjectStatus('project_imported');
                return true;
            } catch (e) {
                console.error('importProjectObject failed', e);
                showProjectStatus('project_import_failed');
                return false;
            }
        }

        // Import JSON text (string) -> parse -> import
        async function importProjectFromJSONText(text) {
            try {
                const obj = JSON.parse(text);

                // If file is an encrypted wrapper, decrypt first
                if (obj && obj.encrypted) {
                    try {
                        // Try to get password from UI first
                        const pwdInput = document.getElementById('project-password-input');
                        let pwd = pwdInput && pwdInput.value ? pwdInput.value : null;
                        if (!pwd) pwd = prompt('Dieses Projekt ist verschl√ºsselt. Bitte Passwort eingeben:');
                        if (!pwd) { showProjectStatus('project_import_failed'); return false; }
                        const dec = await decryptProjectJSON(obj, pwd);
                        const parsed = JSON.parse(dec);
                        // Show preview then import
                        try {
                            showProjectImportPreview(parsed, (confirmed) => {
                                if (confirmed) importProjectObject(parsed);
                            });
                            return true;
                        } catch (e) {
                            console.error('preview failed after decrypt, falling back to direct import', e);
                            return importProjectObject(parsed);
                        }
                    } catch (err) {
                        console.error('decryptProjectJSON failed', err);
                        showProjectStatus('project_import_failed');
                        return false;
                    }
                }

                // Plain object
                try {
                    showProjectImportPreview(obj, (confirmed) => {
                        if (confirmed) importProjectObject(obj);
                    });
                    return true;
                } catch (e) {
                    console.error('preview failed, falling back to direct import', e);
                    return importProjectObject(obj);
                }
            } catch (e) {
                console.error('importProjectFromJSONText failed', e);
                showProjectStatus('project_import_failed');
                return false;
            }
        }

        // Handle file input change
        function handleImportFileList(files) {
            if (!files || files.length === 0) return;
            const f = files[0];
            const reader = new FileReader();
            reader.onload = function(ev) {
                try { importProjectFromJSONText(ev.target.result); } catch (e) { console.error('file import read failed', e); }
            };
            reader.onerror = function(err) { console.error('file read error', err); showProjectStatus('project_import_failed'); };
            reader.readAsText(f, 'utf-8');
        }

        // --- Project import preview modal helper ---
        function formatTimestamp(ts) {
            try {
                if (!ts) return '-';
                const d = new Date(ts);
                return d.toLocaleString();
            } catch (e) { return String(ts); }
        }

        function showProjectImportPreview(obj, cb) {
            try {
                const modal = document.getElementById('project-import-preview-modal');
                const titleEl = document.getElementById('preview-meta-title');
                const verEl = document.getElementById('preview-version');
                const tsEl = document.getElementById('preview-timestamp');
                const spEl = document.getElementById('preview-speakers');
                const scriptEl = document.getElementById('preview-script');
                if (!modal || !titleEl) {
                    // If modal not present, fallback to direct import
                    cb(true);
                    return;
                }

                titleEl.textContent = (obj.meta && obj.meta.title) ? obj.meta.title : (obj.name || '-');
                verEl.textContent = obj.version || '-';
                tsEl.textContent = formatTimestamp(obj.timestamp);
                try {
                    const s = Array.isArray(obj.speakers) ? obj.speakers.map(x => x.name || '').filter(Boolean).join(', ') : '-';
                    spEl.textContent = s || '-';
                } catch (e) { spEl.textContent = '-'; }

                try {
                    const previewText = (obj.script || '').trim().slice(0, 800);
                    scriptEl.textContent = previewText || '-';
                } catch (e) { scriptEl.textContent = '-'; }

                // Show modal
                modal.classList.remove('hidden');

                const close = () => { modal.classList.add('hidden'); cleanup(); };
                const cleanup = () => {
                    document.getElementById('project-import-preview-confirm').removeEventListener('click', onConfirm);
                    document.getElementById('project-import-preview-cancel').removeEventListener('click', onCancel);
                    document.getElementById('project-import-preview-close').removeEventListener('click', onCancel);
                };

                const onConfirm = () => { try { close(); cb(true); } catch (e) { console.error(e); cb(true); } };
                const onCancel = () => { try { close(); cb(false); } catch (e) { console.error(e); cb(false); } };

                document.getElementById('project-import-preview-confirm').addEventListener('click', onConfirm);
                document.getElementById('project-import-preview-cancel').addEventListener('click', onCancel);
                document.getElementById('project-import-preview-close').addEventListener('click', onCancel);
            } catch (e) {
                console.error('showProjectImportPreview failed', e);
                try { cb(true); } catch (err) {}
            }
        }

        // --- Client-side encryption helpers (Web Crypto, AES-GCM + PBKDF2) ---
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }

        async function deriveKey(password, salt) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
            const key = await window.crypto.subtle.deriveKey({ name: 'PBKDF2', salt: salt, iterations: 150000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
            return key;
        }

        async function encryptProjectJSON(jsonString, password) {
            const enc = new TextEncoder();
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(password, salt.buffer);
            const cipher = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, key, enc.encode(jsonString));
            return {
                encrypted: true,
                version: '1.0',
                salt: arrayBufferToBase64(salt.buffer),
                iv: arrayBufferToBase64(iv.buffer),
                data: arrayBufferToBase64(cipher)
            };
        }

        async function decryptProjectJSON(wrapper, password) {
            try {
                const salt = base64ToArrayBuffer(wrapper.salt);
                const iv = base64ToArrayBuffer(wrapper.iv);
                const data = base64ToArrayBuffer(wrapper.data);
                const key = await deriveKey(password, salt);
                const plainBuf = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, data);
                const dec = new TextDecoder().decode(plainBuf);
                return dec;
            } catch (e) {
                throw new Error('Decrypt failed: ' + (e && e.message));
            }
        }

        // Lightweight toast helper
        function showToast(message, type = 'info', duration = 3500) {
            try {
                const id = '__hh_toast_' + Date.now();
                const el = document.createElement('div');
                el.id = id;
                const base = 'fixed bottom-6 right-6 z-60 max-w-sm w-auto p-3 rounded-lg shadow-lg transform transition-all';
                let color = 'bg-slate-800 text-white';
                if (type === 'success') color = 'bg-emerald-600 text-white';
                if (type === 'error') color = 'bg-red-600 text-white';
                if (type === 'warn') color = 'bg-yellow-500 text-black';
                el.className = base + ' ' + color;
                el.style.opacity = '0';
                el.style.transition = 'opacity 200ms ease, transform 200ms ease';
                el.innerText = message;
                document.body.appendChild(el);
                requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
                setTimeout(() => {
                    try { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); } catch (e) {}
                }, duration);
            } catch (e) { console.error('showToast failed', e); }
        }

        // Conservative SSML -> provider-safe mapping
        // - For providers assumed to support SSML (openai, gemini) we pass through
        // - For others we strip most tags, convert <break/> to paragraph breaks and keep inner text
        function sanitizeScriptForProvider(script, provider, useSSML) {
            try {
                if (!useSSML) return script;
                if (!script || typeof script !== 'string') return script;
                const low = (provider || '').toString().toLowerCase();
                // providers we assume support SSML (pass-through)
                if (low === 'openai' || low === 'gemini') return script;

                // Conservative transformations for non-SSML providers
                let s = script;
                // Replace <break time="..."/> or <break ...></break> with two newlines
                s = s.replace(/<break\b[^>]*\/?>/gi, '\n\n');
                // Collapse multiple newlines
                s = s.replace(/\n{3,}/g, '\n\n');
                // Unwrap prosody/emphasis while keeping inner text
                s = s.replace(/<prosody\b[^>]*>([\s\S]*?)<\/prosody>/gi, '$1');
                s = s.replace(/<emphasis\b[^>]*>([\s\S]*?)<\/emphasis>/gi, '$1');
                // Remove any remaining tags but keep content
                s = s.replace(/<[^>]+>/g, '');
                return s;
            } catch (e) {
                console.error('sanitizeScriptForProvider failed', e);
                return script;
            }
        }

        // --- Snapshot manager functions ---
        function getSnapshotHistory() {
            try {
                const key = 'hhb_project_history_v1';
                const raw = localStorage.getItem(key) || '[]';
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch (e) { console.error('getSnapshotHistory failed', e); return []; }
        }

        function saveSnapshotHistory(arr) {
            try { localStorage.setItem('hhb_project_history_v1', JSON.stringify(arr)); return true; } catch (e) { console.error('saveSnapshotHistory failed', e); return false; }
        }

        function openSnapshotManager() {
            const modal = document.getElementById('snapshot-manager-modal');
            const list = document.getElementById('snapshot-list');
            if (!modal || !list) return;
            list.innerHTML = '';
            const hist = getSnapshotHistory();
            if (!hist || hist.length === 0) {
                list.innerHTML = '<div class="text-sm text-gray-500">Keine Snapshots gefunden.</div>';
            } else {
                hist.slice().reverse().forEach((item, idx) => {
                    const realIndex = hist.length - 1 - idx;
                    const row = document.createElement('div');
                    row.className = 'p-3 border rounded flex items-start justify-between gap-3 bg-slate-50 dark:bg-slate-800';
                    const left = document.createElement('div');
                    left.className = 'flex-1';
                    const d = new Date(item.timestamp || Date.now());
                    left.innerHTML = `<div class="font-semibold">${item.meta && item.meta.title ? item.meta.title : 'Snapshot'}</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">${d.toLocaleString()} ‚Ä¢ Version: ${item.version || '-'}</div>
                        <div class="text-xs mt-2 whitespace-pre-wrap text-gray-700 dark:text-gray-300">${(item.scriptPreview||'').slice(0,300)}</div>`;
                    const controls = document.createElement('div');
                    controls.className = 'flex flex-col gap-2';
                    const loadBtn = document.createElement('button'); loadBtn.className = 'px-3 py-1 rounded bg-emerald-200 dark:bg-emerald-700 text-emerald-800 dark:text-emerald-100 text-sm'; loadBtn.textContent = 'Laden';
                    const delBtn = document.createElement('button'); delBtn.className = 'px-3 py-1 rounded bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-200 text-sm'; delBtn.textContent = 'L√∂schen';
                    loadBtn.addEventListener('click', () => { try { loadSnapshot(realIndex); closeSnapshotManager(); } catch(e){ console.error('loadSnapshot failed', e); } });
                    delBtn.addEventListener('click', () => { try { deleteSnapshot(realIndex); openSnapshotManager(); } catch(e){ console.error('deleteSnapshot failed', e); } });
                    controls.appendChild(loadBtn); controls.appendChild(delBtn);
                    row.appendChild(left); row.appendChild(controls);
                    list.appendChild(row);
                });
            }
            modal.classList.remove('hidden');

            document.getElementById('snapshot-manager-close').addEventListener('click', closeSnapshotManager);
            document.getElementById('snapshot-manager-close-2').addEventListener('click', closeSnapshotManager);
            document.getElementById('snapshot-clear-all').addEventListener('click', () => { if (confirm('Alle Snapshots l√∂schen?')) { saveSnapshotHistory([]); openSnapshotManager(); } });
        }

        function closeSnapshotManager() { const modal = document.getElementById('snapshot-manager-modal'); if (modal) modal.classList.add('hidden'); }

        function loadSnapshot(index) {
            try {
                const hist = getSnapshotHistory();
                if (!hist || !hist[index]) { showProjectStatus('project_load_failed'); return false; }
                const obj = hist[index].project;
                if (!obj) { showProjectStatus('project_load_failed'); return false; }
                // Use existing import flow
                importProjectObject(obj);
                showProjectStatus('project_loaded');
                return true;
            } catch (e) { console.error('loadSnapshot failed', e); showProjectStatus('project_load_failed'); return false; }
        }

        function deleteSnapshot(index) { try { const hist = getSnapshotHistory(); if (!hist || !hist[index]) return false; hist.splice(index,1); saveSnapshotHistory(hist); return true; } catch(e){ console.error('deleteSnapshot failed', e); return false; }
        }

        // Clean duplicate lines/paragraphs in script text
        function cleanScriptDuplicates(text) {
            try {
                if (!text || typeof text !== 'string') return text;
                // Normalize line endings
                let t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                // Split into paragraphs (blocks separated by one or more empty lines)
                const paragraphs = t.split(/\n\s*\n/);
                const seen = new Set();
                const cleanedParas = [];
                paragraphs.forEach(p => {
                    const trimmed = p.trim();
                    if (!trimmed) return;
                    // If paragraph already seen, skip
                    const key = trimmed.replace(/\s+/g, ' ');
                    if (!seen.has(key)) {
                        seen.add(key);
                        cleanedParas.push(trimmed);
                    }
                });

                // Also remove consecutive duplicate lines inside paragraphs
                const cleaned = cleanedParas.map(p => {
                    const lines = p.split('\n');
                    const out = [];
                    for (let i = 0; i < lines.length; i++) {
                        const ln = lines[i].trim();
                        if (ln === '') continue;
                        if (i > 0 && lines[i - 1].trim() === ln) continue; // skip immediate duplicate
                        out.push(lines[i]);
                    }
                    return out.join('\n');
                }).join('\n\n');

                return cleaned;
            } catch (e) {
                console.error('cleanScriptDuplicates failed', e);
                return text;
            }
        }

        // Detect and collapse if the entire script is a repeated concatenation
        // e.g. "PARTPARTPART" -> returns "PART" if PART repeats >= 2 times
        function collapseRepeatedWholeScript(text) {
            try {
                if (!text || typeof text !== 'string') return text;
                // Normalize whitespace and line endings for repeat detection
                const t = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                // Only consider reasonably long text for this heuristic
                if (t.length < 100) return text;

                // Try to find a smallest period where the string is a repetition
                // We'll attempt period lengths up to half the string length
                const n = t.length;
                for (let p = 1; p <= Math.floor(n / 2); p++) {
                    if (n % p !== 0) continue;
                    const piece = t.slice(0, p);
                    let ok = true;
                    for (let i = p; i < n; i += p) {
                        if (t.slice(i, i + p) !== piece) { ok = false; break; }
                    }
                    if (ok) {
                        // Found repeating piece; return single piece trimmed
                        return piece.trim();
                    }
                }

                // Heuristic for concatenated repeats with small separators (e.g. extra newlines)
                // Split by large separators and check if identical blocks repeat
                const paras = t.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
                if (paras.length >= 2) {
                    // If first block repeats across most blocks, we collapse
                    const first = paras[0];
                    const repeats = paras.every(p => p === first);
                    if (repeats) return first;
                }

                return text;
            } catch (e) {
                console.error('collapseRepeatedWholeScript failed', e);
                return text;
            }
        }

        // Central setter for the script textarea ‚Äî logs caller and applies cleaning heuristics.
        function setBookText(value, source = 'unknown') {
            try {
                if (!bookText) return;
                const prev = bookText.value || '';
                // Basic normalization
                const normalized = (value || '').toString();

                // If identical, do nothing
                if (prev === normalized) return;

                // If the new value contains obvious repeated concatenations, collapse them
                let candidate = cleanScriptDuplicates(normalized);
                const collapsed = collapseRepeatedWholeScript(candidate);

                const final = (collapsed && collapsed.length < candidate.length) ? collapsed : candidate;

                bookText.value = final;

                // Update UI and stats
                updateScriptStats();
                analyzeAndHighlightScript();

                // Log to console with stack to help debugging where the assignment came from
                try {
                    const st = (new Error()).stack.split('\n').slice(2,6).join('\n');
                    console.info('[bookText] set by', source, '\nstack:\n', st);
                } catch(e) { /* ignore */ }
            } catch (e) { console.error('setBookText failed', e); }
        }

        // Detect suspicious full-script repeats and propose cleanup to the user
        function detectSuspiciousRepeats() {
            try {
                if (!bookText) return null;
                const val = bookText.value || '';
                const collapsed = collapseRepeatedWholeScript(val);
                if (collapsed && collapsed.length < val.length && val.length > 500) {
                    // significant reduction found
                    return collapsed;
                }
                return null;
            } catch (e) { console.error('detectSuspiciousRepeats failed', e); return null; }
        }

        // Offer user to apply aggressive cleanup on input if repeats detected
        if (typeof bookText !== 'undefined' && bookText) {
            bookText.addEventListener('input', () => {
                try {
                    const suggestion = detectSuspiciousRepeats();
                    if (suggestion) {
                        const preview = suggestion.length > 300 ? suggestion.slice(0,300) + '‚Ä¶' : suggestion;
                        const ok = confirm('Ich habe m√∂gliche Wiederholungen in deinem Skript erkannt. Vorschau:\n\n' + preview + '\n\nSoll ich die mehrfach eingef√ºgten Teile entfernen?');
                        if (ok) {
                            setBookText(suggestion, 'auto-detect-input');
                            showProjectStatus('script_cleaned_aggressive');
                        }
                    }
                } catch(e) { /* non-fatal */ }
            });
        }

        // ===== SSML / Prosody Editor Helpers =====
        function wrapSelectionWithTags(startTag, endTag) {
            try {
                const ta = document.getElementById('book-text');
                if (!ta) return;
                const start = ta.selectionStart;
                const end = ta.selectionEnd;
                const before = ta.value.slice(0, start);
                const sel = ta.value.slice(start, end) || '';
                const after = ta.value.slice(end);
                ta.value = before + startTag + sel + endTag + after;
                // restore selection around inner content
                const newStart = start + startTag.length;
                const newEnd = newStart + sel.length;
                ta.focus();
                ta.setSelectionRange(newStart, newEnd);
                updateScriptStats();
                analyzeAndHighlightScript();
            } catch (e) { console.error('wrapSelectionWithTags failed', e); }
        }

        function insertBreak(timeMs = 500) {
            const tag = `<break time=\"${timeMs}ms\"/>`;
            try {
                const ta = document.getElementById('book-text');
                if (!ta) return;
                const pos = ta.selectionEnd || ta.value.length;
                const before = ta.value.slice(0, pos);
                const after = ta.value.slice(pos);
                ta.value = before + tag + after;
                ta.focus();
                ta.setSelectionRange(pos + tag.length, pos + tag.length);
                updateScriptStats();
                analyzeAndHighlightScript();
            } catch (e) { console.error('insertBreak failed', e); }
        }

        function applyProsodyRate(rateKey) {
            try {
                const ta = document.getElementById('book-text');
                if (!ta) return;
                const selStart = ta.selectionStart;
                const selEnd = ta.selectionEnd;
                const sel = ta.value.slice(selStart, selEnd) || '';
                const rateAttr = rateKey === 'default' ? '' : ` rate=\"${rateKey}\"`;
                const startTag = `<prosody${rateAttr}>`;
                const endTag = `</prosody>`;
                if (sel.length > 0) {
                    wrapSelectionWithTags(startTag, endTag);
                } else {
                    // insert empty prosody wrapper
                    const pos = ta.selectionEnd || ta.value.length;
                    const before = ta.value.slice(0, pos);
                    const after = ta.value.slice(pos);
                    ta.value = before + startTag + endTag + after;
                    ta.focus();
                    ta.setSelectionRange(pos + startTag.length, pos + startTag.length);
                }
                updateScriptStats();
            } catch (e) { console.error('applyProsodyRate failed', e); }
        }

        function previewSSML() {
            try {
                const ta = document.getElementById('book-text');
                if (!ta) return;
                const sel = (ta.selectionStart !== ta.selectionEnd) ? ta.value.slice(ta.selectionStart, ta.selectionEnd) : ta.value;
                const ssml = sel || '';
                // Fallback preview using speechSynthesis: strip SSML tags and speak plain text, map rate
                const plain = ssml.replace(/<[^>]+>/g, '');
                if (window.speechSynthesis) {
                    const u = new SpeechSynthesisUtterance(plain);
                    const rateSel = document.getElementById('ssml-rate-select');
                    const rateKey = rateSel ? rateSel.value : 'default';
                    const rateMap = { default: 1.0, slow: 0.85, medium: 1.0, fast: 1.25 };
                    u.rate = rateMap[rateKey] || 1.0;
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(u);
                    showProjectStatus('ssml_preview_playing');
                } else {
                    alert('Keine lokale TTS-Unterst√ºtzung f√ºr Preview verf√ºgbar.');
                }
            } catch (e) { console.error('previewSSML failed', e); showProjectStatus('ssml_preview_failed'); }
        }

        // Wire toolbar buttons
        try {
            const btnBreak = document.getElementById('ssml-insert-break');
            const btnEmph = document.getElementById('ssml-wrap-emphasis');
            const btnStrong = document.getElementById('ssml-wrap-strong');
            const rateSelect = document.getElementById('ssml-rate-select');
            const previewBtn = document.getElementById('ssml-preview-button');
            const cleanupBtn = document.getElementById('script-cleanup-button');
            if (btnBreak) btnBreak.addEventListener('click', () => insertBreak(500));
            if (btnEmph) btnEmph.addEventListener('click', () => wrapSelectionWithTags('<emphasis level=\"moderate\">', '</emphasis>'));
            if (btnStrong) btnStrong.addEventListener('click', () => wrapSelectionWithTags('<emphasis level=\"strong\">', '</emphasis>'));
            if (rateSelect) rateSelect.addEventListener('change', (e) => applyProsodyRate(e.target.value));
            if (previewBtn) previewBtn.addEventListener('click', previewSSML);
            if (cleanupBtn) cleanupBtn.addEventListener('click', () => {
                try {
                    const ta = document.getElementById('book-text');
                    if (!ta) return;
                    const before = ta.value;
                    const cleaned = cleanScriptDuplicates(before);
                    if (cleaned !== before) {
                        // Use central setter so cleaning and logging run consistently
                        setBookText(cleaned, 'script-cleanup-button');
                        showProjectStatus('script_cleaned');
                    } else {
                        showProjectStatus('script_no_duplicates');
                    }
                } catch(e) { console.error('cleanup action failed', e); }
            });

            const aggressiveBtn = document.getElementById('script-cleanup-aggressive-button');
            if (aggressiveBtn) aggressiveBtn.addEventListener('click', () => {
                try {
                    const ta = document.getElementById('book-text');
                    if (!ta) return;
                    const before = ta.value;
                    // First apply paragraph/line dedupe
                    let candidate = cleanScriptDuplicates(before);
                    // Then attempt whole-script collapse
                    const collapsed = collapseRepeatedWholeScript(candidate);
                    if (collapsed !== before && collapsed !== candidate) {
                        // Show a short preview and ask for confirmation
                        const preview = collapsed.length > 400 ? collapsed.slice(0, 400) + '‚Ä¶' : collapsed;
                        const ok = confirm('Aggressive Bereinigung gefunden ‚Äî Vorschau:\n\n' + preview + '\n\n√Ñnderung anwenden und Mehrfach-Versionen entfernen?');
                        if (ok) {
                            // Use central setter to apply and log the aggressive collapse
                            setBookText(collapsed, 'script-cleanup-aggressive');
                            showProjectStatus('script_cleaned_aggressive');
                        } else {
                            showProjectStatus('script_cleaned_cancelled');
                        }
                    } else if (collapsed !== candidate) {
                        // collapsed changed after paragraph dedupe
                        const preview = collapsed.length > 400 ? collapsed.slice(0, 400) + '‚Ä¶' : collapsed;
                        const ok = confirm('Aggressive Bereinigung gefunden ‚Äî Vorschau:\n\n' + preview + '\n\n√Ñnderung anwenden?');
                        if (ok) {
                            setBookText(collapsed, 'script-cleanup-aggressive');
                            showProjectStatus('script_cleaned_aggressive');
                        } else {
                            showProjectStatus('script_cleaned_cancelled');
                        }
                    } else {
                        // Nothing aggressive detected; fallback message
                        showProjectStatus('script_no_duplicates');
                    }
                } catch (e) { console.error('aggressive cleanup failed', e); showProjectStatus('script_clean_failed'); }
            });
        } catch (e) { console.warn('SSML toolbar wiring failed', e); }


        // Wire the new export/import controls (if present)
        try {
            const exportBtn = document.getElementById('export-project-button');
            const importBtn = document.getElementById('import-project-json-button');
            const fileInput = document.getElementById('import-project-file-input');
            if (exportBtn) exportBtn.addEventListener('click', exportProjectAsJSON);
            if (importBtn) importBtn.addEventListener('click', () => { if (fileInput) fileInput.click(); else { const txt = prompt('Projekt JSON einf√ºgen:'); if (txt) importProjectFromJSONText(txt); } });
            if (fileInput) fileInput.addEventListener('change', (e) => handleImportFileList(e.target.files));

            // Encryption UI wiring
            const encCheckbox = document.getElementById('project-encrypt-checkbox');
            const pwdInput = document.getElementById('project-password-input');
            const snapshotBtn = document.getElementById('project-save-snapshot');
            if (encCheckbox && pwdInput) {
                encCheckbox.addEventListener('change', (e) => {
                    try {
                        console.info('project-encrypt-checkbox toggled:', e.target.checked);
                        if (e.target.checked) {
                            pwdInput.style.display = 'inline-block';
                            showToast('Passwortschutz aktiviert ‚Äî Vergiss dein Passwort nicht!', 'warn', 5000);
                        } else {
                            pwdInput.style.display = 'none';
                            pwdInput.value = '';
                        }
                    } catch(e){ console.error('encrypt checkbox handler failed', e); }
                });
            }
            if (snapshotBtn) {
                snapshotBtn.addEventListener('click', () => {
                    try {
                        console.info('project-save-snapshot clicked');
                        showProjectStatus('project_snapshot_saving');
                        const project = serializeProject();
                        if (!project) { showProjectStatus('project_save_failed'); return; }
                        const key = 'hhb_project_history_v1';
                        const histRaw = localStorage.getItem(key) || '[]';
                        let hist = [];
                        try { hist = JSON.parse(histRaw); if (!Array.isArray(hist)) hist = []; } catch(e) { hist = []; }
                        hist.push({ timestamp: Date.now(), meta: project.meta || {}, version: project.version || '1.0', scriptPreview: (project.script||'').slice(0,400), project });
                        localStorage.setItem(key, JSON.stringify(hist));
                        console.info('snapshot saved, total snapshots:', hist.length);
                                    showProjectStatus('project_snapshot_saved');
                                    showToast('Snapshot gespeichert', 'success');
                    } catch(e) { console.error('snapshot save failed', e); showProjectStatus('project_save_failed'); }
                });
            }
            // Snapshot manager open
            const manageBtn = document.getElementById('project-manage-snapshots');
            if (manageBtn) {
                manageBtn.addEventListener('click', () => {
                    try { openSnapshotManager(); } catch (e) { console.error('openSnapshotManager failed', e); }
                });
            }
        } catch (e) { console.warn('Export/Import wiring failed', e); }

        // Updated: make the bottom Project Verwaltung buttons use OS file dialogs
        // - "Projekt speichern" will download the current project JSON to the user's computer
        // - "Projekt laden" will open a file picker to import a project JSON
        saveProjectButton.addEventListener('click', (ev) => {
            // If user holds Alt/Option, fall back to library save; otherwise export to disk
            if (ev.altKey) return saveProject(false);
            try { exportProjectAsJSON(); } catch (e) { console.error('exportProjectAsJSON failed from save button', e); saveProject(false); }
        });

        loadProjectButton.addEventListener('click', (ev) => {
            // If user holds Alt/Option, fall back to library load; otherwise open file picker
            if (ev.altKey) return loadProject(false);
            try {
                const fileInput = document.getElementById('import-project-file-input');
                if (fileInput) {
                    fileInput.click();
                } else {
                    // Fallback to prompt-based import
                    const txt = prompt('Projekt JSON einf√ºgen:');
                    if (txt) importProjectFromJSONText(txt);
                }
            } catch (e) { console.error('load button open file dialog failed', e); loadProject(false); }
        });

        function importSpeakersFromScript() {
            console.debug('[DEBUG] importSpeakersFromScript invoked');
            const script = (bookText && bookText.value) ? bookText.value : '';
            // Quick visible debug toast so the user sees the handler fired
            try {
                const dbg = document.createElement('div');
                dbg.id = '__debug-import-toast';
                dbg.className = 'fixed bottom-6 left-6 bg-yellow-500 text-black px-4 py-2 rounded shadow-lg z-60';
                dbg.textContent = 'Import: handler aufgerufen';
                document.body.appendChild(dbg);
                setTimeout(() => { try { dbg.remove(); } catch(e){} }, 1800);
            } catch(e) { console.debug('debug toast failed', e); }

            if (!script.trim()) {
                console.debug('[DEBUG] import aborted ‚Äî script empty');
                // Provide gentle feedback instead of silently returning
                try {
                    projectStatusMessage.textContent = 'Kein Skript zum Importieren';
                    projectStatusMessage.classList.remove('opacity-0');
                    setTimeout(() => projectStatusMessage.classList.add('opacity-0'), 2500);
                } catch (e) { /* non-fatal */ }
                return;
            }

            const speakerRegex = /^\s*([^:\n]+):/gm;
            const matches = [...script.matchAll(speakerRegex)];
            const speakersInScript = [...new Set(matches.map(match => match[1].trim()))];
            console.debug('[DEBUG] import matches:', matches.length, 'unique speakers:', speakersInScript);

            const existingSpeakersLowerCase = Array.from(speakersContainer.querySelectorAll('.speaker-name')).map(input => input.value.trim().toLowerCase());
            
            let newSpeakersAdded = 0;
            // Auto-assign voices: prefer unused voices, fallback to round-robin
            try {
                const availableVoices = getAvailableVoices();
                const usedVoices = new Set(Array.from(speakersContainer.querySelectorAll('.speaker-voice')).map(s => s.value));
                let rr = 0;
                speakersInScript.forEach(speakerName => {
                    if (speakerName && !existingSpeakersLowerCase.includes(speakerName.toLowerCase())) {
                        // pick voice
                        let voice = availableVoices.find(v => !usedVoices.has(v));
                        if (!voice) {
                            voice = availableVoices[rr % availableVoices.length] || availableVoices[0];
                            rr++;
                        }
                        usedVoices.add(voice);
                        speakersContainer.appendChild(addSpeakerRow(speakerName, voice));
                        newSpeakersAdded++;
                    }
                });
            } catch (e) {
                // If anything goes wrong, fall back to simple add
                speakersInScript.forEach(speakerName => {
                    if (speakerName && !existingSpeakersLowerCase.includes(speakerName.toLowerCase())) {
                        speakersContainer.appendChild(addSpeakerRow(speakerName));
                        newSpeakersAdded++;
                    }
                });
            }

            if (newSpeakersAdded > 0) {
                console.debug('[DEBUG] new speakers added:', newSpeakersAdded);
                showProjectStatus('speakers_imported');
            } else {
                console.debug('[DEBUG] no new speakers detected');
                showProjectStatus('no_new_speakers_found');
            }
            onSpeakerListChange();
        }

        // Ensure the import button handler is attached after DOM is ready.
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('import-speakers-button');
            if (btn) {
                try { btn.addEventListener('click', importSpeakersFromScript); console.info('importSpeakersFromScript handler attached to #import-speakers-button'); } catch (e) { console.warn('Failed to attach importSpeakersFromScript handler', e); }
            } else {
                console.warn('importSpeakersButton not found on DOMContentLoaded ‚Äî import will still work via delegated fallback');
            }
        });

        // Make function available on window so users can call it from DevTools
        // even if the page scope differs (helps with debugging / older browser caches).
        try {
            window.importSpeakersFromScript = importSpeakersFromScript;
            console.info('importSpeakersFromScript exported to window');
        } catch (e) {
            console.warn('Failed to export importSpeakersFromScript to window', e);
        }

        // Fallback: delegated click listener so the import works even if the button is
        // created dynamically after load (very low overhead).
        document.body.addEventListener('click', (ev) => {
            const b = ev.target.closest ? ev.target.closest('#import-speakers-button') : null;
            if (b) {
                try { importSpeakersFromScript(); } catch (e) { console.error('Delegated importSpeakersFromScript failed', e); }
            }
        });

        // ==================== AUTO SPEAKER DETECTION (Feature #5) ====================
        
        let autoDetectionTimeout = null;
        let lastDetectedSpeakers = new Set();
        
        // Auto-detect speakers while typing (if feature enabled)
        function autoDetectSpeakers() {
            if (!featureSettings.autoSpeaker) return;
            
            const script = bookText.value;
            if (!script.trim()) return;

            const speakerRegex = /^\s*([^:\n]+):/gm;
            const matches = [...script.matchAll(speakerRegex)];
            const speakersInScript = [...new Set(matches.map(match => match[1].trim()))];

            const existingSpeakersLowerCase = Array.from(speakersContainer.querySelectorAll('.speaker-name')).map(input => input.value.trim().toLowerCase());
            
            let newSpeakersAdded = 0;
            const newSpeakerNames = [];
            
            speakersInScript.forEach(speakerName => {
                if (speakerName && 
                    !existingSpeakersLowerCase.includes(speakerName.toLowerCase()) &&
                    !lastDetectedSpeakers.has(speakerName.toLowerCase())) {
                    
                    speakersContainer.appendChild(addSpeakerRow(speakerName));
                    lastDetectedSpeakers.add(speakerName.toLowerCase());
                    newSpeakersAdded++;
                    newSpeakerNames.push(speakerName);
                }
            });

            if (newSpeakersAdded > 0) {
                showAutoDetectionToast(newSpeakersAdded, newSpeakerNames);
                onSpeakerListChange();
            }
        }

        // Show toast notification for auto-detected speakers
        function showAutoDetectionToast(count, names) {
            const t = translations[currentLang];
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-6 right-6 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300 flex items-center gap-3 max-w-md';
            toast.innerHTML = `
                <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                <div class="flex-1">
                    <div class="font-bold">${t.auto_detect_title || 'ü§ñ KI-Erkennung'}</div>
                    <div class="text-sm opacity-90">
                        ${count} ${t.auto_detect_new_speakers || 'neue Sprecher erkannt'}: ${names.join(', ')}
                    </div>
                </div>
                <button onclick="(this.parentElement && typeof this.parentElement.remove === 'function') && this.parentElement.remove()" class="ml-2 hover:bg-white/20 rounded p-1 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                </button>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Debounced auto-detection on script change
        bookText.addEventListener('input', () => {
            if (!featureSettings.autoSpeaker) return;
            
            clearTimeout(autoDetectionTimeout);
            autoDetectionTimeout = setTimeout(() => {
                autoDetectSpeakers();
            }, 1500); // Wait 1.5 seconds after user stops typing
        });

        // ==================== END AUTO SPEAKER DETECTION ====================

        // ==================== LIVE AUDIO PREVIEW (Feature #3) ====================
        
        let livePreviewTimeout = null;
        let currentPreviewAudio = null;
        let isGeneratingPreview = false;
        
        // Extract last complete sentence from script
        function getLastSentence(text) {
            if (!text.trim()) return null;
            
            // Find last sentence ending with . ! ? or :
            const sentences = text.match(/[^.!?:]+[.!?:]+/g);
            if (!sentences || sentences.length === 0) {
                // No complete sentence, take last 50 words
                const words = text.trim().split(/\s+/);
                return words.slice(-50).join(' ');
            }
            
            // Get last sentence, limit to ~30 words (10 seconds audio)
            const lastSentence = sentences[sentences.length - 1].trim();
            const words = lastSentence.split(/\s+/);
            return words.slice(0, 30).join(' ');
        }
        
        // Generate live audio preview
        async function generateLivePreview() {
            if (!featureSettings.livePreview) return;
            if (isGeneratingPreview) return;
            
            const previewText = getLastSentence(bookText.value);
            if (!previewText || previewText.length < 10) return;
            
            const charCount = previewText.length;
            
            // Check credits
            if (!hasEnoughCredits(charCount)) {
                return; // Silently fail, don't annoy user
            }
            
            isGeneratingPreview = true;
            
            try {
                // Get selected API and first speaker's voice
                const selectedApi = apiSelect.value;
                const firstSpeakerRow = speakersContainer.querySelector('.speaker-row');
                const voiceId = firstSpeakerRow ? firstSpeakerRow.querySelector('.speaker-voice').value : 'alloy';
                
                // Show mini loading indicator
                showLivePreviewStatus('generating');
                
                // Generate audio based on API
                let audioUrl = null;
                
                if (selectedApi === 'openai') {
                    audioUrl = await generateOpenAIAudio(previewText, voiceId);
                } else if (selectedApi === 'gemini') {
                    audioUrl = await generateGeminiAudio(previewText, voiceId);
                } else if (selectedApi === 'elevenlabs') {
                    audioUrl = await generateElevenLabsAudio(previewText, voiceId);
                } else if (selectedApi === 'polly') {
                    audioUrl = await generatePollyAudio(previewText, voiceId);
                }
                
                if (audioUrl) {
                    // Deduct credits
                    userCredits -= charCount;
                    saveCredits();
                    updateCreditDisplay();
                    
                    // Show audio player
                    showLivePreviewPlayer(audioUrl, previewText);
                } else {
                    showLivePreviewStatus('error');
                }
                
            } catch (error) {
                console.error('Live Preview Error:', error);
                showLivePreviewStatus('error');
            } finally {
                isGeneratingPreview = false;
            }
        }
        
        // Show mini audio player with preview
        function showLivePreviewPlayer(audioUrl, text) {
            // Remove old player if exists
            const oldPlayer = document.getElementById('live-preview-player');
            if (oldPlayer) oldPlayer.remove();
            
            const t = translations[currentLang];
            const player = document.createElement('div');
            player.id = 'live-preview-player';
            player.className = 'mt-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 border-2 border-green-300 dark:border-green-700 rounded-lg shadow-lg';
            player.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center animate-pulse">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-green-700 dark:text-green-300">
                                üéß ${t.live_preview_title || 'Live-Vorschau'}
                            </span>
                            <button onclick="(function(){const el=document.getElementById('live-preview-player'); if(el && typeof el.remove==='function') el.remove();})()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-2 line-clamp-2">"${text.substring(0, 80)}..."</div>
                        <audio controls class="w-full h-8" style="outline: none;">
                            <source src="${audioUrl}" type="audio/mpeg">
                        </audio>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                            ${text.length} ${t.live_preview_chars || 'Zeichen verbraucht'}
                        </div>
                    </div>
                </div>
            `;
            
            // Insert after book-text
            bookText.parentElement.appendChild(player);
            
            // Auto-play
            const audio = player.querySelector('audio');
            if (audio) audio.play().catch(() => {}); // Ignore autoplay errors
        }
        
        // Show status message for live preview
        function showLivePreviewStatus(type) {
            const oldPlayer = document.getElementById('live-preview-player');
            if (oldPlayer && type !== 'generating') {
                oldPlayer.remove();
            }
            
            if (type === 'generating') {
                const oldStatus = document.getElementById('live-preview-status');
                if (oldStatus) return; // Already showing
                
                const t = translations[currentLang];
                const status = document.createElement('div');
                status.id = 'live-preview-status';
                status.className = 'mt-3 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-300 dark:border-blue-700 rounded-lg flex items-center gap-2 text-sm text-blue-700 dark:text-blue-300';
                status.innerHTML = `
                    <svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    ${t.live_preview_generating || 'Generiere Vorschau...'}
                `;
                bookText.parentElement.appendChild(status);
                
                setTimeout(() => status.remove(), 10000); // Auto-remove after 10s
            } else if (type === 'error') {
                document.getElementById('live-preview-status')?.remove();
            }
        }
        
        // Debounced live preview on script change
        bookText.addEventListener('input', () => {
            if (!featureSettings.livePreview) return;
            
            clearTimeout(livePreviewTimeout);
            
            // Remove status if user is still typing
            document.getElementById('live-preview-status')?.remove();
            
            livePreviewTimeout = setTimeout(() => {
                generateLivePreview();
            }, 2000); // Wait 2 seconds after user stops typing
        });
        
        // Audio generation helper functions (Browser TTS as demo)
        async function generateOpenAIAudio(text, voiceId) {
            return await generateBrowserTTS(text, voiceId);
        }
        
        async function generateGeminiAudio(text, voiceId) {
            return await generateBrowserTTS(text, voiceId);
        }
        
        async function generateElevenLabsAudio(text, voiceId) {
            return await generateBrowserTTS(text, voiceId);
        }
        
        async function generatePollyAudio(text, voiceId) {
            return await generateBrowserTTS(text, voiceId);
        }
        
        // Browser TTS fallback for demo purposes
        function generateBrowserTTS(text, voiceId) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    reject(new Error('Browser TTS not supported'));
                    return;
                }
                
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                
                // Try to find a matching voice
                const voice = voices.find(v => v.name.toLowerCase().includes(voiceId.toLowerCase())) || voices[0];
                utterance.voice = voice;
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                // Record audio using MediaRecorder
                const chunks = [];
                let mediaRecorder;
                
                try {
                    // Create a virtual audio destination
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const destination = audioContext.createMediaStreamDestination();
                    
                    // This is a simplified approach - in production you'd need a proper server-side TTS
                    // For now, we return a data URL placeholder
                    setTimeout(() => {
                        // Return a silent audio file as placeholder
                        const silentAudio = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=';
                        resolve(silentAudio);
                    }, 500);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        // ==================== END LIVE AUDIO PREVIEW ====================

        function initializeSpeakers(addDefault = true) {
            if (addDefault) {
                const t = translations[currentLang];
                speakersContainer.appendChild(addSpeakerRow(t.default_speaker_name, OPENAI_VOICES[0]));
            }
        }
        
        addSpeakerButton.addEventListener('click', () => {
             speakersContainer.appendChild(addSpeakerRow());
        });
        
        // "Alle l√∂schen" Button Handler
        const clearAllButton = document.getElementById('clear-all-speakers-button');
        if (clearAllButton) {
            clearAllButton.addEventListener('click', () => {
                const count = speakersContainer.querySelectorAll('.speaker-row').length;
                if (count === 0) return;
                
                const confirmed = confirm(`M√∂chtest du wirklich alle ${count} Person(en) l√∂schen?`);
                if (confirmed) {
                    speakersContainer.innerHTML = '';
                    onSpeakerListChange();
                }
            });
        }
        
        // ===== VORLAGEN-SYSTEM (Mehrsprachig!) =====
        document.querySelectorAll('.template-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateName = btn.getAttribute('data-template');
                const template = translations[currentLang].templates[templateName];
                
                if (!template) return;
                
                // Speichere aktives Template f√ºr Sprachwechsel
                activeTemplate = templateName;
                
                // Entferne Markierung von allen Buttons
                document.querySelectorAll('.template-btn').forEach(b => {
                    b.classList.remove('ring-4', 'ring-offset-2', 'ring-rose-500', 'dark:ring-rose-400');
                    b.style.transform = 'scale(1)';
                });
                
                // Markiere aktuellen Button dauerhaft
                btn.classList.add('ring-4', 'ring-offset-2', 'ring-rose-500', 'dark:ring-rose-400');
                btn.style.transform = 'scale(1.05)';
                
                // Leere Sprecher
                speakersContainer.innerHTML = '';
                
                // F√ºge Sprecher aus Vorlage hinzu
                template.speakers.forEach(speaker => {
                    speakersContainer.appendChild(addSpeakerRow(speaker.name, speaker.voice));
                });
                
                // Setze Skript
                setBookText(template.script, 'templateButtonClick');
                
                // Update UI
                analyzeAndHighlightScript();
                updateScriptStats();
                calculateCosts(); // Update Kosten
            });
        });
        
        // ===== FORTSCHRITTSANZEIGE (NEU!) =====
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressStatus = document.getElementById('progress-status');
        
        function showProgress(current, total, status = '') {
            progressContainer.classList.remove('hidden');
            const percent = Math.round((current / total) * 100);
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = `${percent}%`;
            progressStatus.textContent = status || `${current}/${total} Segmente`;
        }
        
        function hideProgress() {
            progressContainer.classList.add('hidden');
            progressBar.style.width = '0%';
        }
        
        async function callProxyApi(userText, speakerConfigs, api) {
            if (PROXY_SERVER_URL.includes('deinname.workers.dev')) {
                throw new Error(translations[currentLang].error_proxy_failed + " (Bitte PROXY_SERVER_URL im Code aktualisieren)");
            }
            // Respect SSML usage toggle in the UI
            const useSSML = (document.getElementById('use-ssml-checkbox') && document.getElementById('use-ssml-checkbox').checked) ? true : false;
            // Sanitize or pass through the script based on SSML toggle and provider
            const sanitizedScript = sanitizeScriptForProvider(userText, api, useSSML);
            const payload = {
                api: api,
                script: sanitizedScript,
                ssml: useSSML,
                speakers: speakerConfigs.map(s => ({
                    name: s.name,
                    voice: api === 'elevenlabs' ? ELEVENLABS_VOICE_MAP[s.voice] : s.voice
                }))
            };
            const response = await fetch(PROXY_SERVER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                let errorBody = await response.text();
                try { errorBody = (JSON.parse(errorBody)).details || errorBody; } catch (e) {}
                throw new Error(`Proxy-Fehler (${response.status}): ${errorBody}`);
            }
            return response;
        }

        function setStatus(type, message = '') {
            loader.classList.add('hidden');
            errorMessage.classList.add('hidden');
            convertButton.disabled = false;
            convertButton.classList.remove('opacity-70', 'cursor-not-allowed');
            resultArea.classList.add('hidden');
            if (type === 'loading') {
                loader.classList.remove('hidden');
                convertButton.disabled = true;
                convertButton.classList.add('opacity-70', 'cursor-not-allowed');
                buttonText.textContent = message || 'Wird erstellt...';
            } else if (type === 'error') {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                updateConvertButtonText();
            } else {
                updateConvertButtonText();
            }
        }

        convertButton.addEventListener('click', async () => {
            setStatus('clear');
            hideProgress();
            
            const scriptText = bookText.value.trim();
            const selectedApi = apiSelect.value;
            if (!scriptText) {
                return setStatus('error', translations[currentLang].error_no_script);
            }
            const speakerRows = speakersContainer.querySelectorAll('.speaker-row');
            if (speakerRows.length === 0) {
                return setStatus('error', translations[currentLang].error_no_char);
            }

            // ===== CREDIT CHECK =====
            const requiredCredits = scriptText.length;
            if (!hasEnoughCredits(requiredCredits)) {
                const shortage = requiredCredits - userCredits;
                const buyNow = confirm(
                    `‚ö†Ô∏è NICHT GENUG CREDITS!\n\n` +
                    `Ben√∂tigt: ${requiredCredits.toLocaleString('de-DE')} Zeichen\n` +
                    `Dein Guthaben: ${userCredits.toLocaleString('de-DE')} Zeichen\n` +
                    `Fehlend: ${shortage.toLocaleString('de-DE')} Zeichen\n\n` +
                    `M√∂chtest du jetzt Credits kaufen?`
                );
                
                if (buyNow) {
                    creditShopModal.classList.remove('hidden');
                }
                return;
            }

            const speakerConfigs = Array.from(speakerRows).map(row => ({
                name: row.querySelector('.speaker-name').value.trim() || 'Unbekannt',
                voice: row.querySelector('.speaker-voice').value
            }));
            
            // Berechne Anzahl Segmente f√ºr Fortschritt
            const segments = scriptText.split('\n').filter(line => line.trim() && line.includes(':')).length;
            
            setStatus('loading', `Sende Anfrage an Proxy (${selectedApi.toUpperCase()})...`);
            showProgress(0, segments, 'Vorbereitung...');
            
            try {
                // Simuliere Fortschritt w√§hrend der Generierung
                let currentSegment = 0;
                const progressInterval = setInterval(() => {
                    if (currentSegment < segments - 1) {
                        currentSegment++;
                        showProgress(currentSegment, segments, `Generiere Segment ${currentSegment}/${segments}...`);
                    }
                }, 1500); // Update alle 1.5 Sekunden
                
                const response = await callProxyApi(scriptText, speakerConfigs, selectedApi);
                
                clearInterval(progressInterval);
                showProgress(segments, segments, 'Audio wird zusammengesetzt...');
                
                const contentType = response.headers.get('Content-Type') || 'audio/mpeg';
                const audioBlob = await response.blob();
                let fileExtension = 'mp3';
                if (contentType.includes('wav') || selectedApi === 'gemini') { fileExtension = 'wav'; }
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                downloadLink.href = audioUrl;
                downloadLink.download = `hoerbuch_${Date.now()}.${fileExtension}`;
                
                // ===== CREDITS ABZIEHEN =====
                deductCredits(requiredCredits);
                
                hideProgress();
                setStatus('success');
                resultArea.classList.remove('hidden');
                audioPlayer.play();
            } catch (e) {
                console.error("Fehler beim Proxy-Aufruf:", e);
                hideProgress();
                setStatus('error', `${translations[currentLang].error_proxy_failed} Details: ${e.message}`);
            }
        });
        
        bookText.addEventListener('input', () => {
            analyzeAndHighlightScript();
            updateScriptStats();
        });
        
        bookText.addEventListener('scroll', () => {
            highlightLayer.scrollTop = bookText.scrollTop;
            highlightLayer.scrollLeft = bookText.scrollLeft;
        });

        if (!loadProject(true)) {
            initializeSpeakers();
        }
        updateUI(currentLang);
        analyzeAndHighlightScript();
        updateScriptStats();
        calculateCosts(); // Initiale Kostenberechnung
        updateCreditBalance(); // Initiale Credit-Anzeige
        // Ensure custom selects are populated after all dynamic UI updates (translations, project load)
        try {
            initializeCustomSelects();
            document.querySelectorAll('.custom-select-wrapper').forEach(w => {
                try { populateCustomSelect(w); } catch (e) {}
            });
            // Re-apply input glow to visible custom-select displays if input glow is enabled
            if (localStorage.getItem('inputGlow') !== 'off') {
                document.querySelectorAll('.custom-select-display').forEach(el => el.classList.add('input-glowing-active'));
            }
        } catch (e) { console.warn('Re-init custom selects failed', e); }

        // --- Quick recovery helper (non-destructive) ---
        // If the UI is stuck in a light theme or a full-screen backdrop is blocking
        // interaction, this will force dark mode and hide obvious full-screen
        // overlays so the user can interact again. This is intentionally
        // conservative and reversible (only modifies classes/style of top-level
        // fixed full-screen elements).
        try {
            document.addEventListener('DOMContentLoaded', () => {
                try {
                    // Force dark theme visually and persist preference
                    document.documentElement.classList.add('dark');
                    try { localStorage.setItem('theme', 'dark'); } catch(e){}
                } catch(e) { console.warn('Recovery: could not force dark theme', e); }

                try {
                    // Hide any visible full-screen backdrops that may block clicks
                    const overlays = Array.from(document.querySelectorAll('.fixed.inset-0'));
                    overlays.forEach(el => {
                        try {
                            const cs = window.getComputedStyle(el);
                            const visible = cs && cs.display !== 'none' && cs.visibility !== 'hidden' && parseFloat(cs.opacity || '1') > 0;
                            if (visible) {
                                el.classList.add('hidden');
                                el.style.display = 'none';
                                el.style.pointerEvents = 'none';
                                el.setAttribute('aria-hidden', 'true');
                            }
                        } catch (e) { /* non-fatal */ }
                    });
                } catch (e) { console.warn('Recovery: hiding overlays failed', e); }

                try {
                    // Restore pointer-events on interactive elements if accidentally disabled
                    document.querySelectorAll('button, a, input, textarea, [role="button"]').forEach(el => {
                        try { if (el.style && el.style.pointerEvents === 'none') el.style.pointerEvents = 'auto'; } catch(e){}
                    });
                } catch(e){}

                console.info('Recovery: dark theme enforced and full-screen overlays hidden.');
            });
        } catch (e) { console.warn('Recovery handler setup failed', e); }
    });
    </script>

    <!-- Credit Shop Modal -->
    <div id="credit-shop-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-rose-500 to-pink-600 p-6 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white" data-i18n="shop_modal_title">üíé Credit Shop</h2>
                        <p class="text-rose-100 mt-1" data-i18n="shop_modal_subtitle">W√§hle dein perfektes Paket</p>
                    </div>
                    <button id="close-shop-btn" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Starter Paket -->
                <div class="border-2 border-gray-200 dark:border-gray-700 rounded-xl p-6 hover:border-rose-300 dark:hover:border-rose-600 transition-all hover:shadow-lg">
                    <div class="text-4xl mb-3">üíé</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="pkg_starter">STARTER PAKET</h3>
                    <div class="text-3xl font-bold text-rose-600 dark:text-rose-400 mb-1" data-price-display data-package="starter">$3.50</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-i18n="pkg_starter_desc">10.000 Zeichen (1 Credit)</div>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_short">Perfekt f√ºr Kurzgeschichten</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_all_apis">Alle 4 APIs verf√ºgbar</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_validity">365 Tage g√ºltig</span>
                        </div>
                    </div>
                    <button class="buy-package-btn w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-900 dark:text-white font-bold py-3 rounded-lg transition-all" data-package="starter" data-credits="10000" data-price="3.50" data-i18n="btn_buy_now">
                        Jetzt kaufen
                    </button>
                </div>

                <!-- Autor Paket (Bestseller) -->
                <div class="border-2 border-rose-400 dark:border-rose-500 rounded-xl p-6 relative hover:shadow-2xl transition-all bg-gradient-to-br from-rose-50/50 to-pink-50/50 dark:from-rose-900/10 dark:to-pink-900/10">
                    <div class="absolute -top-3 -right-3 bg-gradient-to-r from-amber-400 to-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg" data-i18n="pkg_badge_bestseller">
                        ‚≠ê BESTSELLER
                    </div>
                    <div class="text-4xl mb-3">‚≠ê</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="pkg_author">AUTOR PAKET</h3>
                    <div class="text-3xl font-bold text-rose-600 dark:text-rose-400 mb-1" data-price-display data-package="author">$35.00</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 line-through">$41.90</div>
                    <div class="text-sm font-bold text-green-600 dark:text-green-400 mb-4"><span data-i18n="pkg_save">SPARE</span> 17% üéâ</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-i18n="pkg_author_desc">100.000 Zeichen (10 Credits)</div>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_novella">Perfekt f√ºr Novellen</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_premium">Premium Support</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_validity">365 Tage g√ºltig</span>
                        </div>
                    </div>
                    <button class="buy-package-btn w-full bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg" data-package="author" data-credits="100000" data-price="35.00">
                        <span data-i18n="btn_buy_now">Jetzt kaufen</span> üî•
                    </button>
                </div>

                <!-- Bestseller Paket -->
                <div class="border-2 border-purple-400 dark:border-purple-500 rounded-xl p-6 hover:shadow-xl transition-all bg-gradient-to-br from-purple-50/50 to-indigo-50/50 dark:from-purple-900/10 dark:to-indigo-900/10">
                    <div class="text-4xl mb-3">üèÜ</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="pkg_bestseller">BESTSELLER PAKET</h3>
                    <div class="text-3xl font-bold text-purple-600 dark:text-purple-400 mb-1" data-price-display data-package="bestseller">$105.00</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 line-through">$156.99</div>
                    <div class="text-sm font-bold text-green-600 dark:text-green-400 mb-4"><span data-i18n="pkg_save">SPARE</span> 33% üî•</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-i18n="pkg_bestseller_desc">300.000 Zeichen (30 Credits)</div>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_novel">Perfekt f√ºr Romane</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_priority">Priority Support</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_validity">365 Tage g√ºltig</span>
                        </div>
                    </div>
                    <button class="buy-package-btn w-full bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg" data-package="bestseller" data-credits="300000" data-price="105.00" data-i18n="btn_buy_now">
                        Jetzt kaufen
                    </button>
                </div>

                <!-- Verlags Paket (Bester Deal) -->
                <div class="border-2 border-amber-400 dark:border-amber-500 rounded-xl p-6 relative hover:shadow-2xl transition-all bg-gradient-to-br from-amber-50/50 to-yellow-50/50 dark:from-amber-900/10 dark:to-yellow-900/10">
                    <div class="absolute -top-3 -right-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg" data-i18n="pkg_badge_best_deal">
                        üëë BESTER DEAL
                    </div>
                    <div class="text-4xl mb-3">üëë</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="pkg_publisher">VERLAGS PAKET</h3>
                    <div class="text-3xl font-bold text-amber-600 dark:text-amber-400 mb-1" data-price-display data-package="publisher">$350.00</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 line-through">$697.99</div>
                    <div class="text-sm font-bold text-green-600 dark:text-green-400 mb-4"><span data-i18n="pkg_save">SPARE</span> 50% üí∞</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-i18n="pkg_publisher_desc">1.000.000 Zeichen (100 Credits)</div>
                    <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300 mb-6">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_series">Perfekt f√ºr Serien/Verlage</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_vip">VIP Support 24/7</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span class="font-bold" data-i18n="pkg_bonus">+10% BONUS Credits!</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                            <span data-i18n="pkg_feat_validity">365 Tage g√ºltig</span>
                        </div>
                    </div>
                    <button class="buy-package-btn w-full bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-600 hover:to-yellow-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg" data-package="publisher" data-credits="1000000" data-price="350.00">
                        <span data-i18n="btn_buy_now">Jetzt kaufen</span> üëë
                    </button>
                </div>
            </div>

            <div class="p-6 bg-gray-50 dark:bg-gray-800 rounded-b-2xl">
                <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                    <p class="mb-2" data-i18n="shop_footer">üîí Sichere Zahlung via Stripe ‚Ä¢ ‚è∞ Credits verfallen nach 365 Tagen</p>
                    <p data-i18n="shop_tip">üí° Tipp: Je gr√∂√üer das Paket, desto mehr sparst du!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-slate-600 to-slate-700 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white" data-i18n="settings_title">‚öôÔ∏è Einstellungen</h2>
                        <p class="text-slate-100 mt-1" data-i18n="settings_subtitle">Passe die Features nach deinen W√ºnschen an</p>
                    </div>
                    <button id="close-settings-btn" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto flex-1">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4" data-i18n="settings_features_title">Features aktivieren/deaktivieren:</h3>
                
                <div class="space-y-4">
                    <!-- Voice Preview Modal Toggle -->
                    <div class="flex items-start gap-4 p-4 border-2 border-gray-200 dark:border-slate-700 rounded-lg hover:border-purple-300 dark:hover:border-purple-600 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-1" data-i18n="setting_voice_preview">Stimmen-Vorschau-Modal</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="setting_voice_preview_desc">Zeige Modal mit allen verf√ºgbaren Stimmen zum Anh√∂ren</p>
                            <div class="mt-2 text-xs text-purple-600 dark:text-purple-400">üé≠ Feature: Stimmen testen</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" id="toggle-voice-preview" class="sr-only peer" checked>
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 dark:peer-focus:ring-purple-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                    <!-- Cost Calculator Toggle -->
                    <div class="flex items-start gap-4 p-4 border-2 border-gray-200 dark:border-slate-700 rounded-lg hover:border-blue-300 dark:hover:border-blue-600 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-1" data-i18n="setting_cost_calculator">Echtzeit-Kosten-Kalkulator</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="setting_cost_calculator_desc">Interaktiver Slider zur Projektkosten-Planung</p>
                            <div class="mt-2 text-xs text-blue-600 dark:text-blue-400">üìä Feature: Kosten planen</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" id="toggle-cost-calculator" class="sr-only peer" checked>
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Live Preview Toggle -->
                    <div class="flex items-start gap-4 p-4 border-2 border-gray-200 dark:border-slate-700 rounded-lg hover:border-green-300 dark:hover:border-green-600 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-1" data-i18n="setting_live_preview">Live Audio-Vorschau</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="setting_live_preview_desc">Automatische Vorschau w√§hrend der Eingabe (nach 2 Sek.)</p>
                            <div class="mt-2 text-xs text-green-600 dark:text-green-400">üé¨ Feature: Instant Feedback</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" id="toggle-live-preview" class="sr-only peer">
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:peer-focus:ring-green-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-green-600"></div>
                        </label>
                    </div>

                    <!-- Project Library Toggle -->
                    <div class="flex items-start gap-4 p-4 border-2 border-gray-200 dark:border-slate-700 rounded-lg hover:border-amber-300 dark:hover:border-amber-600 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-1" data-i18n="setting_project_library">Projekt-Bibliothek</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="setting_project_library_desc">Visuelle Galerie aller gespeicherten Projekte</p>
                            <div class="mt-2 text-xs text-amber-600 dark:text-amber-400">üìö Feature: Projekt-Management</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" id="toggle-project-library" class="sr-only peer" checked>
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 dark:peer-focus:ring-amber-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-amber-600"></div>
                        </label>
                    </div>

                    <!-- Auto Speaker Detection Toggle -->
                    <div class="flex items-start gap-4 p-4 border-2 border-gray-200 dark:border-slate-700 rounded-lg hover:border-rose-300 dark:hover:border-rose-600 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-1" data-i18n="setting_auto_speaker">KI-Sprecher-Erkennung</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400" data-i18n="setting_auto_speaker_desc">Automatische Sprecher-Zuordnung aus Skript</p>
                            <div class="mt-2 text-xs text-rose-600 dark:text-rose-400">ü§ñ Feature: Auto-Zuordnung</div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer flex-shrink-0">
                            <input type="checkbox" id="toggle-auto-speaker" class="sr-only peer" checked>
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-rose-300 dark:peer-focus:ring-rose-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-rose-600"></div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <button id="save-settings-btn" class="w-full bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-bold py-3 rounded-lg transition-all shadow-lg" data-i18n="btn_save_settings">
                    Einstellungen speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Project Library Modal -->
    <div id="project-library-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-purple-700 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white" data-i18n="library_title">üìö Meine H√∂rbuch-Projekte</h2>
                    </div>
                    <button id="close-library-btn" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                
                <!-- Search and Sort -->
                <div class="mt-4 flex flex-col sm:flex-row gap-3">
                    <div class="flex-1 relative">
                        <input type="text" id="library-search" class="w-full px-4 py-2 pl-10 border-2 border-white/30 rounded-lg bg-white/10 text-white placeholder-white/60 focus:bg-white/20 focus:border-white/50 transition-all" data-i18n-placeholder="library_search_placeholder">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-white/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <select id="library-sort" class="px-4 py-2 border-2 border-white/30 rounded-lg bg-white/10 text-white focus:bg-white/20 focus:border-white/50 transition-all">
                        <option value="newest" data-i18n="library_sort_newest">Neueste zuerst</option>
                        <option value="oldest" data-i18n="library_sort_oldest">√Ñlteste zuerst</option>
                        <option value="largest" data-i18n="library_sort_largest">Gr√∂√üte zuerst</option>
                        <option value="smallest" data-i18n="library_sort_smallest">Kleinste zuerst</option>
                        <option value="alphabetical" data-i18n="library_sort_alphabetical">Alphabetisch</option>
                    </select>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto flex-1">
                <div id="project-library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Projects will be rendered here -->
                </div>
                
                <!-- Empty State -->
                <div id="library-empty-state" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üìö</div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2" data-i18n="library_empty">Noch keine Projekte gespeichert</h3>
                    <p class="text-gray-600 dark:text-gray-400" data-i18n="library_empty_hint">Erstelle dein erstes H√∂rbuch und speichere es!</p>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <button id="new-project-btn" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 rounded-lg transition-all shadow-lg" data-i18n="library_btn_new">
                    + Neues Projekt erstellen
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Preview Modal -->
    <div id="voice-preview-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white" data-i18n="voice_preview_title">üé≠ Stimmen-Vorschau</h2>
                        <p class="text-indigo-100 mt-1" data-i18n="voice_preview_subtitle">H√∂re dir alle verf√ºgbaren Stimmen an</p>
                    </div>
                    <button id="close-voice-preview-btn" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto flex-1">
                <!-- API Tabs -->
                <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                    <button class="voice-api-tab active px-4 py-2 rounded-lg font-semibold transition-all" data-api="openai">
                        OpenAI TTS
                    </button>
                    <button class="voice-api-tab px-4 py-2 rounded-lg font-semibold transition-all" data-api="gemini">
                        Google Gemini
                    </button>
                    <button class="voice-api-tab px-4 py-2 rounded-lg font-semibold transition-all" data-api="elevenlabs">
                        ElevenLabs
                    </button>
                    <button class="voice-api-tab px-4 py-2 rounded-lg font-semibold transition-all" data-api="polly">
                        Amazon Polly
                    </button>
                </div>

                <!-- Voice Grids -->
                <div id="voices-container">
                    <!-- OpenAI Voices -->
                    <div class="voice-grid active" data-api="openai">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div class="voice-card bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-700 p-4 rounded-lg border-2 border-slate-200 dark:border-slate-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Alloy</h3>
                                    <span class="text-xs bg-slate-200 dark:bg-slate-600 px-2 py-1 rounded" data-i18n="voice_neutral">Neutral</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_alloy_desc">Vielseitig & ausgeglichen</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','alloy', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                            <div class="voice-card bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 p-4 rounded-lg border-2 border-blue-200 dark:border-blue-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Echo</h3>
                                    <span class="text-xs bg-blue-200 dark:bg-blue-600 px-2 py-1 rounded" data-i18n="voice_male">M√§nnlich</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_echo_desc">Klar & kraftvoll</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','echo', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                            <div class="voice-card bg-gradient-to-br from-pink-50 to-pink-100 dark:from-pink-900/30 dark:to-pink-800/30 p-4 rounded-lg border-2 border-pink-200 dark:border-pink-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Fable</h3>
                                    <span class="text-xs bg-pink-200 dark:bg-pink-600 px-2 py-1 rounded" data-i18n="voice_female">Weiblich</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_fable_desc">Warm & expressiv</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','fable', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                            <div class="voice-card bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 p-4 rounded-lg border-2 border-purple-200 dark:border-purple-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Onyx</h3>
                                    <span class="text-xs bg-purple-200 dark:bg-purple-600 px-2 py-1 rounded" data-i18n="voice_male">M√§nnlich</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_onyx_desc">Tief & markant</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','onyx', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                            <div class="voice-card bg-gradient-to-br from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/30 p-4 rounded-lg border-2 border-amber-200 dark:border-amber-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Nova</h3>
                                    <span class="text-xs bg-amber-200 dark:bg-amber-600 px-2 py-1 rounded" data-i18n="voice_female">Weiblich</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_nova_desc">Jung & energisch</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','nova', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                            <div class="voice-card bg-gradient-to-br from-rose-50 to-rose-100 dark:from-rose-900/30 dark:to-rose-800/30 p-4 rounded-lg border-2 border-rose-200 dark:border-rose-600 hover:border-indigo-400 dark:hover:border-indigo-500 transition-all">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Shimmer</h3>
                                    <span class="text-xs bg-rose-200 dark:bg-rose-600 px-2 py-1 rounded" data-i18n="voice_female">Weiblich</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" data-i18n="voice_shimmer_desc">Sanft & melodisch</p>
                                <button onclick="(typeof playVoiceSample === 'function') && playVoiceSample('openai','shimmer', this)" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-semibold transition-all flex items-center justify-center gap-2">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg>
                                    <span data-i18n="btn_play_sample">Probe h√∂ren</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Other APIs placeholder -->
                    <div class="voice-grid hidden" data-api="gemini">
                        <div class="text-center py-12">
                            <p class="text-gray-600 dark:text-gray-400" data-i18n="voice_preview_coming_soon">Gemini-Stimmen verwenden Standard-Systemstimmen</p>
                        </div>
                    </div>
                    <div class="voice-grid hidden" data-api="elevenlabs">
                        <div class="text-center py-12">
                            <p class="text-gray-600 dark:text-gray-400" data-i18n="voice_preview_api_key_required">ElevenLabs ben√∂tigt API-Key f√ºr Vorschau</p>
                        </div>
                    </div>
                    <div class="voice-grid hidden" data-api="polly">
                        <div class="text-center py-12">
                            <p class="text-gray-600 dark:text-gray-400" data-i18n="voice_preview_coming_soon">Polly-Stimmen bald verf√ºgbar</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 text-center" data-i18n="voice_preview_hint">
                    üí° Tipp: Klicke auf "Probe h√∂ren" um einen Demo-Text mit der jeweiligen Stimme zu h√∂ren
                </p>
            </div>
        </div>
    </div>

    <!-- Cost Calculator Modal -->
    <div id="cost-calculator-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-3xl font-bold text-white" data-i18n="cost_calc_title">üìä Kosten-Kalkulator</h2>
                        <p class="text-blue-100 mt-1" data-i18n="cost_calc_subtitle">Berechne die Kosten f√ºr dein H√∂rbuch-Projekt</p>
                    </div>
                    <button id="close-cost-calc-btn" class="text-white hover:bg-white/20 rounded-full p-2 transition-all">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Slider Section -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4">
                        <label class="text-lg font-semibold text-gray-900 dark:text-white" data-i18n="cost_calc_chars_label">Zeichen-Anzahl:</label>
                        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="calc-char-display">50,000</div>
                    </div>
                    
                    <input type="range" id="calc-char-slider" min="1000" max="500000" step="1000" value="50000" 
                           class="w-full h-3 bg-gradient-to-r from-blue-200 to-cyan-200 dark:from-blue-800 dark:to-cyan-800 rounded-lg appearance-none cursor-pointer slider-thumb">
                    
                    <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-2">
                        <span>1,000</span>
                        <span>500,000</span>
                    </div>
                    
                    <!-- Quick Select Buttons -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="(typeof setCalcSlider === 'function') && setCalcSlider(10000)" class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors" data-i18n="cost_calc_short">Kurzgeschichte (10k)</button>
                        <button onclick="(typeof setCalcSlider === 'function') && setCalcSlider(50000)" class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors" data-i18n="cost_calc_novella">Novelle (50k)</button>
                        <button onclick="(typeof setCalcSlider === 'function') && setCalcSlider(100000)" class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors" data-i18n="cost_calc_novel">Roman (100k)</button>
                        <button onclick="(typeof setCalcSlider === 'function') && setCalcSlider(300000)" class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors" data-i18n="cost_calc_epic">Epos (300k)</button>
                    </div>
                </div>

                <!-- Estimated Duration -->
                <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/30 dark:to-pink-900/30 rounded-lg border-2 border-purple-200 dark:border-purple-700">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <svg class="w-8 h-8 text-purple-600 dark:text-purple-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path></svg>
                            <div>
                                <div class="text-sm text-purple-700 dark:text-purple-300 font-semibold" data-i18n="cost_calc_duration">Gesch√§tzte Dauer:</div>
                                <div class="text-2xl font-bold text-purple-900 dark:text-purple-200" id="calc-duration-display">~2h 30min</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-purple-600 dark:text-purple-400" data-i18n="cost_calc_reading_speed">Lesegeschwindigkeit:</div>
                            <div class="text-sm font-semibold text-purple-700 dark:text-purple-300">~330 Zeichen/Min</div>
                        </div>
                    </div>
                </div>

                <!-- Cost Comparison Table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="border-b-2 border-gray-300 dark:border-gray-600">
                                <th class="text-left py-3 px-4 font-bold text-gray-900 dark:text-white" data-i18n="cost_calc_api">API</th>
                                <th class="text-right py-3 px-4 font-bold text-gray-900 dark:text-white" data-i18n="cost_calc_cost_usd">Kosten (USD)</th>
                                <th class="text-right py-3 px-4 font-bold text-gray-900 dark:text-white" data-i18n="cost_calc_credits">Credits</th>
                                <th class="text-right py-3 px-4 font-bold text-gray-900 dark:text-white" data-i18n="cost_calc_margin">Marge</th>
                            </tr>
                        </thead>
                        <tbody id="calc-cost-table-body">
                            <!-- Rows will be generated dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Best Deal Banner -->
                <div id="calc-best-deal" class="mt-6 p-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg shadow-lg">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                        <div class="flex-1">
                            <div class="font-bold text-lg" data-i18n="cost_calc_best_choice">üèÜ Beste Wahl:</div>
                            <div class="text-sm opacity-90" id="calc-best-deal-text">Gemini - Spart dir $XX.XX (XX% g√ºnstiger)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <p class="text-sm text-gray-600 dark:text-gray-400 text-center" data-i18n="cost_calc_hint">
                    üí° Tipp: Verwende den Slider um verschiedene Projektgr√∂√üen zu kalkulieren
                </p>
            </div>
        </div>
    </div>

    <!-- Realtime-Collab & A/B-Compare Prototypes -->
    <!-- Realtime-Collab: simple client-side hook that connects to a local relay and broadcasts editor changes -->
    <div id="realtime-collab-bar" class="fixed left-4 bottom-4 z-50 flex items-center gap-3">
        <button id="start-collab-btn" class="px-3 py-2 bg-emerald-600 text-white rounded-lg shadow-lg">Realtime-Collab starten</button>
        <button id="stop-collab-btn" class="px-3 py-2 bg-rose-500 text-white rounded-lg shadow-lg hidden">Stoppen</button>
        <div id="collab-status" class="px-3 py-2 bg-slate-50 dark:bg-slate-800 rounded-lg border border-gray-200 dark:border-slate-700 text-sm">Offline</div>
        <!-- Marketplace quick open -->
        <button id="open-marketplace-btn" class="px-3 py-2 bg-indigo-600 text-white rounded-lg shadow-lg">Marketplace</button>
    </div>

    <!-- A/B Compare Modal -->
    <div id="ab-compare-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 flex items-center justify-between bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <h3 class="text-lg font-bold">A/B Audio-Vergleich</h3>
                <button id="close-ab-btn" class="text-white/90 hover:opacity-80">Schlie√üen ‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold">Datei A (Audio) oder URL</label>
                        <input id="ab-file-a" type="file" accept="audio/*" class="mt-2 w-full">
                        <input id="ab-url-a" type="url" placeholder="oder Audio-URL einf√ºgen" class="mt-2 w-full px-3 py-2 border rounded-lg">
                        <audio id="ab-player-a" controls class="w-full mt-4"></audio>
                        <div class="mt-2 text-center">
                            <button id="rate-a" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Favorit A</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold">Datei B (Audio) oder URL</label>
                        <input id="ab-file-b" type="file" accept="audio/*" class="mt-2 w-full">
                        <input id="ab-url-b" type="url" placeholder="oder Audio-URL einf√ºgen" class="mt-2 w-full px-3 py-2 border rounded-lg">
                        <audio id="ab-player-b" controls class="w-full mt-4"></audio>
                        <div class="mt-2 text-center">
                            <button id="rate-b" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Favorit B</button>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-600">Bewertungen werden lokal im Browser gespeichert (localStorage) ‚Äî n√ºtzlich f√ºr A/B-Tests.</div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <div class="flex justify-between">
                    <button id="ab-save-rating" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">Bewertung speichern</button>
                    <button id="ab-reset-rating" class="px-4 py-2 bg-gray-300 dark:bg-slate-700 text-black dark:text-white rounded-lg">Zur√ºcksetzen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Marketplace Modal (Mock UI) -->
    <div id="marketplace-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-4 flex items-center justify-between bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                <h3 class="text-lg font-bold">Voice & Template Marketplace</h3>
                <button id="close-marketplace-btn" class="text-white/90 hover:opacity-80">Schlie√üen ‚úï</button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="mb-4 flex items-center gap-3">
                    <label class="text-sm font-semibold">Quelle:</label>
                    <select id="marketplace-source" class="px-3 py-2 rounded-lg border">
                        <option value="sample">Interner Marktplatz</option>
                        <option value="elevenlabs">ElevenLabs (Voices)</option>
                    </select>
                </div>
                <div id="marketplace-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Items rendered by JS -->
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-slate-800 border-t border-gray-200 dark:border-slate-700">
                <div class="flex justify-between items-center">
                    <div class="text-sm text-gray-600">Dies ist ein Mock-Marktplatz. Imports werden lokal gespeichert.</div>
                    <div>
                        <button id="marketplace-refresh" class="px-3 py-2 bg-indigo-600 text-white rounded-lg">Aktualisieren</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        // --- Realtime-Collab (client prototype) ---
        const WS_URL = 'ws://localhost:6789'; // lightweight relay: see proxy/socket-proxy.js in the project root
        let collabSocket = null;
        let collabConnected = false;
        let localSessionId = localStorage.getItem('hhb_collab_session') || ('s-' + Math.random().toString(36).slice(2,9));
        localStorage.setItem('hhb_collab_session', localSessionId);

        const startBtn = document.getElementById('start-collab-btn');
        const stopBtn = document.getElementById('stop-collab-btn');
        const statusEl = document.getElementById('collab-status');
        const editorEl = document.getElementById('book-text');

        function setCollabStatus(online){
            collabConnected = !!online;
            statusEl.textContent = online ? 'Verbunden' : 'Offline';
            statusEl.classList.toggle('bg-emerald-100', online);
        }

        function connectCollab(){
            if(collabSocket) collabSocket.close();
            try{
                collabSocket = new WebSocket(WS_URL);
            }catch(e){
                console.warn('Collab WS connect failed', e);
                showToast && showToast('Realtime-Collab: Verbindung fehlgeschlagen', 'error');
                return;
            }
            collabSocket.onopen = ()=>{
                setCollabStatus(true);
                startBtn.classList.add('hidden'); stopBtn.classList.remove('hidden');
                // announce
                collabSocket.send(JSON.stringify({type:'join', session: localSessionId, ts: Date.now()}));
            };
            collabSocket.onmessage = (ev)=>{
                try{
                    const msg = JSON.parse(ev.data);
                    if(msg.type === 'op' && msg.session !== localSessionId){
                        // simple last-write wins: apply remote text
                        if(editorEl && typeof editorEl.value === 'string'){
                            // apply carefully: only set if content differs
                            if(editorEl.value !== msg.text){
                                // mark stack
                                if(typeof setBookText === 'function') setBookText(msg.text, 'collab:remote');
                                else editorEl.value = msg.text;
                            }
                        }
                    }
                }catch(e){console.debug('collab msg parse', e)}
            };
            collabSocket.onclose = ()=>{ setCollabStatus(false); startBtn.classList.remove('hidden'); stopBtn.classList.add('hidden'); };
            collabSocket.onerror = (e)=>{ console.warn('collab ws error', e); };
        }

        function disconnectCollab(){ if(collabSocket) collabSocket.close(); collabSocket = null; setCollabStatus(false); }

        // broadcast local editor changes (debounced)
        let collabTimer = null;
        function scheduleBroadcast(){
            if(!collabConnected || !collabSocket) return;
            clearTimeout(collabTimer);
            collabTimer = setTimeout(()=>{
                const text = editorEl ? editorEl.value : '';
                collabSocket.send(JSON.stringify({type:'op', session: localSessionId, text, ts: Date.now()}));
            }, 250);
        }

        startBtn && startBtn.addEventListener('click', ()=>{ connectCollab(); showToast && showToast('Realtime-Collab gestartet', 'info'); });
        stopBtn && stopBtn.addEventListener('click', ()=>{ disconnectCollab(); showToast && showToast('Realtime-Collab gestoppt', 'info'); });
        if(editorEl){ editorEl.addEventListener('input', scheduleBroadcast); }

        // --- A/B Compare UI ---
        const abModal = document.getElementById('ab-compare-modal');
        const openAB = function(){ abModal.classList.remove('hidden'); };
        const closeAB = function(){ abModal.classList.add('hidden'); };
        document.getElementById('close-ab-btn').addEventListener('click', closeAB);

        // file/url loaders
        function loadFileToPlayer(fileInput, player){
            const f = fileInput.files && fileInput.files[0];
            if(!f) return;
            const url = URL.createObjectURL(f);
            player.src = url; player.load();
        }
        function loadUrlToPlayer(urlInput, player){
            const v = urlInput.value && urlInput.value.trim(); if(!v) return; player.src = v; player.load();
        }

        const fileA = document.getElementById('ab-file-a');
        const fileB = document.getElementById('ab-file-b');
        const urlA = document.getElementById('ab-url-a');
        const urlB = document.getElementById('ab-url-b');
        const playerA = document.getElementById('ab-player-a');
        const playerB = document.getElementById('ab-player-b');
        const rateA = document.getElementById('rate-a');
        const rateB = document.getElementById('rate-b');

        fileA.addEventListener('change', ()=> loadFileToPlayer(fileA, playerA));
        fileB.addEventListener('change', ()=> loadFileToPlayer(fileB, playerB));
        urlA.addEventListener('change', ()=> loadUrlToPlayer(urlA, playerA));
        urlB.addEventListener('change', ()=> loadUrlToPlayer(urlB, playerB));

        // ratings persist in localStorage under 'hhb_ab_ratings'
        function getABRatings(){ try{ return JSON.parse(localStorage.getItem('hhb_ab_ratings')||'[]'); }catch(e){return [];} }
        function saveABRating(entry){ const arr = getABRatings(); arr.push(entry); localStorage.setItem('hhb_ab_ratings', JSON.stringify(arr)); }

        rateA.addEventListener('click', ()=>{ saveABRating({choice:'A', ts:Date.now()}); showToast && showToast('A favorisiert', 'success'); });
        rateB.addEventListener('click', ()=>{ saveABRating({choice:'B', ts:Date.now()}); showToast && showToast('B favorisiert', 'success'); });
        document.getElementById('ab-save-rating').addEventListener('click', ()=>{ showToast && showToast('Bewertungen gespeichert', 'success'); closeAB(); });
        document.getElementById('ab-reset-rating').addEventListener('click', ()=>{ localStorage.removeItem('hhb_ab_ratings'); showToast && showToast('Bewertungen zur√ºckgesetzt', 'info'); });

        // Expose controls globally for quick testing
        window.hhb_openABCompare = openAB;
        window.hhb_connectCollab = connectCollab;
        window.hhb_disconnectCollab = disconnectCollab;

        // --- Marketplace Mock UI ---
        const marketplaceBtn = document.getElementById('open-marketplace-btn');
        const marketplaceModal = document.getElementById('marketplace-modal');
        const closeMarketplaceBtn = document.getElementById('close-marketplace-btn');
        const marketplaceList = document.getElementById('marketplace-list');
        const marketplaceRefresh = document.getElementById('marketplace-refresh');

        const SAMPLE_MARKETPLACE = [
            {id:'voice-alloy-pro', type:'voice', title:'Alloy Pro', author:'Studio AI', price:0, desc:'Neutral, klar ‚Äî ideal f√ºr Erz√§hler.', sampleUrl: null, meta:{provider:'openai', voice:'alloy'}},
            {id:'voice-fable-warm', type:'voice', title:'Fable Warm', author:'VoiceLab', price:2.99, desc:'Warm & expressiv - Paid sample included.', sampleUrl: null, meta:{provider:'openai', voice:'fable'}},
            {id:'template-dark-fantasy', type:'template', title:'Dark Fantasy Template', author:'TemplateStore', price:0, desc:'Scene templates for dark fantasy audiobooks.', meta:{templateVersion:1}},
            {id:'template-novel-structure', type:'template', title:'Novel Structure (3-act)', author:'ProTemplates', price:4.99, desc:'Beat-by-beat novel skeleton with chapter markers.', meta:{templateVersion:1}}
        ];

        function renderMarketplaceItems(items){
            if(!marketplaceList) return;
            marketplaceList.innerHTML = '';
            items.forEach(it => {
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-lg bg-gradient-to-br from-white to-slate-50 dark:from-slate-800 dark:to-slate-700';
                // Support both marketplace items and normalized voice objects
                const displayTitle = it.title || it.name || it.id || 'Untitled';
                const displayAuthor = it.author || it.provider || '';
                const priceLabel = (typeof it.price === 'number') ? (it.price===0? 'Gratis' : ('$'+it.price.toFixed(2))) : '';
                const desc = it.desc || it.description || (it.meta && it.meta.description) || '';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">${escapeHtml(displayTitle)}</h4>
                            <div class="text-xs text-gray-500">${escapeHtml(displayAuthor)} ${it.type? '‚Ä¢ '+it.type : ''}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-semibold">${escapeHtml(priceLabel)}</div>
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">${escapeHtml(desc)}</p>
                    <div class="mt-4 flex gap-2">
                        <button class="import-marketplace-item px-3 py-1 bg-emerald-600 text-white rounded-lg" data-id="${it.id}">Import</button>
                        <button class="preview-marketplace-item px-3 py-1 bg-indigo-600 text-white rounded-lg" data-id="${it.id}">Vorschau</button>
                    </div>
                `;
                marketplaceList.appendChild(card);
            });

            // attach handlers
            Array.from(document.getElementsByClassName('import-marketplace-item')).forEach(btn=>{
                btn.addEventListener('click', (e)=>{
                    const id = e.currentTarget.getAttribute('data-id');
                    const item = SAMPLE_MARKETPLACE.find(x=>x.id===id);
                    if(item) importMarketplaceItem(item);
                });
            });
            Array.from(document.getElementsByClassName('preview-marketplace-item')).forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                    const id = e.currentTarget.getAttribute('data-id');
                    // try to find in sample marketplace first
                    let item = SAMPLE_MARKETPLACE.find(x=>x.id===id);
                    if(item){ showMarketplacePreview(item); return; }
                    // otherwise treat as provider voice id -> call backend preview
                    try{
                        const provider = (document.getElementById('marketplace-source') && document.getElementById('marketplace-source').value) || 'elevenlabs';
                        const token = localStorage.getItem('hhb_api_token');
                        const headers = token ? {'x-api-token': token} : {};
                        const q = new URLSearchParams({ provider, voiceId: id });
                        const r = await fetch(API_BASE + '/marketplace/preview?' + q.toString(), { headers });
                        const j = await r.json();
                        if(j && j.dataUrl){
                            // play preview in a floating audio element
                            const au = new Audio(j.dataUrl);
                            au.play();
                            showToast && showToast('Vorschau wird abgespielt', 'info');
                        } else {
                            showToast && showToast('Keine Vorschau verf√ºgbar', 'info');
                        }
                    }catch(err){ console.warn('preview error', err); showToast && showToast('Vorschau fehlgeschlagen', 'error'); }
                });
            });
        }

        function importMarketplaceItem(item){
            // persist
            const saved = JSON.parse(localStorage.getItem('hhb_marketplace_imports')||'[]');
            saved.push({item, ts: Date.now()});
            localStorage.setItem('hhb_marketplace_imports', JSON.stringify(saved));

            // Try to inject into speakers UI if present
            const speakersContainer = document.getElementById('speakers-container');
            if(speakersContainer){
                const card = document.createElement('div');
                card.className = 'voice-card p-3 rounded-lg border my-2';
                card.innerHTML = `\\
                    <div class="flex justify-between items-center">\\
                        <div><strong>${escapeHtml(item.title)}</strong><div class="text-xs text-gray-500">${escapeHtml(item.author)}</div></div>\\
                        <div><button class=\\"use-imported-voice px-2 py-1 bg-indigo-600 text-white rounded\\">Verwenden</button></div>\\
                    </div>`;
                speakersContainer.appendChild(card);
                // optional hook for 'use' to map into app state
                card.querySelector('.use-imported-voice').addEventListener('click', ()=>{
                    showToast && showToast(`Importierte Stimme '${item.title}' eingef√ºgt`, 'success');
                });
            } else {
                showToast && showToast(`Import gespeichert: ${item.title}`, 'info');
            }
        }

        function showMarketplacePreview(item){
            // lightweight preview: alert or toast; for voice samples we would play sample if provided
            if(item.type === 'voice'){
                showToast && showToast(`Vorschau: ${item.title} (${item.author})`, 'info');
            } else {
                showToast && showToast(`Vorschau: ${item.title}`, 'info');
            }
        }

        function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g, function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"}[c];}); }

        marketplaceBtn && marketplaceBtn.addEventListener('click', ()=>{
            marketplaceModal.classList.remove('hidden');
            renderMarketplaceItems(SAMPLE_MARKETPLACE);
        });
        closeMarketplaceBtn && closeMarketplaceBtn.addEventListener('click', ()=> marketplaceModal.classList.add('hidden'));
        marketplaceRefresh && marketplaceRefresh.addEventListener('click', ()=> renderMarketplaceItems(SAMPLE_MARKETPLACE));

        // expose marketplace helpers for dev/testing
        window.hhb_openMarketplace = ()=>{ marketplaceModal.classList.remove('hidden'); renderMarketplaceItems(SAMPLE_MARKETPLACE); };
        
            // --- Frontend Backend Wiring / Proxy defaults ---
            // Allow a developer to set an API token in localStorage under 'hhb_api_token' for protected endpoints
            const BACKEND_BASE = (typeof window !== 'undefined' && window.location) ? (window.location.origin) : '';
            const API_BASE = BACKEND_BASE + '/api';

            // Override or define a global callProxyApi used by the app to request TTS
            window.callProxyApi = window.callProxyApi || async function(payload){
                // payload: { api, script/text, ssml, speakers }
                const token = localStorage.getItem('hhb_api_token');
                try{
                    const resp = await fetch(API_BASE + '/tts-proxy', {
                        method: 'POST',
                        headers: Object.assign({'Content-Type':'application/json'}, token ? {'x-api-token': token} : {}),
                        body: JSON.stringify(payload)
                    });
                    return await resp.json();
                }catch(e){
                    console.error('callProxyApi error', e);
                    return { ok:false, error: String(e) };
                }
            };

            // Marketplace should fetch from backend when available
            window.hhb_loadMarketplace = async function(){
                try{
                    const token = localStorage.getItem('hhb_api_token');
                    const headers = token ? {'x-api-token': token} : {};
                    const r = await fetch(API_BASE + '/marketplace', { headers });
                    const j = await r.json();
                    if(j && j.items) renderMarketplaceItems(j.items);
                }catch(e){ console.warn('marketplace fetch failed', e); }
            };

            // patch marketplace button to load remotely if backend exists
            marketplaceBtn && marketplaceBtn.addEventListener('click', ()=>{
                marketplaceModal.classList.remove('hidden');
                // set default source
                const sel = document.getElementById('marketplace-source');
                if(sel) sel.value = 'sample';
                renderMarketplaceItems(SAMPLE_MARKETPLACE);
            });
            // handle source change
            const mpSource = document.getElementById('marketplace-source');
            if(mpSource){
                mpSource.addEventListener('change', async (e)=>{
                    const val = e.target.value;
                    if(val === 'sample') return renderMarketplaceItems(SAMPLE_MARKETPLACE);
                    if(val === 'elevenlabs'){
                        // fetch from backend
                        try{
                            const token = localStorage.getItem('hhb_api_token');
                            const headers = token ? {'x-api-token': token} : {};
                            const r = await fetch(API_BASE + '/marketplace/voices?provider=elevenlabs', { headers });
                            const j = await r.json();
                            if(j && j.items) renderMarketplaceItems(j.items);
                            else showToast && showToast('Keine Stimmen gefunden', 'info');
                        }catch(err){ console.warn('marketplace voices fetch', err); showToast && showToast('Fehler beim Laden der Stimmen', 'error'); }
                    }
                });
            }
    })();
    </script>

</body>
</html>


